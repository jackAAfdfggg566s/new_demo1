ä½ é‡åˆ°çš„æƒ…å†µæ˜¯ Ansible é»˜è®¤ä¼šç¼“å­˜å‘½ä»¤è¾“å‡ºç›´åˆ°ä»»åŠ¡ç»“æŸæ‰æ˜¾ç¤ºï¼Œæ‰€ä»¥ä½ çœ‹åˆ°ï¼š

> tail çš„å†…å®¹å¡ä½ï¼Œç›´åˆ°é€€å‡ºå…³é”®å­—å‡ºç°æ—¶ï¼Œæ‰ä¸€æ¬¡æ€§è¾“å‡ºã€‚




---

âœ… ç›®æ ‡ï¼šå®ç° Ansible + GitLab CI ä¸­ tail è¾“å‡ºå®æ—¶æ˜¾ç¤ºåœ¨ç»ˆç«¯


---

ğŸ§  åŸå› ï¼šAnsible çš„ shell å’Œ command æ¨¡å—é»˜è®¤ç¼“å†² stdoutï¼Œä¸æ˜¯å®æ—¶çš„ã€‚

âœ… è§£å†³æ–¹æ¡ˆä¸€ï¼ˆæ¨èï¼‰ï¼šæ”¹ç”¨ ssh åœ¨ GitLab CI ä¸­ç›´æ¥è¿œç¨‹ tailï¼Œå®æ—¶è¾“å‡º

æœ€ç®€å•æœ‰æ•ˆçš„å®æ—¶è¾“å‡ºæ–¹æ¡ˆï¼š

tail_log_live:
  stage: monitor
  script:
    - ssh user@remote-host <<'EOF'
      a="/var/log/"
      b=$(cat /tmp/filename)
      full_path="${a}${b}"
      echo ">>> Tailing $full_path until keyword appears..."
      tail -F "$full_path" | awk '/PROCESS DONE/ { print "*** FOUND: " $0; exit } 1'
      EOF

è¿™ä¸ªæ–¹å¼åœ¨ GitLab CI ç»ˆç«¯ä¸­æ˜¯å®æ—¶åˆ·æ—¥å¿—çš„ï¼Œéå¸¸é€‚åˆè°ƒè¯•å’Œæµå¼ç›‘æ§ã€‚


---

âœ… è§£å†³æ–¹æ¡ˆäºŒï¼šå¦‚æœå¿…é¡»ç”¨ Ansibleï¼Œå¯ç”¨ async + poll: 0 + æ‰‹åŠ¨åˆ·æ–°è¾“å‡º

- name: Start tail task in background (no wait)
  shell: |
    full_path="{{ a }}{{ path_result.stdout }}"
    tail -F "$full_path" | awk '/PROCESS DONE/ { print "*** FOUND: " $0; exit } 1'
  async: 300  # æœ€å¤šè¿è¡Œ300ç§’
  poll: 0
  register: tail_job

- name: Wait for tail job to complete
  async_status:
    jid: "{{ tail_job.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: 100
  delay: 2

- name: Print tail output
  debug:
    var: job_result.stdout_lines

ğŸ” è¿™ç§æ–¹å¼ é—´æ¥å®ç°è¾“å‡ºæµåŠ¨ï¼Œä½†ç»ˆç©¶ä¸æ˜¯å®Œå…¨å®æ—¶ï¼ˆdelay: 2ï¼‰ï¼Œåªé€‚åˆè½»é‡åœºæ™¯ã€‚


---

âœ… å®æ—¶è¾“å‡ºçš„æœ€ç»ˆå»ºè®®ï¼š

æ–¹å¼	å®æ—¶æ€§	æ¨èåœºæ™¯

âœ… ssh + tail + awk	é«˜	å®æ—¶æµå¼æ—¥å¿—ç›‘æ§ âœ…
ansible async/poll	ä¸­ç­‰	å¿…é¡»ä½¿ç”¨ Ansible æ—¶å¯ç”¨
æ™®é€š shell æ¨¡å—	ä½	ä¸æ¨èç”¨äºæµå¼æ—¥å¿—



---

âœ… å®æ—¶å¢å¼ºæŠ€å·§ï¼šæ— ç¼“å­˜æ ‡å‡†è¾“å‡º

ä½ ä¹Ÿå¯ä»¥æ˜ç¡®åŠ  --line-bufferedï¼š

tail -F "$full_path" | grep --line-buffered "å…³é”®å­—"


---

æ˜¯å¦å¸Œæœ›æˆ‘å†™ä¸€ä¸ªå®Œæ•´çš„ GitLab CI + ssh + å®æ—¶ tail æ¨¡æ¿ï¼Ÿæˆ–è€…ä½ æƒ³ç»§ç»­åšæŒç”¨ Ansible çš„ç»“æ„ï¼Ÿ

