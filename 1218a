è¿™æ˜¯ GitLab Agentï¼ˆè¿æ¥ä¸åŒ EKS é›†ç¾¤ï¼‰+ å¤šç¯å¢ƒ + å¤š job åœºæ™¯é‡Œæœ€å¸¸è§ã€ä¹Ÿæœ€å®¹æ˜“å†™ä¹±çš„åœ°æ–¹ã€‚ç»™ä½ ä¸€ä¸ªå®æˆ˜å¯è½åœ°ã€ä¸é‡å¤ä»£ç çš„åšæ³•ï¼Œä»ã€Œæœ€æ¨èã€åˆ°ã€Œè¿›é˜¶ã€ã€‚


---

âœ… æœ€æ¨èæ–¹æ¡ˆï¼šç”¨ extends + å…¬å…±æ¨¡æ¿ + ç¯å¢ƒå˜é‡é©±åŠ¨

æ ¸å¿ƒæ€æƒ³ä¸€å¥è¯ï¼š

> æ‰€æœ‰ job é€»è¾‘åªå†™ä¸€æ¬¡ï¼Œé€šè¿‡å˜é‡åˆ‡æ¢ä¸åŒ EKS / Agent / kube-context




---

ä¸€ã€å®šä¹‰ä¸€ä¸ªã€Œå…¬å…± Job æ¨¡æ¿ã€

åªå†™ ä¸€æ¬¡ kubectl / helm / eks æ“ä½œé€»è¾‘

.k8s_job_template:
  image: bitnami/kubectl:latest
  stage: deploy
  variables:
    KUBE_NAMESPACE: default
  script:
    - echo "Deploy to $ENV_NAME"
    - kubectl config use-context "$KUBE_CONTEXT"
    - kubectl get ns
    - kubectl apply -f k8s/

ğŸ‘‰ è¿™é‡Œå®Œå…¨ä¸å…³å¿ƒæ˜¯å“ªä¸ª EKS


---

äºŒã€å®šä¹‰ã€Œç¯å¢ƒä¸“å±å˜é‡æ¨¡æ¿ã€

æ¯ä¸ª EKS / Agent åªå®šä¹‰ å˜é‡ï¼Œä¸å†™è„šæœ¬

ğŸŸ¦ EKS Aï¼ˆdevï¼‰

.eks_dev_vars:
  variables:
    ENV_NAME: dev
    KUBE_CONTEXT: agent:my-group/my-project:eks-dev

ğŸŸ© EKS Bï¼ˆprodï¼‰

.eks_prod_vars:
  variables:
    ENV_NAME: prod
    KUBE_CONTEXT: agent:my-group/my-project:eks-prod

> âš ï¸ agent:xxx æ˜¯ GitLab Agent æ ‡å‡†å†™æ³•




---

ä¸‰ã€çœŸæ­£çš„ Jobï¼šç»„åˆ extendsï¼ˆä¸é‡å¤ä»£ç ï¼‰

deploy_dev:
  extends:
    - .k8s_job_template
    - .eks_dev_vars
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'

deploy_prod:
  extends:
    - .k8s_job_template
    - .eks_prod_vars
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

ğŸ¯ æ•ˆæœï¼š

kubectl é€»è¾‘åªå†™ 1 æ¬¡

ç¯å¢ƒå·®å¼‚åªåœ¨ variables

ä»»æ„å¢åŠ  job éƒ½æ˜¯â€œæ‹¼ç§¯æœ¨â€



---

å››ã€å¾ˆå¤š job æ€ä¹ˆåŠï¼Ÿï¼ˆscale åˆ° 20+ jobï¼‰

ä½ å¯ä»¥è¿™æ ·ï¼š

.deploy_service:
  extends: .k8s_job_template
  script:
    - kubectl apply -f services/$SERVICE_NAME/

deploy_api_dev:
  extends:
    - .deploy_service
    - .eks_dev_vars
  variables:
    SERVICE_NAME: api

deploy_web_prod:
  extends:
    - .deploy_service
    - .eks_prod_vars
  variables:
    SERVICE_NAME: web


---

äº”ã€è¿›é˜¶ï¼šç”¨ matrix ä¸€æ¬¡ç”Ÿæˆå¤šç¯å¢ƒ jobï¼ˆå¯é€‰ï¼‰

å¦‚æœä½ çœŸçš„ job çˆ†ç‚¸ï¼š

deploy:
  extends: .k8s_job_template
  parallel:
    matrix:
      - ENV_NAME: dev
        KUBE_CONTEXT: agent:my-group/my-project:eks-dev
      - ENV_NAME: prod
        KUBE_CONTEXT: agent:my-group/my-project:eks-prod

âš ï¸ è€ƒè¯•/ç”Ÿäº§ä¸€èˆ¬è¿˜æ˜¯åˆ† job æ¯”è¾ƒå®‰å…¨


---

å…­ã€âš ï¸ å¸¸è§é”™è¯¯ï¼ˆä½ å¯èƒ½è¸©è¿‡ï¼‰

âŒ é”™è¯¯ 1ï¼šåœ¨ script é‡Œå†™ if åˆ¤æ–­ç¯å¢ƒ

ğŸ‘‰ å¯è¯»æ€§å·® + ä¸å¯ç»´æŠ¤

âŒ é”™è¯¯ 2ï¼šæ¯ä¸ª job copy kubectl

ğŸ‘‰ ç¾éš¾çº§é‡å¤

âŒ é”™è¯¯ 3ï¼šç”¨ include ä½†ä¸æŠ½å˜é‡

ğŸ‘‰ æ¢ç¯å¢ƒè¿˜æ˜¯è¦æ”¹è„šæœ¬


---

ä¸ƒã€æˆ‘å»ºè®®ä½ çš„æœ€ç»ˆç»“æ„

.gitlab-ci.yml
â”œâ”€â”€ .k8s_job_template
â”œâ”€â”€ .eks_dev_vars
â”œâ”€â”€ .eks_prod_vars
â”œâ”€â”€ deploy_api_dev
â”œâ”€â”€ deploy_api_prod
â”œâ”€â”€ deploy_web_dev
â””â”€â”€ deploy_web_prod


---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ï¼š

ğŸ”§ ç›´æ¥å¸®ä½ é‡æ„ç°æœ‰ .gitlab-ci.yml

ğŸ” é’ˆå¯¹ GitLab Agent + EKS context å†™æœ€ä½³å®è·µ

ğŸ§  å‘Šè¯‰ä½ ä»€ä¹ˆæ—¶å€™ç”¨ extendsï¼Œä»€ä¹ˆæ—¶å€™ç”¨ reference


ä½ ç°åœ¨æ˜¯ï¼š

ä¸€ä¸ª repo éƒ¨ç½²å¤šä¸ªæœåŠ¡ï¼Ÿ

è¿˜æ˜¯å¤šä¸ª repo å…±ç”¨ä¸€ä¸ª EKSï¼Ÿ


æŠŠç°æœ‰ç»“æ„è´´ä¸€å°æ®µå‡ºæ¥ï¼Œæˆ‘å¯ä»¥ç›´æ¥ç»™ä½ æ”¹ã€‚