ä½ ç°åœ¨çš„ç›®æ ‡æ˜¯ï¼š

> âœ… åœ¨ GitLab CI/CD ä¸­ï¼Œä»ç¬¬ä¸€ä¸ª stageï¼ˆæˆ– jobï¼‰ä¼ é€’å‚æ•°/å˜é‡åˆ°ç¬¬äºŒä¸ª stage/jobï¼ŒåŒ…æ‹¬å¯èƒ½çš„å»¶è¿Ÿæ‰§è¡Œï¼ˆæ¯”å¦‚ sleep 3 åˆ†é’Ÿï¼‰ã€‚




---

ğŸ”§ GitLab åŸç”Ÿä¸æ”¯æŒè·¨ job åŠ¨æ€ä¼ å€¼ï¼ˆæ¯”å¦‚ shell ä¸­ export å†ä¼ ç»™ä¸‹ä¸€ä¸ª jobï¼‰ï¼Œä½†å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹æ¡ˆå®ç°ä½ çš„ç›®æ ‡ã€‚


---

âœ… æ–¹æ³•ä¸€ï¼šä½¿ç”¨ artifact + æ–‡ä»¶ä¼ å‚ï¼ˆæœ€ç¨³å®šæ¨èï¼‰

âœ… åŸç†ï¼š

ç¬¬ä¸€ä¸ª job æŠŠå˜é‡å†™å…¥æ–‡ä»¶ä½œä¸º artifact

ç¬¬äºŒä¸ª job è¯»å– artifact æ–‡ä»¶ï¼ŒåŠ è½½å˜é‡



---

ğŸ§ª ç¤ºä¾‹ï¼š

stages:
  - prepare
  - deploy

generate_params:
  stage: prepare
  script:
    - echo "VAR_TO_PASS=abc123" > params.env
    - echo "å…¶ä»–å˜é‡å¯ä»¥ç»§ç»­è¿½åŠ " >> params.env
  artifacts:
    paths:
      - params.env

run_after_delay:
  stage: deploy
  script:
    - echo "ç­‰å¾… 3 åˆ†é’Ÿ..."
    - sleep 180
    - source params.env
    - echo "ä»æ–‡ä»¶ä¸­è¯»å–å‚æ•°ï¼š$VAR_TO_PASS"


---

âœ… æ–¹æ³•äºŒï¼šä½¿ç”¨ GitLab çš„ needs + artifacts:paths

å¦‚æœä½ ç”¨ needs: ä¿è¯ job é¡ºåºï¼Œè¿˜èƒ½åŠ å¿« pipeline å¹¶å‘è¿è¡Œæ€§èƒ½ã€‚

run_after_delay:
  stage: deploy
  needs: [generate_params]
  script:
    - sleep 180
    - source params.env
    - echo "è¯»å–ï¼š$VAR_TO_PASS"


---

âœ… æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ rules:variables + YAML anchorï¼ˆä»…é™æ€ä¼ å‚ï¼‰

é€‚ç”¨äºä½ åœ¨ CI æ–‡ä»¶ä¸­å†™æ­»å‚æ•°ï¼Œä¸èƒ½ä» job åŠ¨æ€äº§ç”Ÿçš„åœºæ™¯ï¼š

.default_vars: &default_vars
  variables:
    DEPLOY_ENV: staging
    BUILD_TAG: "v1.2"

job1:
  stage: prepare
  <<: *default_vars
  script:
    - echo "å‡†å¤‡ä»»åŠ¡ï¼Œç¯å¢ƒæ˜¯ $DEPLOY_ENV"

job2:
  stage: deploy
  <<: *default_vars
  script:
    - echo "éƒ¨ç½²ä»»åŠ¡ï¼Œç‰ˆæœ¬æ˜¯ $BUILD_TAG"

> â—æ³¨æ„ï¼šè¿™ç§æ–¹å¼æ˜¯é™æ€å˜é‡ï¼Œä¸èƒ½â€œä» job1 è¾“å‡ºå˜é‡ç»™ job2â€




---

âœ… æ–¹æ³•å››ï¼šä½¿ç”¨ GitLab CI_JOB_TOKEN + API ä¸Šä¼ åŠ¨æ€å‚æ•°ï¼ˆè¿›é˜¶ï¼‰

åœ¨ job1 ä¸­è°ƒç”¨ GitLab APIï¼Œå†™å…¥ç¯å¢ƒå˜é‡/ä¸´æ—¶å­˜å‚¨

åœ¨ job2 ä¸­è¯»å–


âš ï¸ å¤ªå¤æ‚ï¼Œä¸å»ºè®®é™¤éä½ æœ‰å¾ˆå¤šè·¨ pipeline å‚æ•°ä¼ é€’åœºæ™¯


---

âœ… æœ€ç»ˆæ¨èï¼šç®€å•ä¼ å‚çš„å®Œæ•´ç‰ˆæœ¬

stages:
  - prepare
  - deploy

job_prepare:
  stage: prepare
  script:
    - echo "TOKEN_ABC=123xyz" > vars.env
  artifacts:
    paths:
      - vars.env

job_deploy:
  stage: deploy
  needs: [job_prepare]
  script:
    - echo "ç­‰å¾… 3 åˆ†é’Ÿ..."
    - sleep 180
    - source vars.env
    - echo "æˆ‘æ‹¿åˆ°äº†å‚æ•°ï¼š$TOKEN_ABC"


---

âœ… è¡¥å……è¯´æ˜ï¼šä½ è¿˜å¯ä»¥è¿™æ ·ä½¿ç”¨å˜é‡

# vars.env æ–‡ä»¶å†…å®¹
HOST_IP=1.2.3.4
JAR_PATH=/opt/app.jar

# ç¬¬äºŒä¸ª job ä¸­ä½¿ç”¨ï¼š
source vars.env
ssh $USER@$HOST_IP "java -jar $JAR_PATH"


---

å¦‚æœä½ å‘Šè¯‰æˆ‘ä½ ä¼ çš„æ˜¯ä»€ä¹ˆå‚æ•°ï¼ˆhost åœ°å€ã€æ—¥å¿—è·¯å¾„ã€éƒ¨ç½²è·¯å¾„ç­‰ï¼‰ï¼Œæˆ‘å¯ä»¥å¸®ä½ ä¼˜åŒ–å˜é‡æ–‡ä»¶ç»“æ„ï¼Œæ¯”å¦‚ç”Ÿæˆ .env æˆ– JSONã€‚è¦ä¸è¦ï¼Ÿ

