è¿™æ˜¯ä¸ªå…¸å‹ã€è€Œä¸”ä½ è¿™ä¸ªé˜¶æ®µä¸€å®šä¼šé‡åˆ°çš„é—®é¢˜ ğŸ‘
æ ¸å¿ƒçŸ›ç›¾ä½ å·²ç»ç‚¹å‡ºæ¥äº†ï¼š
FIS template é‡Œçš„ targetï¼ˆinstanceIdsï¼‰æ˜¯â€œé™æ€â€çš„ï¼Œä½† AZ ä¸‹çš„ node / EC2 æ•°é‡æ˜¯â€œåŠ¨æ€å˜åŒ–â€çš„
ä¸‹é¢æˆ‘ç›´æ¥ç»™ä½ å¯è½åœ°çš„æ ‡å‡†è§£æ³•ï¼Œä»¥åŠä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšã€‚
ä¸€ã€ç»“è®ºå…ˆè¡Œï¼ˆæœ€é‡è¦çš„ï¼‰
ğŸ‘‰ FIS Template æœ¬èº«ä¸æ”¯æŒâ€œåŠ¨æ€å‘ç°å®ä¾‹â€
ğŸ‘‰ æ­£ç¡®åšæ³•æ˜¯ï¼š
ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼Œåœ¨æ‰§è¡Œå‰åŠ¨æ€ç”Ÿæˆ / æ›´æ–° FIS experiment template JSON
ä¹Ÿå°±æ˜¯è¯´ï¼š
å¤åˆ¶ä»£ç 

æ¯æ¬¡æ¼”ç»ƒå‰
â†“
è„šæœ¬å®æ—¶å‘ç° AZ ä¸‹æ‰€æœ‰ EKS nodeï¼ˆEC2ï¼‰
â†“
ç”Ÿæˆ / æ›´æ–° FIS template
â†“
start-experiment
äºŒã€æ•´ä½“è®¾è®¡ï¼ˆæ¨èæ¶æ„ï¼‰
å¤åˆ¶ä»£ç 
Text
AZ
 â†“
kubectl â†’ æ‰¾ Node
 â†“
Node â†’ providerID â†’ EC2 InstanceId
 â†“
ç”Ÿæˆ FIS template JSONï¼ˆinstanceIdsï¼‰
 â†“
aws fis create-experiment-template
 or
aws fis update-experiment-template
 â†“
aws fis start-experiment
ä¸‰ã€å…³é”®ç‚¹ 1ï¼šä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ç”¨ ASG / tagï¼Ÿ
ä½ å¯èƒ½æƒ³è¿‡è¿™äº›æ–¹æ¡ˆï¼š
âŒ ç›´æ¥ terminate ASG
ä¼šå½±å“å¤šä¸ª AZ
ä¸ç²¾ç¡®
âŒ FIS target ç”¨ tag
aws:ec2:instance ä¸æ”¯æŒ AZ æ¡ä»¶
åªèƒ½ tag / resource-id
âœ… å”¯ä¸€ç²¾ç¡®çš„æ–¹æ³•
è„šæœ¬ç®—å‡º instanceIds
å››ã€æ ¸å¿ƒè„šæœ¬ç¤ºä¾‹ï¼ˆAZ â†’ EC2 instanceIdsï¼‰
ä¸‹é¢æ˜¯ä¸€ä¸ªçœŸå®å¯ç”¨çš„ Bash æ€è·¯ï¼ˆä½ å¯ä»¥æ”¾åœ¨ CI / Lambda é‡Œï¼‰
1ï¸âƒ£ åŸºäº AZ æ‰¾ Node â†’ EC2
å¤åˆ¶ä»£ç 
Bash
CLUSTER_NAME=my-eks
AZ=ap-southeast-2a

INSTANCE_IDS=$(kubectl get nodes \
  -l topology.kubernetes.io/zone=${AZ} \
  -o jsonpath='{range .items[*]}{.spec.providerID}{"\n"}{end}' \
  | awk -F/ '{print $NF}')
æ­¤æ—¶ï¼š
å¤åˆ¶ä»£ç 
Text
i-01xxxx
i-02xxxx
i-03xxxx
2ï¸âƒ£ åŠ¨æ€ç”Ÿæˆ FIS target JSON
å¤åˆ¶ä»£ç 
Bash
cat > targets.json <<EOF
{
  "Targets": {
    "EksNodesInAz": {
      "ResourceType": "aws:ec2:instance",
      "ResourceArns": [],
      "ResourceTags": {},
      "Filters": [],
      "SelectionMode": "ALL",
      "ResourceIds": [
$(echo "$INSTANCE_IDS" | sed 's/.*/"&",/' | sed '$ s/,$//')
      ]
    }
  }
}
EOF
ğŸ‘‰ è¿™é‡Œçš„å…³é”®ç‚¹
SelectionMode: ALL
ResourceIds æ˜¯å®æ—¶ç”Ÿæˆçš„
äº”ã€å®Œæ•´ FIS Templateï¼ˆTerminate EC2ï¼‰
ä¸‹é¢æ˜¯ä¸€ä¸ªæœ€å°ä½†å®Œæ•´çš„ FIS experiment template ç»“æ„ï¼ˆä½ æ¯æ¬¡è„šæœ¬ç”Ÿæˆï¼‰
å¤åˆ¶ä»£ç 
Json
{
  "description": "Terminate all EKS nodes in ap-southeast-2a",
  "roleArn": "arn:aws:iam::123456789012:role/FISRole",
  "targets": {
    "EksNodesInAz": {
      "resourceType": "aws:ec2:instance",
      "resourceIds": [
        "i-01xxxx",
        "i-02xxxx"
      ],
      "selectionMode": "ALL"
    }
  },
  "actions": {
    "TerminateNodes": {
      "actionId": "aws:ec2:terminate-instances",
      "parameters": {},
      "targets": {
        "Instances": "EksNodesInAz"
      }
    }
  },
  "stopConditions": [
    {
      "source": "none"
    }
  ]
}
å…­ã€Template æ˜¯ create è¿˜æ˜¯ updateï¼Ÿ
æ¨èåšæ³•ï¼ˆç”Ÿäº§å¸¸ç”¨ï¼‰
åœºæ™¯
å»ºè®®
AZ æ•°é‡å›ºå®š
1 ä¸ª template / AZ
node æ•°é‡å˜åŒ–
æ¯æ¬¡ update template
å¹¶å‘æ¼”ç»ƒ
template åå›ºå®šï¼Œexperiment ä¸åŒ
å¤åˆ¶ä»£ç 
Bash
aws fis update-experiment-template \
  --id <template-id> \
  --cli-input-json file://template.json
ä¸ƒã€è¿›é˜¶ä¼˜åŒ–ï¼ˆä½ ä¸€å®šä¼šç”¨ä¸Šï¼‰
1ï¸âƒ£ é˜²æ­¢å…¨ç­ï¼ˆæ¯”å¦‚åªæ€ 70%ï¼‰
å¤åˆ¶ä»£ç 
Json
"selectionMode": "PERCENT(70)"
âš ï¸ ä»ç„¶æ˜¯ åŸºäº ResourceIds çš„å­é›†
2ï¸âƒ£ åª kill workerï¼Œä¸åŠ¨ system node
å¤åˆ¶ä»£ç 
Bash
kubectl get nodes \
  -l topology.kubernetes.io/zone=${AZ} \
  -l '!node-role.kubernetes.io/control-plane'
3ï¸âƒ£ å¹²è·‘ï¼ˆDry runï¼‰æ ¡éªŒ
å¤åˆ¶ä»£ç 
Bash
aws fis start-experiment \
  --experiment-template-id xxx \
  --dry-run
å…«ã€ä½ è¿™ä¸ªé—®é¢˜çš„â€œæ ‡å‡†ç­”æ¡ˆä¸€å¥è¯ç‰ˆâ€
FIS ä¸èƒ½åŠ¨æ€æ„ŸçŸ¥ AZ ä¸‹çš„ EC2 æ•°é‡ï¼Œå¿…é¡»é€šè¿‡è„šæœ¬åœ¨æ‰§è¡Œå‰å®æ—¶å‘ç° node / EC2ï¼Œå¹¶åŠ¨æ€ç”Ÿæˆæˆ–æ›´æ–° FIS template JSONã€‚
å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ åšä¸€ä¸ª å®Œæ•´å¯å¤ç”¨è„šæœ¬ï¼š
az å‚æ•°
è‡ªåŠ¨è¿‡æ»¤ system node
è‡ªåŠ¨ update template
è‡ªåŠ¨ start experiment
å¸¦å®‰å…¨é˜ˆå€¼ï¼ˆæœ€å¤š kill N ä¸ªï¼‰
è¿™ä¸ªå·²ç»æ˜¯ä¼ä¸šçº§ AZ æ•…éšœæ¼”ç»ƒæ¨¡æ¿äº†ã€‚