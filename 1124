æ˜ç™½äº†ï¼Œä½ è¯´çš„ä¸æ˜¯ extendsï¼Œè€Œæ˜¯ GitLab CI çš„ YAML referenceï¼š!reference
ä¾‹å¦‚ï¼š

script:
  - !reference [.deploy_common, script]

ä½ æƒ³åšåˆ°ï¼š

ç”¨æˆ·è¾“å…¥ variableï¼ˆä¾‹å¦‚ ENV=dev/test/prodï¼‰

pipeline æ ¹æ® variable åŠ¨æ€è°ƒç”¨ä¸åŒçš„ reference


ä¹Ÿå°±æ˜¯ä½ æƒ³è¿™æ ·ï¼ˆä½† GitLab ä¸æ”¯æŒï¼‰ï¼š

script:
  - !reference [.$ENV_template, script]

ğŸ‘‰ GitLab YAML è§£ææ˜¯é™æ€çš„ï¼Œä¸æ”¯æŒåœ¨ !reference é‡Œä½¿ç”¨å˜é‡åŠ¨æ€æ‹¼æ¥ keyã€‚
ğŸ‘‰ æ‰€ä»¥ä¸èƒ½æ ¹æ® ENV åŠ¨æ€é€‰æ‹©ä¸åŒ referenceã€‚

ä½†æ˜¯â€”â€”æˆ‘å¯ä»¥å‘Šè¯‰ä½ å¯è¡Œçš„æ–¹å¼ï¼Œè®©ä½ æ ¹æ® variable è°ƒç”¨ä¸åŒè„šæœ¬æ®µï¼Œè¡Œä¸ºå‡ ä¹ç­‰åŒäºåŠ¨æ€ referenceã€‚


---

âœ… æ­£ç¡®åšæ³•ï¼šä¸€ä¸ª job å†…ç”¨å¤šä¸ª reference + rules:exists é€‰æ‹©

GitLab æ”¯æŒï¼š

åœ¨åŒä¸€ä¸ª job å†…å†™å¤šä¸ª !reference

ç”¨ rules + when: never è®©ä¸åŒ¹é…çš„ block ä¸è§¦å‘



---

â­ æ–¹æ¡ˆ Aï¼ˆå®˜æ–¹æ¨èï¼‰ï¼šå¤šä¸ª id + rules æ¥é€‰æ‹© referenceï¼ˆå¯è¿è¡Œï¼‰

1. å®šä¹‰ä¸‰ä¸ª referenceï¼ˆå…¬å…±ç‰‡æ®µï¼‰

.deploy_dev:
  script:
    - echo "DEV deploy"
    - ./deploy_dev.sh

.deploy_test:
  script:
    - echo "TEST deploy"
    - ./deploy_test.sh

.deploy_prod:
  script:
    - echo "PROD deploy"
    - ./deploy_prod.sh


---

2. ä¸€ä¸ª jobï¼Œæ ¹æ® ENV é€‰æ‹©ä¸åŒ reference

deploy:
  stage: deploy
  rules:
    - if: '$ENV == "dev"'  # åªåœ¨ dev æ—¶åŠ è½½ dev reference
      script:
        - !reference [.deploy_dev, script]

    - if: '$ENV == "test"'
      script:
        - !reference [.deploy_test, script]

    - if: '$ENV == "prod"'
      script:
        - !reference [.deploy_prod, script]


---

â­ è¿™æ˜¯ GitLab å®˜æ–¹å…è®¸çš„â€œå¤š reference å¤š rulesâ€ç»„åˆ

ç”¨æˆ·è¾“å…¥ ENVï¼š

ENV=dev

pipeline æ‰§è¡Œï¼š

script:
  - echo "DEV deploy"
  - ./deploy_dev.sh

å…¶ä»– test / prod çš„ reference ä¸æ‰§è¡Œï¼Œå› ä¸º rules ä¸åŒ¹é…ã€‚


---

ğŸ¯ è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹

ä½¿ç”¨ çœŸæ­£çš„ !referenceï¼ˆæ»¡è¶³ä½ çš„éœ€æ±‚ï¼‰

æ ¹æ® variable è‡ªåŠ¨é€‰æ‹©å¯¹åº” reference

ä¸éœ€è¦ extends

YAML éå¸¸å¹²å‡€

GitLab å®˜æ–¹å…è®¸å¹¶æ¨èï¼ˆrules + !reference ç»„åˆï¼‰



---

ğŸ”¥ æ–¹æ¡ˆ Bï¼ˆæ›´é«˜çº§ï¼‰ï¼šæŠŠ reference åšæˆæ•°ç»„ + æ¡ä»¶åˆå¹¶

ä¹Ÿå¯å®ç°ï¼Œæˆ‘ä¹Ÿå¯ä»¥å†™ï¼Œä½†ä¸€èˆ¬æ–¹æ¡ˆ A å·²ç»å¤Ÿç”¨äº†ã€‚


---

ğŸ“Œ å¦‚æœä½ æ„¿æ„ï¼ŒæŠŠä½ å½“å‰çš„ .gitlab-ci.yml å’Œ reference ç»“æ„å‘æˆ‘ï¼Œæˆ‘å¯ä»¥ç›´æ¥å¸®ä½ æ”¹æˆï¼š

ä¸ç”¨é‡å¤ä»£ç 

ç”¨æˆ·å¡« ENV è‡ªåŠ¨é€‰ reference

100% å¯è¿è¡Œï¼Œæ— é”™è¯¯


éšæ—¶å‘ï¼Œæˆ‘å¸®ä½ é‡æ„ã€‚