ä½ æƒ³åšåˆ°çš„æ˜¯ï¼š
åŒä¸€ä¸ª jobï¼ˆæˆ–æ¨¡æ¿ï¼‰ç”¨ extendsï¼Œä½†æ ¹æ® variable çš„ä¸åŒï¼Œç»§æ‰¿ä¸åŒçš„æ¨¡æ¿ã€‚

âš ï¸ GitLab CI è¯­æ³•ä¸­ extends: æœ¬èº«ä¸èƒ½å†™ if/elseï¼Œä¹Ÿä¸èƒ½åŠ¨æ€é€‰æ‹©å­—ç¬¦ä¸²ã€‚
ä½†å¯ä»¥å€ŸåŠ© rules:extends çš„å†™æ³•ï¼Œå®ç°â€œæ ¹æ® variable é€‰æ‹©ä¸åŒçš„ extendsâ€ã€‚

ä¸‹é¢ç»™ä½ æœ€æ¸…æ™°ã€æœ€å®ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚


---

âœ… æ–¹å¼ 1ï¼šç”¨ rules:extendsï¼ˆå®˜æ–¹æ”¯æŒï¼Œæœ€ç®€æ´ï¼‰

GitLab 14.0+ æ”¯æŒ rules:extendsï¼Œå¯ä»¥æ ¹æ®æ¡ä»¶å†³å®šç»§æ‰¿å“ªä¸ªæ¨¡æ¿ã€‚

âœ” ç¤ºä¾‹

.base_dev:
  script:
    - echo "run dev"

.base_prod:
  script:
    - echo "run prod"

job:
  rules:
    - if: '$TARGET == "dev"'
      extends: .base_dev
    - if: '$TARGET == "prod"'
      extends: .base_prod
    - when: never

è¿è¡Œï¼š

TARGET=dev       â†’ ç»§æ‰¿ .base_dev
TARGET=prod      â†’ ç»§æ‰¿ .base_prod

ğŸŒŸ è¿™æ˜¯å”¯ä¸€å¯ä»¥çœŸæ­£â€œæ ¹æ®å˜é‡é€‰æ‹©ä¸åŒ extendsâ€çš„æ–¹å¼ã€‚


---

âœ… æ–¹å¼ 2ï¼šå¤šä¸ª jobï¼Œrules æ§åˆ¶å“ªä¸ª job è§¦å‘

å¦‚æœä½ ä¸èƒ½ç”¨ rules:extendsï¼Œä½ å¯ä»¥æŠŠ job æ‹†æˆå¤šä¸ªï¼ŒåŒåé€»è¾‘ï¼Œä¸åŒæ¨¡æ¿ï¼š

job_dev:
  extends: .base_dev
  rules:
    - if: '$TARGET == "dev"'

job_prod:
  extends: .base_prod
  rules:
    - if: '$TARGET == "prod"'

ä¼˜ç‚¹ï¼šç®€å•æ¸…æ™°
ç¼ºç‚¹ï¼šç”Ÿæˆå¤šä¸ª job


---

âœ… æ–¹å¼ 3ï¼šä½¿ç”¨ include åŠ¨æ€é€‰æ‹©æ¨¡æ¿ï¼ˆé€‚åˆå¤§é¡¹ç›®ï¼‰

ä¸» pipeline æ ¹æ®å˜é‡ include ä¸åŒæ–‡ä»¶ï¼š

main.gitlab-ci.yml

include:
  - local: "templates/${TARGET}.yml"

æ¨¡æ¿æ–‡ä»¶ï¼š

templates/dev.yml

job:
  extends: .base_dev

templates/prod.yml

job:
  extends: .base_prod

é€‚åˆå¤æ‚ pipelineã€‚


---

ğŸ”¥ æœ€æ¨èï¼ˆä½ åº”è¯¥ç”¨è¿™ä¸ªï¼‰

å¦‚æœä½ åªæ˜¯ï¼š

> æƒ³ç”¨ä¸€ä¸ª jobï¼Œç„¶åæ ¹æ® variable é€‰æ‹©ä¸åŒçš„æ¨¡æ¿



â¡ï¸ ç”¨ rules:extends æœ€å¥½ï¼š

job:
  rules:
    - if: '$TARGET == "dev"'
      extends: .base_dev
    - if: '$TARGET == "prod"'
      extends: .base_prod
    - when: never


---

å¦‚æœä½ æ„¿æ„

æŠŠä½ ç°åœ¨çš„ .gitlab-ci.yml è´´ç»™æˆ‘ï¼Œæˆ‘å¯ä»¥ç›´æ¥å¸®ä½ å†™å‡ºï¼š

æœ€ç®€ç‰ˆæœ¬

æŒ‰ä½ çš„ variable è‡ªåŠ¨åˆ‡æ¢ extends

é¿å… command not found

é¿å…é‡å¤ä»£ç 


ä½ ä¹‹å‰é‡åˆ°çš„ reference command not found æˆ‘ä¹Ÿèƒ½ä¸€èµ·å¸®ä½ ä¿®ã€‚