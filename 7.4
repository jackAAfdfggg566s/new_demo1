ä½ æœ‰ 4 å°æœºå™¨ï¼Œéœ€è¦é€šè¿‡ GitLab CI/CD å®ç°ï¼š

> âœ… ä¾æ¬¡ï¼ˆæˆ–å¹¶å‘ï¼‰å¯åŠ¨ Java ç¨‹åº â†’ ç­‰ 1 åˆ†é’Ÿ â†’ å†æ‰§è¡Œå¦ä¸€æ­¥æ“ä½œï¼ˆå¯èƒ½æ˜¯æ—¥å¿—ç›‘æ§/éªŒè¯ç­‰ï¼‰



ç›®æ ‡æ˜¯ï¼šæ¯å°æœºå™¨åˆ†æ­¥éª¤è¿è¡Œï¼Œå¹¶ä¸”å‚æ•°å¯æ§ã€æµç¨‹è‡ªåŠ¨åŒ–


---

âœ… ç›®æ ‡ç»“æ„ç®€åŒ–ï¼š

å‡è®¾æœºå™¨æ˜¯ï¼š

host1.example.com

host2.example.com

host3.example.com

host4.example.com


Java å¯åŠ¨å‘½ä»¤å‡è®¾æ˜¯ï¼š

ssh user@hostX "java -jar /opt/app.jar"

ç­‰å¾… 1 åˆ†é’Ÿåï¼Œå†æ‰§è¡Œï¼š

ssh user@hostX "tail -f /opt/app.log"


---

âœ… æ¨èå®ç°æ–¹å¼ï¼ˆå‚æ•°åŒ– + æ§åˆ¶é¡ºåºï¼‰

âœ… ä½¿ç”¨ GitLab CI job + å‚æ•°å˜é‡ + sleep æ§åˆ¶


---

ğŸ§© ç¤ºä¾‹ .gitlab-ci.yml

stages:
  - start
  - wait_and_check

# å¯åŠ¨ Java ç¨‹åº
start_java:
  stage: start
  script:
    - echo "å¯åŠ¨ Java ç¨‹åºåœ¨ $TARGET_HOST"
    - ssh user@$TARGET_HOST "nohup java -jar /opt/app.jar > /opt/app.log 2>&1 &"
  variables:
    TARGET_HOST: ""

# ç­‰å¾… 1 åˆ†é’ŸåæŸ¥çœ‹æ—¥å¿—
check_java_log:
  stage: wait_and_check
  needs: [start_java]
  script:
    - echo "ç­‰å¾… 1 åˆ†é’Ÿ..."
    - sleep 60
    - echo "è¿æ¥ $TARGET_HOSTï¼Œå¼€å§‹æŸ¥çœ‹æ—¥å¿—ï¼š"
    - ssh user@$TARGET_HOST "tail -n 20 /opt/app.log"
  variables:
    TARGET_HOST: ""


---

âœ… å¯åŠ¨å¤šä¸ªæœºå™¨ï¼šä½¿ç”¨ åŠ¨æ€å˜é‡å¯åŠ¨å¤šæ¡ pipeline

ä½ å¯ä»¥é€šè¿‡ æ‰‹åŠ¨è§¦å‘ + å˜é‡ä¼ å‚ çš„æ–¹å¼è¿è¡Œå¤šä¸ª pipelineï¼Œä¾‹å¦‚ï¼š

æ‰‹åŠ¨è¾“å…¥ï¼š

TARGET_HOST=host1.example.com

TARGET_HOST=host2.example.com



---

âœ… æˆ–è€…åˆ†æˆå¤šä¸ª job å¹¶è¡Œæ§åˆ¶

start_java_host1:
  stage: start
  script:
    - ssh user@host1 "nohup java -jar /opt/app.jar > /opt/app.log 2>&1 &"

check_log_host1:
  stage: wait_and_check
  needs: [start_java_host1]
  script:
    - sleep 60
    - ssh user@host1 "tail -n 20 /opt/app.log"

é‡å¤å†™ host2 ~ host4 å³å¯ã€‚


---

âœ… æ›´æ™ºèƒ½åšæ³•ï¼šä½¿ç”¨æ¨¡æ¿ + extends å¤ç”¨é€»è¾‘

å¦‚æœä½ ä¸æƒ³å¤åˆ¶ä»£ç ï¼Œå¯ä»¥å®šä¹‰æ¨¡æ¿ jobï¼š

.start-template:
  script:
    - ssh user@$TARGET_HOST "nohup java -jar /opt/app.jar > /opt/app.log 2>&1 &"

.check-template:
  script:
    - sleep 60
    - ssh user@$TARGET_HOST "tail -n 20 /opt/app.log"

ç„¶åè¿™æ ·ä½¿ç”¨ï¼š

start_host1:
  stage: start
  extends: .start-template
  variables:
    TARGET_HOST: host1.example.com

check_host1:
  stage: wait_and_check
  extends: .check-template
  needs: [start_host1]
  variables:
    TARGET_HOST: host1.example.com


---

âœ… æ€»ç»“æ–¹æ¡ˆå¯¹æ¯”

å®ç°æ–¹å¼	ä¼˜ç‚¹	ç¼ºç‚¹

job + å‚æ•°å˜é‡	çµæ´»ã€å¯é‡å¤	éœ€è¦æ‰‹åŠ¨è§¦å‘æ¯ä¸ª
å¤š job é™æ€å†™æ­» host1~host4	ç®€å•ç›´è§‚	ä¸çµæ´»ï¼Œä»£ç å¤š
æ¨¡æ¿ + extends	æ˜“ç»´æŠ¤ã€ç»Ÿä¸€æ”¹åŠ¨	é…ç½®ç¨å¤æ‚
GitLab trigger + å­ pipeline	é€‚åˆæ›´å¤§è§„æ¨¡ç³»ç»Ÿ	é…ç½®æœ€å¤æ‚



---

éœ€è¦æˆ‘ç›´æ¥ç»™ä½ ä¸€ä»½å®Œæ•´æ”¯æŒ 4 å°ä¸»æœºã€æ¨¡æ¿å¤ç”¨ã€å¹¶æ”¯æŒå¹¶å‘/é¡ºåºæ‰§è¡Œçš„ GitLab CI æ–‡ä»¶å—ï¼Ÿæˆ‘å¯ä»¥å¿«é€Ÿç”Ÿæˆã€‚

