ğŸ‘Œ æ˜ç™½äº†â€”â€”éå¸¸å…³é”®çš„ä¸€ç‚¹ï¼š

> ä½ åœ¨ GitLab Pipeline ä¸­ä½¿ç”¨ sshpass + ssh ç™»å½•è¿œç¨‹æœåŠ¡å™¨ï¼Œ
ä½†æ˜¯ $MY_PASSWORD ä¸æ˜¯ SSH ç™»å½•å¯†ç ï¼Œ
è€Œæ˜¯æƒ³ä¼ ç»™è¿œç¨‹è„šæœ¬ä¸­ä½¿ç”¨çš„â€œåˆ«çš„ä¸šåŠ¡å¯†ç â€ï¼ˆä¾‹å¦‚æ•°æ®åº“å¯†ç ã€éƒ¨ç½²å¯†ç ç­‰ï¼‰ã€‚




---

æˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°ã€æ­£ç¡®åœ°æŠŠè¿™ä¸ª GitLab å˜é‡ä¼ ç»™è¿œç¨‹ä¸»æœºæ‰§è¡Œçš„è„šæœ¬ğŸ‘‡


---

âœ… ä¸€ã€æ ¸å¿ƒæ€è·¯

SSH ç™»å½•ç”¨çš„æ˜¯å›ºå®šè´¦æˆ·ï¼ˆå¯èƒ½ç”¨å…¬é’¥ç™»å½•ï¼‰ï¼Œ
è€Œ $MY_PASSWORD æ˜¯ GitLab å˜é‡ä¸­çš„æ•æ„Ÿå€¼ï¼Œ
ä½ è¦æŠŠå®ƒä¼ å…¥è¿œç«¯è„šæœ¬é‡Œä½œä¸ºç¯å¢ƒå˜é‡æˆ–å‚æ•°ã€‚

> ğŸ‘‰ GitLab Runner é‡Œ $MY_PASSWORD å­˜åœ¨ï¼Œ
ä½†è¿œç«¯æœºå™¨æ˜¯å…¨æ–°çš„ shellï¼Œéœ€è¦ä½ ä¸»åŠ¨ä¼ è¿›å»ã€‚




---

âœ… äºŒã€å®‰å…¨æ¨èæ–¹å¼ï¼šç¯å¢ƒå˜é‡ä¼ é€’ï¼ˆä¸å‡ºç°åœ¨å‘½ä»¤è¡Œï¼‰

åœ¨ .gitlab-ci.yml é‡Œå†™ï¼š

deploy_job:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh sshpass
  script:
    # ç”¨ ssh ç™»å½•è¿œç«¯å¹¶æ³¨å…¥ GitLab å˜é‡
    - |
      sshpass -p "$SSH_LOGIN_PASS" ssh -o StrictHostKeyChecking=no user@remote_host \
      "MY_PASSWORD='$MY_PASSWORD' bash -s" < scripts/deploy.sh


---

ğŸ§© deploy.shï¼ˆè¿œç«¯æ‰§è¡Œçš„è„šæœ¬ï¼‰

#!/bin/bash
echo "è¿œç«¯æ”¶åˆ°çš„ä¸šåŠ¡å¯†ç : $MY_PASSWORD"
# ä¸¾ä¾‹ï¼šç”¨äºéƒ¨ç½²æˆ–è¿æ¥æ•°æ®åº“
some_command --password "$MY_PASSWORD"

ğŸ“Œ ä¼˜ç‚¹ï¼š

å¯†ç ä¸ä¼šå‡ºç°åœ¨å‘½ä»¤è¡Œå‚æ•°ä¸­ï¼›

æ—¥å¿—ä¸­è¢« GitLab Maskï¼›

ä¸éœ€è¦ä¸´æ—¶æ–‡ä»¶ï¼›

ä¸ä¾èµ– AcceptEnvã€‚



---

âœ… ä¸‰ã€å¦‚æœè„šæœ¬å·²ç»åœ¨è¿œç«¯ï¼ˆæ¯”å¦‚ä½  scp ä¸Šå»äº†ï¼‰

ä½ ä¹Ÿå¯ä»¥è¿™æ ·æ‰§è¡Œï¼š

script:
  - sshpass -p "$SSH_LOGIN_PASS" ssh -o StrictHostKeyChecking=no user@remote_host \
      "MY_PASSWORD='$MY_PASSWORD' bash /path/to/deploy.sh"

ä¸€æ ·æ•ˆæœï¼š
$MY_PASSWORD åœ¨è¿œç«¯è„šæœ¬é‡Œå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ç¯å¢ƒå˜é‡ã€‚


---

âœ… å››ã€å¦‚æœä½ æƒ³ä¼ å¤šä¸ªå˜é‡

script:
  - sshpass -p "$SSH_LOGIN_PASS" ssh -o StrictHostKeyChecking=no user@remote_host \
      "DB_PASS='$DB_PASS' API_TOKEN='$API_TOKEN' bash -s" < scripts/deploy.sh

è¿œç«¯è„šæœ¬ï¼š

#!/bin/bash
echo "æ•°æ®åº“å¯†ç : $DB_PASS"
echo "API Token: $API_TOKEN"


---

âœ… äº”ã€å®‰å…¨æ€§è¯´æ˜

ä¼ é€’æ–¹å¼	æ˜¯å¦å®‰å…¨	è¯´æ˜

ssh "bash -s" + ç¯å¢ƒå˜é‡ä¼ é€’	âœ… å®‰å…¨ï¼Œå¯†ç ä¸ä¼šå‡ºç°åœ¨è¿œç«¯å‘½ä»¤è¡Œ	æ¨è
å‘½ä»¤å‚æ•°ä¼ é€’ï¼ˆå¦‚ bash script.sh $MY_PASSWORDï¼‰	âš ï¸ ä¸å®‰å…¨	å¯†ç ä¼šå‡ºç°åœ¨ ps ä¸­
ä¸Šä¼ æ–‡ä»¶å†è¯»å–å¯†ç 	âœ… å®‰å…¨æ€§å–å†³äºæ–‡ä»¶æƒé™	ä¸æ¨èä¸´æ—¶å­˜æ–‡ä»¶
GitLab Masked Variable	âœ… é¿å…æ—¥å¿—æ³„éœ²	å¿…é¡»å‹¾é€‰



---

âœ… å…­ã€å®Œæ•´ä¾‹å­ï¼ˆSSH ç™»å½• + ä¼ ä¸šåŠ¡å¯†ç ï¼‰

stages:
  - deploy

deploy_job:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add