æ˜ç™½äº† ğŸ‘ã€‚ä½ è¦çš„ä¸æ˜¯ CloudWatch CPU/å†…å­˜ è¿™ç§å¸¸è§„æŒ‡æ ‡ï¼Œè€Œæ˜¯ RDS Database Insights (Performance Insights) çš„ Top SQLã€ç­‰å¾…äº‹ä»¶ (wait events)ã€æ•°æ®åº“è´Ÿè½½ è¿™ç±» ç»†ç²’åº¦ SQL å±‚é¢çš„æŒ‡æ ‡ï¼Œå¹¶ä¸”è¦åœ¨ AWS Console çš„ CloudWatch Dashboardï¼ˆæˆ–è‡ªå®šä¹‰å¤§ç›˜ï¼‰é‡Œå±•ç¤ºã€‚


---

ğŸ”¹ 1. æ•°æ®æ¥æº

Top SQL / Wait Events / Active Sessions è¿™äº›æ•°æ®å¹¶ ä¸åœ¨ CloudWatch æ™®é€šæŒ‡æ ‡é‡Œï¼Œå®ƒä»¬æ¥è‡ª Performance Insights (PI) APIã€‚

CloudWatch Dashboard åªèƒ½åŸç”Ÿå±•ç¤º CloudWatch Metricsï¼Œæ‰€ä»¥è¦åœ¨å¤§ç›˜çœ‹åˆ° Top SQLï¼Œä½ å¿…é¡»ï¼š

1. è°ƒç”¨ pi:GetResourceMetrics è·å– RDS PI çš„æŒ‡æ ‡


2. ï¼ˆå¯é€‰ï¼‰è°ƒç”¨ pi:DescribeDimensionKeys è·å– SQLã€ç”¨æˆ·ã€ç­‰å¾…äº‹ä»¶çš„ç»´åº¦ä¿¡æ¯


3. ç”¨ CloudWatch Custom Metrics æˆ– CloudWatch Dashboard çš„ PI widget æ¥å±•ç¤º




AWS ä» 2023 å¹´èµ·æ”¯æŒåœ¨ CloudWatch Dashboard ä¸­ç›´æ¥åŠ  Performance Insights Widgetï¼Œæ‰€ä»¥å¯ä»¥ä¸å¿…å†é¢å¤–æ¨é€æŒ‡æ ‡ã€‚


---

ğŸ”¹ 2. éœ€è¦çš„æƒé™

æœ€å°æƒé™ï¼ˆIAM Policyï¼‰å¤§æ¦‚å¦‚ä¸‹ï¼š

{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "pi:GetResourceMetrics",
        "pi:DescribeDimensionKeys",
        "pi:GetDimensionKeyDetails",
        "rds:DescribeDBInstances"
      ],
      "Resource": "*"
    }
  ]
}

ğŸ‘‰ å…¶ä¸­ï¼š

pi:GetResourceMetrics â€”â€” è·å–æ•°æ®åº“è´Ÿè½½æ—¶é—´åºåˆ—

pi:DescribeDimensionKeys â€”â€” è·å– top SQLã€top wait eventsã€top users ç­‰

pi:GetDimensionKeyDetails â€”â€” è·å– SQL çš„å…·ä½“æ–‡æœ¬ï¼ˆå¯é€‰ï¼‰

rds:DescribeDBInstances â€”â€” åˆ—å‡ºæ•°æ®åº“å®ä¾‹



---

ğŸ”¹ 3. æ“ä½œæ­¥éª¤

æ–¹æ³•ä¸€ï¼šCloudWatch Dashboard åŠ  PI Widgetï¼ˆå®˜æ–¹æ¨èï¼‰

1. æ‰“å¼€ CloudWatch â†’ Dashboards â†’ Create Dashboard


2. é€‰æ‹© Add widget â†’ Performance Insights


3. é€‰æ‹© RDS å®ä¾‹


4. é€‰æ‹©è¦å±•ç¤ºçš„å†…å®¹ï¼š

Database load

Top SQL

Top waits

Top users




è¿™æ · CloudWatch Dashboard å°±èƒ½ç›´æ¥æ˜¾ç¤º RDS Insights çš„ Top SQL ç­‰å›¾è¡¨ï¼Œæƒé™éœ€è¦çš„æ˜¯ä¸Šé¢é‚£å‡ ä¸ª pi:* åŠ¨ä½œã€‚

æ–¹æ³•äºŒï¼šè‡ªå®šä¹‰å¤§ç›˜ï¼ˆé«˜çº§ï¼‰

å¦‚æœä½ è¦æŠŠ Top SQL æ•°æ®å–å‡ºæ¥è‡ªå®šä¹‰å¤„ç†ï¼Œæ­¥éª¤æ˜¯ï¼š

1. ç”¨è„šæœ¬ï¼ˆAWS CLI / Lambda / SDKï¼‰è°ƒç”¨ï¼š

aws pi get-resource-metrics \
  --service-type RDS \
  --identifier db-xxxxxxxxxxxx \
  --metric SQL \
  --start-time 2025-09-15T00:00:00Z \
  --end-time 2025-09-15T01:00:00Z \
  --period-in-seconds 60 \
  --region ap-southeast-2


2. æŠŠç»“æœï¼ˆJSONï¼‰å†™å…¥ CloudWatch Custom Metrics æˆ–å­˜åˆ° S3/Elasticsearch ç­‰å¤§ç›˜ç³»ç»Ÿï¼ˆGrafana / Kibanaï¼‰ã€‚




---

âœ… æ€»ç»“ï¼š

å¦‚æœåªæƒ³åœ¨ **AWS å¤§ç›˜ï¼ˆCloudWatch Dashboardï¼‰**é‡Œçœ‹ Top SQLï¼Œç›´æ¥åŠ  Performance Insights Widget å°±è¡Œã€‚

éœ€è¦çš„æƒé™æ˜¯ï¼špi:GetResourceMetricsã€pi:DescribeDimensionKeysã€pi:GetDimensionKeyDetailsã€rds:DescribeDBInstancesã€‚

å¦‚æœè¦è¿›ä¸€æ­¥ è‡ªå®šä¹‰åˆ†æ / å¤–éƒ¨å¤§ç›˜ï¼Œå°±è¦ç”¨ AWS CLI / SDK æ‹‰å–æ•°æ®ï¼Œå†æ¨é€åˆ°ä½ çš„å¤§ç›˜ã€‚



---

è¦ä¸è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ª CloudWatch Dashboard JSON æ¨¡æ¿ï¼Œç›´æ¥æ”¾è¿›å»å°±èƒ½æ˜¾ç¤ºæŸä¸ª RDS å®ä¾‹çš„ Top SQL å›¾è¡¨ï¼Ÿ

