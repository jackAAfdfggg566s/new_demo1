éå¸¸å¥½çš„ä¸‹ä¸€æ­¥ ğŸ‘
ä½ ç°åœ¨æƒ³è¦çš„æ˜¯ï¼š
âœ… åœ¨ Ansible é‡Œå…ˆæ‰¾åˆ° .7z æ–‡ä»¶å
âœ… è¾“å‡ºï¼ˆæˆ–ä¼ å…¥ï¼‰è¿™ä¸ªæ–‡ä»¶å
âœ… è°ƒç”¨è¿œç«¯å·²æœ‰çš„ Shell è„šæœ¬ï¼Œæ¯”å¦‚ /opt/deploy/run_deploy.shï¼Œè®©å®ƒç”¨è¿™ä¸ªæ–‡ä»¶åå»åšå¤‡ä»½ã€è§£å‹ç­‰åŠ¨ä½œ


---

ä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¯ç›´æ¥ç”¨æ¨¡æ¿ ğŸ‘‡


---

âœ… Ansible Playbook ç¤ºä¾‹

- hosts: target
  gather_facts: no
  vars:
    deploy_dir: /tmp
    remote_script: /opt/deploy/run_deploy.sh

  tasks:
    - name: Copy 7z file(s) to remote
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: "{{ deploy_dir }}/"
      with_fileglob:
        - "*.7z"
      register: copied_files

    - name: Set archive_name from first copied file
      ansible.builtin.set_fact:
        archive_name: "{{ copied_files.results[0].item | basename }}"

    - name: Show copied archive name
      ansible.builtin.debug:
        msg: "Archive file is {{ archive_name }}"

    - name: Execute remote deploy script
      ansible.builtin.shell: |
        bash "{{ remote_script }}" "{{ deploy_dir }}/{{ archive_name }}"
      args:
        executable: /bin/bash


---

âœ… å¯¹åº”è¿œç«¯è„šæœ¬ç¤ºä¾‹ï¼ˆ/opt/deploy/run_deploy.shï¼‰

#!/bin/bash
set -e

ARCHIVE_PATH="$1"

if [ -z "$ARCHIVE_PATH" ]; then
    echo "Usage: $0 <archive_path>"
    exit 1
fi

BACKUP_DIR="/opt/backup/$(date +%Y%m%d_%H%M%S)"
DEPLOY_DIR="/app"

echo ">>> [1/3] Backup current version to $BACKUP_DIR"
mkdir -p "$BACKUP_DIR"
cp -r "$DEPLOY_DIR"/* "$BACKUP_DIR"/ 2>/dev/null || true

echo ">>> [2/3] Extract new archive: $ARCHIVE_PATH"
mkdir -p "$DEPLOY_DIR"
7z x "$ARCHIVE_PATH" -o"$DEPLOY_DIR" -y

echo ">>> [3/3] Restart service"
systemctl restart myapp.service

echo ">>> Deployment finished."


---

ğŸ§© è¯´æ˜

archive_name ä» copy ä»»åŠ¡è‡ªåŠ¨è·å–ï¼›

bash "{{ remote_script }}" "{{ deploy_dir }}/{{ archive_name }}"
â†’ æŠŠæ–‡ä»¶å…¨è·¯å¾„ä¼ ç»™è„šæœ¬ï¼›

ä½ çš„è„šæœ¬å†…éƒ¨å°±èƒ½æ ¹æ® $1 çŸ¥é“å…·ä½“çš„ .7z æ–‡ä»¶ï¼›

æ•´ä¸ªè¿‡ç¨‹ä¸éœ€è¦ç¡¬ç¼–ç æ–‡ä»¶åï¼Œæ¯æ¬¡åŒ¹é…æ–°çš„åŒ…å³å¯ã€‚



---

âœ… å¦‚æœä½ æƒ³æ‰“å°æ—¥å¿—

å¯ä»¥è®©è„šæœ¬è¾“å‡ºå¸¦æ—¶é—´æˆ³ï¼š

echo "$(date '+%F %T') - Unzipping $ARCHIVE_PATH"

æˆ–è€…åœ¨ Ansible é‡Œæ•è·è¾“å‡ºï¼š

- name: Run deploy script
  ansible.builtin.shell: |
    bash "{{ remote_script }}" "{{ deploy_dir }}/{{ archive_name }}"
  register: deploy_result

- debug:
    var: deploy_result.stdout_lines


---

è¦ä¸è¦æˆ‘å¸®ä½ æŠŠä¸Šé¢è¿™å¥—æ”¹æˆèƒ½åŒæ—¶åŒ¹é…å¤šä¸ª .7z å¹¶è‡ªåŠ¨é€‰æœ€æ–°é‚£ä¸ªçš„ç‰ˆæœ¬ï¼Ÿ
ï¼ˆå¾ˆå¤šäººæ„å»ºè¾“å‡ºå¤šä¸ªåŒ…ï¼Œåªæƒ³è§£å‹æœ€æ–°çš„é‚£ä¸ªï¼‰