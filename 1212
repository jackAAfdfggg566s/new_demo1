ä¸‹é¢ç»™ä½ ä¸€ä¸ª æœ€å®ç”¨ã€æœ€ç®€çŸ­çš„ Bash + AWS CLI for å¾ªç¯ç¤ºä¾‹ï¼Œ
å¯ä»¥æ»¡è¶³ä½ çš„éœ€æ±‚ï¼š

æ ¹æ®ä¸€ç»„ tagï¼ˆ1ã€2ã€3ï¼‰ï¼Œä¾æ¬¡ï¼š

1. æ‰¾åˆ° EC2 instance ID


2. æ‰¾åˆ°å®ƒæ‰€åœ¨çš„ AZï¼ˆå¦‚ ap-southeast-2aï¼‰


3. æ ¹æ® AZ æ‰¾åˆ°å¯¹åº”çš„ subnet ID


4. æœ€åä¸“é—¨è¿‡æ»¤ 2a çš„ subnet ID




---

âœ… å®Œæ•´ Bash è„šæœ¬æ¡ˆä¾‹ï¼ˆå¯ç›´æ¥ç”¨ï¼‰

#!/bin/bash

TAGS=("1" "2" "3")
REGION="ap-southeast-2"

for tag in "${TAGS[@]}"; do
  echo "== Tag = $tag =="

  # 1. æ ¹æ® tag å– instance id
  INSTANCE_ID=$(aws ec2 describe-instances \
    --filters "Name=tag:Name,Values=$tag" \
    --query "Reservations[].Instances[].InstanceId" \
    --output text \
    --region $REGION)

  echo "Instance: $INSTANCE_ID"

  # 2. è·å–å®ƒçš„ AZ
  AZ=$(aws ec2 describe-instances \
    --instance-ids "$INSTANCE_ID" \
    --query "Reservations[].Instances[].Placement.AvailabilityZone" \
    --output text \
    --region $REGION)

  echo "AZ: $AZ"

  # 3. æ‰¾åˆ°è¿™ä¸ª AZ ä¸‹çš„ subnet
  SUBNET_ID=$(aws ec2 describe-subnets \
    --filters "Name=availabilityZone,Values=$AZ" \
    --query "Subnets[].SubnetId" \
    --output text \
    --region $REGION)

  echo "Subnet(s): $SUBNET_ID"

  # 4. å¦‚æœæ˜¯ 2aï¼Œåˆ™è¾“å‡º
  if [[ "$AZ" == *"2a" ]]; then
    echo ">>> This is 2a subnet: $SUBNET_ID"
  fi

  echo
done


---

â­ è¯´æ˜

1. TAGS=("1" "2" "3")

ä½ å¯ä»¥æ¢æˆä»»ä½• tag å€¼ã€‚

å¦‚æœä½ çš„ tag key ä¸æ˜¯ Nameï¼Œæ¯”å¦‚ Environmentï¼Œå°±æ”¹æˆï¼š

--filters "Name=tag:Environment,Values=$tag"


---

2. å…³é”®å‘½ä»¤è§£é‡Š

è·å– instance id

aws ec2 describe-instances --filters "Name=tag:Name,Values=$tag"

è·å–å®ƒçš„ AZ

aws ec2 describe-instances --instance-ids $INSTANCE_ID

è·å– AZ å¯¹åº”çš„ subnet

aws ec2 describe-subnets --filters "Name=availabilityZone,Values=$AZ"


---

ğŸ‘ å¦‚æœä½ åªæƒ³å¾—åˆ° æ‰€æœ‰ tag ä¸­å±äº 2a çš„ subnet idï¼ˆæœ€ç»ˆç»“æœï¼‰ï¼Œä¸‹é¢æ˜¯æœ€ç²¾ç®€ç‰ˆï¼š

for t in 1 2 3; do
  iid=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=$t" --query "Reservations[].Instances[].InstanceId" --output text)
  az=$(aws ec2 describe-instances --instance-ids $iid --query "Reservations[].Instances[].Placement.AvailabilityZone" --output text)

  if [[ $az == *"2a" ]]; then
    subnet=$(aws ec2 describe-subnets --filters "Name=availabilityZone,Values=$az" --query "Subnets[].SubnetId" --output text)
    echo "$t â†’ $iid â†’ $az â†’ $subnet"
  fi
done


---

ğŸ“Œ å¦‚æœä½ å‘Šè¯‰æˆ‘ä½ çš„ tag çš„ keyï¼ˆName? Role? Env?ï¼‰

æˆ‘å¯ä»¥æŠŠè„šæœ¬æ”¹æˆä½ å®Œå…¨èƒ½å¤åˆ¶ç²˜è´´ç›´æ¥ç”¨çš„ç‰ˆæœ¬ã€‚