å¯ä»¥çš„ï¼Œè€Œä¸”è¿™æ˜¯ æ ‡å‡† / ç¨³å®š / å®˜æ–¹æ¨è çš„æ–¹å¼ ğŸ‘
æ ¸å¿ƒç‚¹ä¸€å¥è¯ï¼š
EKS çš„ EC2 node ä¸Šä¸€å®šæœ‰ eks:nodegroup-name è¿™ä¸ª tag
âœ… æ–¹æ³•ä¸€ï¼ˆæœ€ç›´æ¥ï¼Œå¼ºçƒˆæ¨èï¼‰ï¼š
ä» Node â†’ EC2 Instance â†’ Tag
1ï¸âƒ£ å…ˆä» k8s node æ‹¿åˆ° EC2 instance id
å¤åˆ¶ä»£ç 
Bash
kubectl get node <node-name> -o jsonpath='{.spec.providerID}'
è¾“å‡ºç±»ä¼¼ï¼š
å¤åˆ¶ä»£ç 

aws:///ap-southeast-2a/i-0abc123def456
æå– instance idï¼š
å¤åˆ¶ä»£ç 
Bash
INSTANCE_ID=$(kubectl get node <node-name> -o jsonpath='{.spec.providerID}' | awk -F/ '{print $NF}')
2ï¸âƒ£ ç”¨ AWS CLI æŸ¥ EC2 tagï¼ˆå¾—åˆ° nodegroup nameï¼‰
å¤åˆ¶ä»£ç 
Bash
aws ec2 describe-instances \
  --instance-ids $INSTANCE_ID \
  --query 'Reservations[].Instances[].Tags[?Key==`eks:nodegroup-name`].Value' \
  --output text
è¾“å‡ºç¤ºä¾‹ï¼š
å¤åˆ¶ä»£ç 

nodegroup-2a
âœ… è¿™å°±æ˜¯ node å¯¹åº”çš„ EKS managed nodegroup
âœ… æ–¹æ³•äºŒï¼šä¸€æ¡å‘½ä»¤ç›´æ¥æŸ¥ï¼ˆé€‚åˆè„šæœ¬ï¼‰
å¤åˆ¶ä»£ç 
Bash
kubectl get node <node-name> -o jsonpath='{.spec.providerID}' \
| awk -F/ '{print $NF}' \
| xargs aws ec2 describe-instances \
  --query 'Reservations[].Instances[].Tags[?Key==`eks:nodegroup-name`].Value' \
  --output text
ğŸ” æ‰¹é‡ï¼šä»ä¸€å † node æ‹¿ nodegroup
å¤åˆ¶ä»£ç 
Bash
for n in $(kubectl get node -o name); do
  iid=$(kubectl get $n -o jsonpath='{.spec.providerID}' | awk -F/ '{print $NF}')
  ng=$(aws ec2 describe-instances \
        --instance-ids $iid \
        --query 'Reservations[].Instances[].Tags[?Key==`eks:nodegroup-name`].Value' \
        --output text)
  echo "$n -> $ng"
done
âš ï¸ ç‰¹åˆ«æ³¨æ„çš„å‘ï¼ˆå¾ˆé‡è¦ï¼‰
1ï¸âƒ£ åªå¯¹ Managed Node Group æœ‰
eks:nodegroup-name
eks:cluster-name
å¦‚æœæ˜¯ï¼š
self-managed nodegroup
karpenter
æ‰‹å·¥ ASG
âŒ è¿™ä¸ª tag ä¸å­˜åœ¨
2ï¸âƒ£ è‡ªå»º / self-managed æ€ä¹ˆåŠï¼Ÿ
é€šå¸¸ä¼šæœ‰ï¼š
kubernetes.io/cluster/<cluster-name>
Name / ASG tag
éœ€è¦ä½ è‡ªå·±å®šä¹‰è§„åˆ™
ğŸ§  å’Œä½ å½“å‰ FIS åœºæ™¯çš„æœ€ä½³ç»“åˆæ–¹å¼
ä½ ç°åœ¨åšçš„æ˜¯ï¼š
FIS â†’ terminate æŸ AZ ä¸‹æŸ nodegroup çš„æ‰€æœ‰ node
é‚£å°±ç›´æ¥ç”¨ï¼š
å¤åˆ¶ä»£ç 
Json
filters:
- Placement.AvailabilityZone
- tag:eks:nodegroup-name
- State.Name
å®Œå…¨ä¸éœ€è¦å…ˆç®— node â†’ instance â†’ ARN
âœ… ä¸€å¥è¯æ€»ç»“
ç›®æ ‡
æ¨èæ–¹å¼
å• node æŸ¥ nodegroup
eks:nodegroup-name tag
æ‰¹é‡ node
å¾ªç¯ + describe-instances
FIS / è‡ªåŠ¨åŒ–
ç›´æ¥ç”¨ tag filterï¼ˆåˆ«ç”¨ ARNï¼‰
å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ï¼š
ğŸ”§ æŠŠä½ ç°åœ¨ â€œnode â†’ ARN â†’ FISâ€ çš„è„šæœ¬é‡æ„æ‰
ğŸ“„ ç»™ä½ ä¸€ä¸ª é€šç”¨ FIS æ¨¡æ¿ + AZ / nodegroup å‚æ•°åŒ–ç‰ˆæœ¬
ä½ ç°åœ¨ node æ˜¯ managed nodegroup è¿˜æ˜¯ self-managed / karpenterï¼Ÿ