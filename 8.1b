ğŸ‘Œ ä½ è¦åš RDS Single-AZ failoverï¼Œé€šè¿‡ AWS CLI è·å–å½“å‰å®ä¾‹çš„ AZ ä¿¡æ¯ï¼Œè¿™ä¸ªæˆ‘å¸®ä½ æ¢³ç†ä¸€ä¸‹ã€‚


---

1ï¸âƒ£ è·å–å½“å‰ AZ

RDS å®ä¾‹çš„ AZ å¯ä»¥é€šè¿‡ describe-db-instances æ‹¿åˆ°ï¼Œæ¯”å¦‚ï¼š

aws rds describe-db-instances \
  --db-instance-identifier <ä½ çš„å®ä¾‹ID> \
  --query "DBInstances[0].AvailabilityZone" \
  --output text

è¾“å‡ºç¤ºä¾‹ï¼š

ap-southeast-2a


---

2ï¸âƒ£ Single-AZ Failover çš„è§¦å‘æ–¹å¼

Single-AZ RDS æ²¡æœ‰çœŸæ­£æ„ä¹‰ä¸Šçš„ failoverï¼ˆå› ä¸ºæ²¡æœ‰å¤‡ç”¨ AZï¼‰ï¼Œä½† AWS æä¾›äº†é‡æ–°å¯åŠ¨ï¼ˆRebootï¼‰å¹¶å¯é€‰æ‹©åˆ‡æ¢ AZ çš„é€‰é¡¹ï¼š

aws rds reboot-db-instance \
  --db-instance-identifier <ä½ çš„å®ä¾‹ID> \
  --force-failover

å¦‚æœæ˜¯ Multi-AZï¼Œ--force-failover ä¼šåˆ‡æ¢åˆ°å¦ä¸€ä¸ª AZ

å¦‚æœæ˜¯ Single-AZï¼Œè¿™ä¸ªå‚æ•°ä¼šå¿½ç•¥ï¼Œåªæ˜¯é‡å¯å®ä¾‹ï¼ˆä¸ä¼šæ¢ AZï¼Œå› ä¸ºæ²¡æœ‰å¤‡ç”¨ï¼‰



---

3ï¸âƒ£ å¦‚æœæ˜¯ Single-AZ ä½†æƒ³æ¢ AZ

AWS CLI æ²¡æœ‰ç›´æ¥çš„ â€œSingle-AZ Failoverâ€ï¼Œå”¯ä¸€åŠæ³•æ˜¯ï¼š

ä¿®æ”¹å®ä¾‹å±æ€§ï¼Œè®©å®ƒåˆ‡æ¢ AZ


aws rds modify-db-instance \
  --db-instance-identifier <ä½ çš„å®ä¾‹ID> \
  --availability-zone <æ–°çš„AZ> \
  --apply-immediately

æˆ–è€…ï¼š


aws rds modify-db-instance \
  --db-instance-identifier <ä½ çš„å®ä¾‹ID> \
  --multi-az \
  --apply-immediately

ç„¶åå†å¼ºåˆ¶ failover åˆ°å¦ä¸€ä¸ª AZ


---

4ï¸âƒ£ æ€»ç»“ CLI æµç¨‹

# è·å–å½“å‰ AZ
CURRENT_AZ=$(aws rds describe-db-instances \
  --db-instance-identifier mydb \
  --query "DBInstances[0].AvailabilityZone" \
  --output text)

echo "å½“å‰ AZ: $CURRENT_AZ"

# å¦‚æœæ˜¯ Multi-AZ
aws rds reboot-db-instance \
  --db-instance-identifier mydb \
  --force-failover

# å¦‚æœæ˜¯ Single-AZï¼Œæƒ³æ¢ AZ
NEW_AZ="ap-southeast-2b"
aws rds modify-db-instance \
  --db-instance-identifier mydb \
  --availability-zone $NEW_AZ \
  --apply-immediately


---

æˆ‘æœ‰ä¸ªç–‘é—®ï¼šä½ ç°åœ¨ä¸¤ä¸ª AWS account çš„ RDS æ˜¯ Multi-AZ è¿˜æ˜¯ Single-AZï¼Ÿ
å› ä¸ºå¦‚æœéƒ½æ˜¯ Single-AZï¼Œæˆ‘å¯ä»¥å¸®ä½ å†™ä¸ª GitLab CI è„šæœ¬è‡ªåŠ¨ï¼š

1. è·å–å½“å‰ AZ


2. è‡ªåŠ¨åˆ‡æ¢åˆ°å¦ä¸€ä¸ª AZ


3. ä¸¤ä¸ª account å¹¶è¡Œæ‰§è¡Œ
è¿™æ ·ä½ ç‚¹ä¸€æ¬¡æŒ‰é’®å°±å…¨æå®šã€‚ä½ è¦æˆ‘å¸®ä½ åšè¿™ä¸ªè‡ªåŠ¨åˆ‡æ¢ç‰ˆæœ¬å—ï¼Ÿ



