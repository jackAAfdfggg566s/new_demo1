å¾ˆå¥½ï¼Œä½ ç°åœ¨æœ‰ä¸¤ä¸ª Pipelineï¼š

âœ… pipeline Aï¼šæ£€æŸ¥æ‰€æœ‰æœºå™¨ï¼ˆä¸ä¼ ç”¨æˆ·å˜é‡ï¼Œä½¿ç”¨é»˜è®¤ IP åˆ—è¡¨ï¼‰

âœ… pipeline Bï¼šåªæ£€æŸ¥æŸä¸€å°æœºå™¨ï¼ˆé€šè¿‡ variable ä¼ å…¥ IP ç¼–å·ï¼‰

ğŸ”„ å®ƒä»¬å…±ç”¨å‡½æ•°é€»è¾‘ï¼Œæ¯”å¦‚ get_ip_by_index å’Œ get_name_by_ip

âœ… extends ä¸åŒï¼Œåˆ†åˆ«ç»§æ‰¿ä¸åŒæ¨¡æ¿é€»è¾‘



---

âœ… æ¨èç»“æ„è®¾è®¡ï¼ˆå¹²å‡€ã€æ˜“ç»´æŠ¤ï¼‰

.gitlab/
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ check_one.yml         # ç”¨äºæ£€æŸ¥å•å°æœºå™¨çš„ Job æ¨¡æ¿
â”‚   â””â”€â”€ check_all.yml         # ç”¨äºæ£€æŸ¥å…¨éƒ¨æœºå™¨çš„ Job æ¨¡æ¿
â”œâ”€â”€ functions.sh              # å…¬å…± shell å‡½æ•°
.gitlab-ci.yml                # ä¸» pipeline


---

âœ… functions.shï¼ˆå®Œå…¨æ”¯æŒä½ çš„éœ€æ±‚ï¼‰

# functions.sh

# é»˜è®¤ IP åˆ—è¡¨
DEFAULT_IPS=("192.168.1.1" "192.168.1.2" "192.168.1.3" "192.168.1.4")

# IP â†” åç§°
get_name_by_ip() {
  case "$1" in
    192.168.1.1) echo "host-a" ;;
    192.168.1.2) echo "host-b" ;;
    192.168.1.3) echo "host-c" ;;
    192.168.1.4) echo "host-d" ;;
    *) echo "unknown" ;;
  esac
}

get_ip_by_index() {
  case "$1" in
    1) echo "192.168.1.1" ;;
    2) echo "192.168.1.2" ;;
    3) echo "192.168.1.3" ;;
    4) echo "192.168.1.4" ;;
    *) echo "" ;;
  esac
}


---

âœ… .gitlab/templates/check_all.yml

.check_all_template:
  script:
    - source ./functions.sh
    - for ip in "${DEFAULT_IPS[@]}"; do
        name=$(get_name_by_ip "$ip");
        echo "æ£€æŸ¥ $name ($ip)...";
        # æ­¤å¤„æ‰§è¡Œæ£€æŸ¥é€»è¾‘
      done


---

âœ… .gitlab/templates/check_one.yml

.check_one_template:
  script:
    - source ./functions.sh
    - selected_ip=$(get_ip_by_index "$INDEX")
    - if [ -z "$selected_ip" ]; then
        echo "ç¼–å·æ— æ•ˆ: $INDEX"; exit 1;
      fi
    - name=$(get_name_by_ip "$selected_ip")
    - echo "ä»…æ£€æŸ¥ $name ($selected_ip)..."
    # æ­¤å¤„æ‰§è¡Œæ£€æŸ¥é€»è¾‘


---

âœ… ä¸» .gitlab-ci.yml ç¤ºä¾‹

include:
  - local: '.gitlab/templates/check_all.yml'
  - local: '.gitlab/templates/check_one.yml'

stages:
  - check

check-all-machines:
  stage: check
  extends: .check_all_template

check-one-machine:
  stage: check
  extends: .check_one_template
  variables:
    INDEX: 2   # âœ… ç”¨æˆ·æˆ– schedule job å¯æŒ‡å®šè¿™ä¸ªå˜é‡


---

âœ… ç”¨æˆ·æ§åˆ¶é€»è¾‘ï¼š

check-all-machinesï¼šè¿è¡Œå…¨éƒ¨ï¼Œä¸æ¥å—å˜é‡ï¼ˆä¸å¯å˜ï¼‰

check-one-machineï¼šç”¨æˆ·æˆ–æ‰‹åŠ¨è¾“å…¥ INDEX é€‰æ‹© IP


ä½ è¿˜å¯ä»¥ç”¨ only:variables é™åˆ¶ job ä½•æ—¶èƒ½è¿è¡Œã€‚


---

å¦‚æœä½ å¸Œæœ›è®©ç”¨æˆ·æ— æ³•è¯¯æ“ä½œ check-all çš„ DEFAULT_IPSï¼Œå¯ä»¥æŠŠé»˜è®¤ IP å†™æ­»åœ¨ functions.sh é‡Œï¼Œæˆ–ä»å®‰å…¨å˜é‡è¯»å–ï¼ˆä½†ä¸æš´éœ²åœ¨ UIï¼‰ã€‚

æ˜¯å¦éœ€è¦æˆ‘è¿›ä¸€æ­¥å°è£…

