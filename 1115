ä¸‹é¢ç»™ä½ ä¸€ä¸ª å¯è¿è¡Œçš„ GitLab Agent/CI æ–¹æ¡ˆï¼Œå®ç°ï¼š

åœ¨ before_script ä¸­

æ ¹æ®å˜é‡å€¼ï¼ˆä¾‹å¦‚ TYPE=A/Bï¼‰

è°ƒç”¨ä¸åŒçš„å…¬å…±ä»£ç å—ï¼ˆ!referenceï¼‰



---

â—ï¸é‡ç‚¹ï¼š

GitLab çš„ !reference ä¸èƒ½åœ¨è„šæœ¬é‡ŒåŠ¨æ€è°ƒç”¨
å› ä¸ºå®ƒæ˜¯ YAML ç¼–è¯‘æœŸæŒ‡ä»¤ï¼Œä¸æ˜¯è¿è¡ŒæœŸæŒ‡ä»¤ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼š

> ä½ ä¸èƒ½ç”¨ if åˆ¤æ–­ï¼Œç„¶ååœ¨è¿è¡Œæ—¶é€‰æ‹© !reference å“ªä¸€æ®µã€‚



ä½†ä½ å¯ä»¥é€šè¿‡ YAML çš„é™æ€ç»“æ„ + runtime çš„ if ç»„åˆå®ç°â€œåŠ¨æ€æ•ˆæœâ€ã€‚


---

âœ… æ­£ç¡®åšæ³•ï¼ˆæ¨èï¼Œ100% å¯è¿è¡Œï¼‰

ä½ å†™ ä¸¤ä¸ªæ¨¡æ¿ï¼Œæ¯ä¸ªæ¨¡æ¿åŒ…å«ä¸åŒçš„ before_script å†…å®¹ï¼Œç„¶åæ ¹æ®å˜é‡é€‰æ‹© extends å“ªä¸ªæ¨¡æ¿ã€‚


---

1ï¸âƒ£ å®šä¹‰ä¸¤ä¸ªå…¬å…±æ¨¡æ¿

.before_A:
  before_script:
    - echo "This is A logic"
    - export FINAL="Value from A"

.before_B:
  before_script:
    - echo "This is B logic"
    - export FINAL="Value from B"


---

2ï¸âƒ£ å†å®šä¹‰ä¸€ä¸ªä¸­é—´æ¨¡æ¿ï¼Œæ ¹æ®å˜é‡é€‰æ‹© extends

GitLab æ”¯æŒ rules â†’ extends æ–¹å¼åŠ¨æ€é€‰æ‹©æ¨¡æ¿ï¼š

.dynamic_before:
  rules:
    - if: '$TYPE == "A"'
      extends: .before_A
    - if: '$TYPE == "B"'
      extends: .before_B


---

3ï¸âƒ£ Job ä½¿ç”¨è¿™ä¸ªâ€œåŠ¨æ€æ¨¡æ¿â€

job1:
  extends:
    - .dynamic_before
  variables:
    TYPE: "A"
  script:
    - echo "Final = $FINAL"


---

ğŸ”¥ æ‰§è¡Œæ•ˆæœ

å¦‚æœ TYPE=A

job ç»§æ‰¿ .before_Aï¼Œè¾“å‡ºï¼š

This is A logic
Final = Value from A

å¦‚æœ TYPE=B

job ç»§æ‰¿ .before_Bï¼Œè¾“å‡ºï¼š

This is B logic
Final = Value from B


---

â—ï¸ä¸ºä»€ä¹ˆä¸èƒ½å†™è¿™æ ·ï¼Ÿï¼ˆé”™è¯¯ï¼‰

before_script:
  - if [[ "$TYPE" == "A" ]]; then
      !reference [.before_A, before_script]
    fi

å› ä¸ºï¼š

!reference æ˜¯ YAML è§£æé˜¶æ®µæ‰§è¡Œ

shell çš„ if æ˜¯è¿è¡Œé˜¶æ®µ

ä¸¤è€…æ··ä¸åˆ°ä¸€èµ·



---

âœ… å¦‚æœä½ åšæŒåªè¦ä¸€ä¸ªæ¨¡æ¿ï¼Œæˆ‘ä¹Ÿèƒ½ç»™ä½ è¿™ä¸ªç‰ˆæœ¬ï¼š

åœ¨ before_script é‡Œç”¨ if/elseï¼Œå®ç°åŠ¨æ€é€»è¾‘ï¼ˆä¸éœ€è¦ referenceï¼‰ï¼š

.common_before:
  before_script:
    - |
      if [[ "$TYPE" == "A" ]]; then
        echo "Use logic A"
        export FINAL="Value A"
      else
        echo "Use logic B"
        export FINAL="Value B"
      fi

ç„¶å jobï¼š

job1:
  extends: .common_before
  variables:
    TYPE: "A"
  script:
    - echo "Final = $FINAL"


---

ğŸ“Œ æ€»ç»“æœ€ä½³æ–¹æ¡ˆ

è¦åŠ¨æ€é€‰æ‹©ä¸åŒè„šæœ¬ â†’ rules + extends ä¸¤å±‚æ¨¡æ¿ï¼ˆæ¨èï¼‰

è¦åœ¨ä¸€ä¸ªæ¨¡æ¿å†…å†™é€»è¾‘ â†’ if/else in shellï¼ˆä¸èƒ½ç”¨ !referenceï¼‰


---

å¦‚æœä½ æŠŠä½ çš„ .gitlab-ci.yml è´´å‡ºæ¥ï¼Œæˆ‘å¯ä»¥ç›´æ¥å¸®ä½ æ”¹æˆæœ€ç®€æ´èƒ½è·‘çš„ç‰ˆæœ¬ã€‚