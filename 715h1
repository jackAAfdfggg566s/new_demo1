éå¸¸æ£’çš„é—®é¢˜ï¼

ä½ æƒ³çš„æ˜¯ï¼š

> âœ… å…ˆå†™æŸ¥è¯¢ Jobï¼ˆç”¨æˆ·æ‰‹åŠ¨è§¦å‘ï¼‰ï¼Œç„¶åå®ƒè‡ªåŠ¨å»è¿è¡Œä¾èµ–çš„ Jobï¼ˆè·å– RDS endpointï¼‰



ä¹Ÿå°±æ˜¯è¯´ï¼šä½ æƒ³è®©åé¢çš„ Job æ‰‹åŠ¨è§¦å‘ï¼Œä½†ä¾èµ–çš„ Job è‡ªåŠ¨æ‰§è¡Œã€‚


---

ğŸ§  é»˜è®¤è¡Œä¸ºè¯´æ˜ï¼ˆå…³é”®ç‚¹ï¼‰ï¼š

GitLab çš„ Job æ‰§è¡Œé¡ºåºåŸºäº stages å’Œä¾èµ–

needs: å¯ä»¥è®©ä¸€ä¸ª Job â€œéœ€è¦â€å¦ä¸€ä¸ª Job çš„ç»“æœï¼ˆæ¯”å¦‚ artifactsï¼‰

ä½†å¦‚æœä½ åªæ‰‹åŠ¨è§¦å‘ åé¢çš„ Jobï¼ŒGitLab ä¼šè‡ªåŠ¨å…ˆè·‘è¢«éœ€è¦çš„ Job



---

âœ… ç»“è®ºï¼šå¯ä»¥åè¿‡æ¥ï¼è€Œä¸”è¿™æ˜¯ GitLab å®˜æ–¹æ¨èåšæ³•ä¹‹ä¸€

ä½ åªéœ€è¦æŠŠ æŸ¥è¯¢ Job æ ‡è®°ä¸º when: manualï¼Œå‰é¢çš„ get-endpoint Job ä¼šåœ¨ä½ æ‰‹åŠ¨è§¦å‘åè¢«è‡ªåŠ¨è¿è¡Œã€‚


---

âœ… ç¤ºä¾‹ï¼šæŸ¥è¯¢ Job æ˜¯æ‰‹åŠ¨ï¼Œå‰ç½®è‡ªåŠ¨æ‰§è¡Œ

stages:
  - prepare
  - query

get-endpoint:
  stage: prepare
  image: amazon/aws-cli
  script:
    - reader_ep=$(aws rds describe-db-clusters \
        --region ap-southeast-2 \
        --query "DBClusters[?DBClusterIdentifier=='my-cluster'].ReaderEndpoint" \
        --output text)
    - echo "RDS_ENDPOINT=$reader_ep" >> env.txt
  artifacts:
    reports:
      dotenv: env.txt

query-db:
  stage: query
  image: postgres:15
  script:
    - echo "ğŸ“¥ ä½¿ç”¨ reader endpoint: $RDS_ENDPOINT"
    - PGPASSWORD=$DB_PASS psql -h "$RDS_ENDPOINT" -U "$DB_USER" -d mydb -c "SELECT now();"
  variables:
    DB_USER: myuser
    DB_PASS: mypass
  needs: ["get-endpoint"]
  when: manual


---

âœ… æ‰§è¡Œé€»è¾‘

1. ä½ åœ¨ GitLab æ‰‹åŠ¨ç‚¹å‡» query-db Jobï¼ˆå®ƒæ˜¯ manualï¼‰


2. GitLab å‘ç° query-db éœ€è¦ get-endpoint çš„è¾“å‡º


3. GitLab ä¼šå…ˆè‡ªåŠ¨è¿è¡Œ get-endpoint


4. æˆåŠŸåï¼Œç»§ç»­è¿è¡Œä½ ç‚¹å‡»çš„ query-db




---

âœ… æµ‹è¯•å»ºè®®ï¼š

ç‚¹â€œRun pipelineâ€åä¸è¦ç‚¹â€œPlay Allâ€

å•ç‹¬ç‚¹å‡» query-dbï¼Œè§‚å¯Ÿæ˜¯å¦è‡ªåŠ¨å…ˆè·‘ get-endpoint



---

âœ… Bonusï¼šè®© get-endpoint éšè—/è‡ªåŠ¨è·‘

ä½ å¯ä»¥è®© get-endpoint è®¾ç½®ä¸º when: on_successï¼ˆé»˜è®¤ï¼‰ï¼Œæˆ–è€…ç”¨ rules: éšè—å®ƒä¸è¢«å•ç‹¬è§¦å‘ï¼š

rules:
  - when: never


---

å¦‚ä½ å¸Œæœ›æˆ‘ç”Ÿæˆä¸€ä¸ªå®Œæ•´ .gitlab-ci.yml ç¤ºä¾‹æ”¯æŒï¼š

è‡ªåŠ¨è·å– reader endpoint

æ‰‹åŠ¨è§¦å‘ SQL æŸ¥è¯¢


æˆ‘å¯ä»¥æŒ‰ä½ åœºæ™¯å®šåˆ¶ç”Ÿæˆã€‚æ˜¯å¦éœ€è¦ï¼Ÿ

