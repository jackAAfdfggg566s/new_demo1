æ˜ç™½å•¦ ğŸ‘

ä½ æ˜¯å¸Œæœ›é…ç½®æ–‡ä»¶é‡Œå¯ä»¥å†™ä¸€å †è‡ªå®šä¹‰çš„ -Då‚æ•°ï¼ˆæ¯”å¦‚ -Dloadtime=xxxã€-Dpeak=xxxï¼‰ï¼Œç„¶å Python è„šæœ¬è¦é€ä¸ªè¯»å–ã€åˆ¤æ–­æ˜¯å¦å­˜åœ¨ã€æ‹¼æ¥åˆ° Java å¯åŠ¨å‘½ä»¤é‡Œã€‚

æˆ‘ç»™ä½ å†™ä¸ªæ›´çµæ´»çš„ç‰ˆæœ¬ï¼š


---

ç¤ºä¾‹ config.ini

[java]
java_home = /usr/bin/java
jar_file = /path/to/myapp.jar
args = --spring.profiles.active=prod

# è‡ªå®šä¹‰å‚æ•°ï¼Œå¯ä»¥å†™ä»»æ„ key=value
dloadtime = 30
dpeak = 100
dmode = fast

[log]
log_file = /path/to/myapp.log
check_field = "Started Application"
backup_dir = /backup/logs
pid_log = /var/run/myapp.pid


---

Python è„šæœ¬ run_java.py

import os
import subprocess
import configparser
import shutil
import time
import sys

# 1. è¯»å–é…ç½®æ–‡ä»¶
config = configparser.ConfigParser()
config.read('config.ini')

java_home = config['java']['java_home']
jar_file = config['java']['jar_file']
args = config['java']['args']

log_file = config['log']['log_file']
check_field = config['log']['check_field']
backup_dir = config['log']['backup_dir']
pid_log = config['log']['pid_log']

# 2. è¯»å–æ‰€æœ‰ -D å‚æ•°ï¼ˆè‡ªåŠ¨æ‰«æä»¥ d å¼€å¤´çš„é”®ï¼‰
java_opts = []
for key, value in config['java'].items():
    if key.startswith("d"):  # çº¦å®šï¼šé…ç½®é¡¹ä»¥ d å¼€å¤´å°±æ˜¯ -D å‚æ•°
        opt = f"-D{key}={value}"
        java_opts.append(opt)

# åˆ¤æ–­å¿…é¡»å­—æ®µæ˜¯å¦å­˜åœ¨ï¼ˆæ¯”å¦‚ dloadtime, dpeakï¼‰
required_opts = ["dloadtime", "dpeak"]
missing = [opt for opt in required_opts if opt not in config['java']]
if missing:
    print(f"ç¼ºå°‘å¿…è¦å‚æ•°: {missing}")
    sys.exit(1)

# 3. æ‹¼æ¥å‘½ä»¤
java_opts_str = " ".join(java_opts)
cmd = f"{java_home} {java_opts_str} -jar {jar_file} {args}"
print(f"å¯åŠ¨å‘½ä»¤: {cmd}")

# 4. å¯åŠ¨ Java ç¨‹åº
proc = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
pid = proc.pid
print(f"Java ç¨‹åºå·²å¯åŠ¨, PID={pid}")

# 5. ä¿å­˜ PID
with open(pid_log, "w") as f:
    f.write(str(pid))

# 6. ç­‰å¾…æ—¥å¿—å¹¶æ£€æŸ¥å­—æ®µ
field_exists = False
for _ in range(30):  # æœ€å¤šæ£€æŸ¥ 30 æ¬¡ï¼ˆçº¦ 30 ç§’ï¼‰
    time.sleep(1)
    if os.path.exists(log_file):
        with open(log_file, "r") as f:
            for line in f:
                if check_field in line:
                    field_exists = True
                    break
    if field_exists:
        break

print(f"å­—æ®µæ£€æŸ¥ç»“æœ: {field_exists}")

# 7. æ‹·è´æ—¥å¿—æ–‡ä»¶
if os.path.exists(log_file):
    os.makedirs(backup_dir, exist_ok=True)
    shutil.copy(log_file, backup_dir)
    print(f"æ—¥å¿—å·²æ‹·è´åˆ° {backup_dir}")
else:
    print("æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•æ‹·è´ã€‚")


---

åŠŸèƒ½æ€»ç»“

âœ… é…ç½®æ–‡ä»¶é‡Œå†™è‡ªå®šä¹‰å‚æ•°ï¼ˆdloadtime=30ï¼Œdpeak=100ï¼‰ã€‚
âœ… Python è„šæœ¬ä¼šè‡ªåŠ¨è½¬æ¢ä¸º -Dloadtime=30 -Dpeak=100 æ‹¼åˆ° Java å¯åŠ¨å‘½ä»¤é‡Œã€‚
âœ… å¯ä»¥è®¾å®šå¿…éœ€å‚æ•°ï¼ˆå¦‚ dloadtimeã€dpeakï¼‰ï¼Œç¼ºå¤±å°±æŠ¥é”™é€€å‡ºã€‚
âœ… ä»ç„¶ä¼šä¿å­˜ PIDã€æ£€æŸ¥æ—¥å¿—å­—æ®µã€æ‹·è´æ—¥å¿—ã€‚


---

è¦ä¸è¦æˆ‘å†å¸®ä½ åšä¸€ç‰ˆ æ”¯æŒæ— é™å‚æ•°ï¼ˆæ¯”å¦‚ä½ å†™äº† 10 ä¸ª dxxx=yyyï¼Œè„šæœ¬å…¨éƒ½è‡ªåŠ¨è½¬æˆ -Dxxx=yyyï¼Œä¸ç”¨æ‰‹åŠ¨æ”¹ Python ä»£ç ï¼‰ï¼Ÿ

