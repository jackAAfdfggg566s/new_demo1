æ˜ç™½äº†ï¼ä½ æƒ³é€šè¿‡ Kubernetes Service Name æ‰¾åˆ°å…¶å¯¹åº”çš„ NLB çš„ DNS åç§°ï¼Œç„¶åé€æ­¥ï¼š

1. æ ¹æ® Service æ‰¾åˆ° NLB çš„ DNS åã€‚


2. é€šè¿‡ DNS åæŸ¥åˆ° Load Balancer ARNã€‚


3. è·å– Listenersï¼ˆä¾‹å¦‚ç«¯å£ 443 å’Œ 9996ï¼‰ã€‚


4. æ‰¾å‡ºç›‘å¬ 9996 çš„ Listenerã€‚


5. æ‰¾åˆ°å¯¹åº”çš„ Target Groupã€‚


6. æ‰§è¡Œ deregister â†’ ç­‰å¾… â†’ register æ“ä½œã€‚




---

âœ… è„šæœ¬ç›®æ ‡ï¼šä» Kubernetes Service â†’ æ“ä½œç›‘å¬ 9996 çš„ Target Group


---

âœ… æ­¥éª¤æ‹†è§£ + Shell è„šæœ¬

#!/bin/bash

set -e

# âš™ï¸ é…ç½®é¡¹
NAMESPACE="your-namespace"
SERVICE_NAME="your-service-name"
PORT="9996"
WAIT_SECONDS=60

echo "ğŸ” Step 1: è·å– NLB DNS å..."
NLB_DNS=$(kubectl get svc "$SERVICE_NAME" -n "$NAMESPACE" -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')

if [ -z "$NLB_DNS" ]; then
    echo "âŒ æœªè·å–åˆ° NLB DNSã€‚æ£€æŸ¥æœåŠ¡æ˜¯å¦ä¸º type=LoadBalancer"
    exit 1
fi

echo "âœ… NLB DNS: $NLB_DNS"

# Step 2: æ‰¾åˆ° Load Balancer ARN
echo "ğŸ” Step 2: æŸ¥æ‰¾ Load Balancer ARN..."
LB_ARN=$(aws elbv2 describe-load-balancers \
    --query "LoadBalancers[?DNSName=='$NLB_DNS'].LoadBalancerArn" \
    --output text)

if [ -z "$LB_ARN" ]; then
    echo "âŒ æœªæ‰¾åˆ°åŒ¹é…çš„ Load Balancer ARN"
    exit 1
fi

echo "âœ… Load Balancer ARN: $LB_ARN"

# Step 3: æŸ¥æ‰¾ç›‘å¬ç«¯å£ä¸º 9996 çš„ Listener
echo "ğŸ” Step 3: æŸ¥æ‰¾ Listener (ç«¯å£ $PORT)..."
LISTENERS=$(aws elbv2 describe-listeners --load-balancer-arn "$LB_ARN")
LISTENER_ARN=$(echo "$LISTENERS" | jq -r ".Listeners[] | select(.Port==$PORT) | .ListenerArn")

if [ -z "$LISTENER_ARN" ]; then
    echo "âŒ æœªæ‰¾åˆ°ç«¯å£ $PORT çš„ Listener"
    exit 1
fi

echo "âœ… Listener ARN: $LISTENER_ARN"

# Step 4: è·å–ç›®æ ‡ Target Group ARN
echo "ğŸ” Step 4: è·å– Target Group ARN..."
TG_ARN=$(echo "$LISTENERS" | jq -r ".Listeners[] | select(.Port==$PORT) | .DefaultActions[0].TargetGroupArn")

if [ -z "$TG_ARN" ]; then
    echo "âŒ æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„ Target Group"
    exit 1
fi

echo "âœ… Target Group ARN: $TG_ARN"

# Step 5: è·å– Targets
echo "ğŸ” Step 5: è·å–å½“å‰æ³¨å†Œ Targets..."
TARGETS=$(aws elbv2 describe-target-health \
    --target-group-arn "$TG_ARN" \
    --query "TargetHealthDescriptions[*].Target.Id" \
    --output text)

if [ -z "$TARGETS" ]; then
    echo "âš ï¸ æ²¡æœ‰å·²æ³¨å†Œçš„ Targets"
    exit 1
fi

echo "âœ… å½“å‰ Targets: $TARGETS"

# æ„å»º --targets å‚æ•°
TARGET_ARGS=$(for id in $TARGETS; do echo -n "Id=$id "; done)

# Step 6: Deregister
echo "ğŸ›‘ Step 6: Deregister targets..."
aws elbv2 deregister-targets --target-group-arn "$TG_ARN" --targets $TARGET_ARGS

# Step 7: ç­‰å¾…
echo "â±ï¸ ç­‰å¾… $WAIT_SECONDS ç§’..."
sleep $WAIT_SECONDS

# Step 8: Register again
echo "âœ… Step 8: Register targets again..."
aws elbv2 register-targets --target-group-arn "$TG_ARN" --targets $TARGET_ARGS

echo "ğŸ‰ å®Œæˆ"


---

âœ… ä¾èµ–å·¥å…·

aws cli

kubectl

jqï¼ˆç”¨äºè§£æ JSONï¼‰



---

ğŸ§  é™„åŠ è¯´æ˜

ä½ å¯ä»¥æ”¹é€ æ­¤è„šæœ¬ï¼ŒåŠ å…¥ kubectl get svc çš„ label selectorï¼Œæ‰¹é‡å¤„ç†æœåŠ¡ã€‚

å¦‚æœ target æ˜¯ IP ç±»å‹ï¼ˆä¸æ˜¯ EC2 å®ä¾‹ IDï¼‰ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Target.Id å’Œ Target.Port è·å–å¹¶æ„å»º target å‚æ•°ã€‚



---

æ˜¯å¦éœ€è¦æˆ‘ä¸º IP æ¨¡å¼ï¼ˆå¦‚ NLB-IP æ¨¡å¼ Serviceï¼‰å†™ä¸€ä¸ªç‰ˆæœ¬ï¼Ÿæˆ–è€…ä½ å¸Œæœ›è¿™ä¸ªè„šæœ¬åšæˆ cron job æˆ–é›†æˆåˆ° FISï¼Ÿ

