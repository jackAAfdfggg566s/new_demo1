å¥½ï¼Œæ—¢ç„¶ä½ è¦ç”¨ sshpass æ¥å®ç° GitLab CI/CD è„šæœ¬ä¸­ï¼š

> âœ… é€šè¿‡è·³æ¿æœº SSHï¼ˆä½¿ç”¨ç”¨æˆ·å + å¯†ç  è€Œä¸æ˜¯ç§é’¥ï¼‰ï¼Œ
âœ… ç™»å½•åæ‰§è¡Œ psql æŸ¥è¯¢æ•°æ®åº“ï¼Œ
âœ… å¹¶å°†æŸ¥è¯¢ç»“æœæ‰“å°åˆ°æ§åˆ¶å°å¹¶å†™å…¥æ—¥å¿—æ–‡ä»¶ã€‚



ä¸‹é¢æ˜¯å®Œæ•´çš„åšæ³•ğŸ‘‡


---

âœ… GitLab CI/CD ç¤ºä¾‹ï¼ˆä½¿ç”¨ sshpass ç™»å½•è·³æ¿æœºå¹¶æ‰§è¡Œ psqlï¼‰

query_via_bastion:
  stage: query
  image: alpine:latest
  before_script:
    - apk add --no-cache sshpass openssh
  script:
    - mkdir -p logs

    # æ‰§è¡Œè¿œç¨‹ SSHï¼Œè¿è¡Œ psql æŸ¥è¯¢ï¼Œå¹¶ tee åˆ°æ—¥å¿—æ–‡ä»¶
    - |
      sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no $SSH_USER@$BASTION_HOST << EOF | tee logs/db_query.log
        export PGPASSWORD="$PG_PASSWORD"
        psql -h $PG_HOST -U $PG_USER -d $PG_DB -c "SELECT * FROM your_table LIMIT 10;"
EOF

  artifacts:
    paths:
      - logs/db_query.log
    when: always
    expire_in: 7 days


---

âœ… ä½ éœ€è¦åœ¨ GitLab CI/CD â†’ Settings â†’ Variables è®¾ç½®ä»¥ä¸‹å˜é‡ï¼š

å˜é‡å	ç”¨é€”

SSH_USER	è·³æ¿æœºç”¨æˆ·åï¼Œä¾‹å¦‚ ec2-userã€ubuntu
SSH_PASSWORD	è·³æ¿æœºç™»å½•å¯†ç ï¼ˆæ˜æ–‡å­˜å‚¨åœ¨ CI Variable ä¸­ï¼Œæ³¨æ„æƒé™ï¼ï¼‰
BASTION_HOST	è·³æ¿æœºå…¬ç½‘ IP æˆ– DNS
PG_HOST	æ•°æ®åº“åœ°å€ï¼ˆä»è·³æ¿æœºèƒ½è®¿é—®ï¼Œæ¯”å¦‚å†…ç½‘ IPï¼‰
PG_USER	PostgreSQL ç”¨æˆ·å
PG_PASSWORD	PostgreSQL å¯†ç 
PG_DB	PostgreSQL æ•°æ®åº“å



---

âœ… æ•ˆæœè¯´æ˜ï¼š

sshpass å®ç°è·³æ¿æœºå…äº¤äº’ SSH ç™»å½•ï¼›

psql æŸ¥è¯¢æ‰§è¡Œåï¼Œç»“æœé€šè¿‡ tee æ‰“å° + ä¿å­˜ï¼›

æŸ¥è¯¢ç»“æœæ—¥å¿—æ–‡ä»¶ logs/db_query.log å¯ä» GitLab é¡µé¢ä¸‹è½½ï¼ˆartifactsï¼‰ã€‚



---

ğŸ” å®‰å…¨æé†’ï¼š

sshpass ä¼šåœ¨å‘½ä»¤è¡Œä¸­æ˜æ–‡æš´éœ²å¯†ç ï¼Œä¸å»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒï¼›

æ›´æ¨èæ”¹ä¸ºä½¿ç”¨ SSH key ç™»å½•ï¼Œå®‰å…¨æ€§é«˜å¾—å¤šï¼›

å¦‚æœä¸€å®šè¦ç”¨å¯†ç ï¼Œç¡®ä¿ GitLab CI çš„å˜é‡æ˜¯ Masked + Protectedã€‚



---

æ˜¯å¦éœ€è¦æ”¯æŒå¤šè¡Œ SQL è„šæœ¬ï¼Ÿæˆ–è€…è¿œç¨‹æ‰§è¡Œ bash è„šæœ¬ï¼Ÿå¯ä»¥ç»§ç»­æ‰©å±•è¿™ä¸ªç»“æ„ã€‚éœ€è¦æˆ‘å†™ä¸€ä¸ªæ”¯æŒ .sql æ–‡ä»¶ä¸Šä¼ æ‰§è¡Œçš„ç‰ˆæœ¬å—ï¼Ÿ

