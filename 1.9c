å¥½ï¼Œä¸‹é¢ç»™ä½ ä¸€ä¸ª å¯ä»¥ç›´æ¥é€šè¿‡æ ¡éªŒçš„ã€Œå®Œæ•´ FIS Experiment Template JSONã€ï¼Œ
åœºæ™¯æ˜¯æˆ‘ä»¬å‰é¢åå¤ç¡®è®¤è¿‡çš„ï¼š
æ¨¡æ‹ŸæŸä¸€ä¸ª AZï¼ˆå¦‚ ap-southeast-2aï¼‰é‡Œï¼ŒæŸä¸ª EKS é›†ç¾¤çš„æ‰€æœ‰ node å…¨éƒ¨ä¸å¯ç”¨ï¼ˆçœŸå® AZ æ•…éšœï¼‰
æˆ‘ç”¨çš„æ˜¯ Terminate EC2 instanceï¼ˆæœ€å¸¸è§ã€æœ€å¥½ç†è§£ï¼‰ã€‚
âœ… å®Œæ•´å¯ç”¨ FIS Templateï¼ˆAZ æ•…éšœï¼‰
âš ï¸ ä½ åªéœ€è¦æ”¹ 3 ä¸ªåœ°æ–¹ï¼š
ap-southeast-2a
my-eks-cluster
IAM role ARN
å¤åˆ¶ä»£ç 
Json
{
  "description": "Simulate AZ outage by terminating all EKS nodes in ap-southeast-2a",
  "roleArn": "arn:aws:iam::123456789012:role/FISExperimentRole",
  "stopConditions": [
    {
      "source": "none"
    }
  ],
  "targets": {
    "EksNodesInAz2a": {
      "resourceType": "aws:ec2:instance",
      "selectionMode": "ALL",
      "filters": [
        {
          "path": "Placement.AvailabilityZone",
          "values": ["ap-southeast-2a"]
        },
        {
          "path": "State.Name",
          "values": ["running"]
        },
        {
          "path": "tag:eks:cluster-name",
          "values": ["my-eks-cluster"]
        }
      ]
    }
  },
  "actions": {
    "TerminateEksNodesInAz2a": {
      "actionId": "aws:ec2:terminate-instances",
      "description": "Terminate all EKS worker nodes in ap-southeast-2a",
      "parameters": {},
      "targets": {
        "Instances": "EksNodesInAz2a"
      }
    }
  }
}
âœ… è¿™ä¸ª JSON ä¸ºä»€ä¹ˆä¸€å®šèƒ½è¿‡æ ¡éªŒ
é€æ¡å¯¹ä½ ç°åœ¨é‡åˆ°çš„å‘ï¼š
âœ… values æœ‰ä¸­æ‹¬å· []
âœ… æ²¡æœ‰ {}
âœ… æ²¡ç”¨ resourceArnsï¼ˆé¿å¼€ 5 ä¸ªé™åˆ¶ï¼‰
âœ… åŒ…å« tag filterï¼ˆtag:eks:cluster-nameï¼‰
âœ… target â†’ action æ­£ç¡®å¼•ç”¨
âœ… selectionMode: ALL
âœ… åªå½±å“ æŒ‡å®š AZ + æŒ‡å®š EKS é›†ç¾¤
ğŸ” å¦‚æœä½ æƒ³éªŒè¯ã€Œä¸æå‰åˆ›å»º FISï¼Œä¹Ÿèƒ½ç¡®è®¤ä¼šé€‰ä¸­å“ªäº›å®ä¾‹ã€
ä½ å¯ä»¥ç”¨ EC2 CLI ç­‰ä»·æ ¡éªŒï¼š
å¤åˆ¶ä»£ç 
Bash
aws ec2 describe-instances \
  --filters \
    "Name=availability-zone,Values=ap-southeast-2a" \
    "Name=instance-state-name,Values=running" \
    "Name=tag:eks:cluster-name,Values=my-eks-cluster" \
  --query 'Reservations[].Instances[].InstanceId'
è¿™é‡Œèƒ½è¿”å›çš„å®ä¾‹ = FIS ä¼š terminate çš„å®ä¾‹ã€‚
ğŸ” å¸¸è§å˜ä½“ï¼ˆä½ ä¹‹åä¸€å®šä¼šç”¨åˆ°ï¼‰
ğŸ”¹ å¦‚æœä½ è¦åšã€Œnodegroup æ•…éšœï¼ˆä¸æ˜¯ AZï¼‰ã€
åªè¦ å¤šåŠ ä¸€è¡Œ filterï¼š
å¤åˆ¶ä»£ç 
Json
{
  "path": "tag:eks:nodegroup-name",
  "values": ["ng-app"]
}
ğŸ”¹ å¦‚æœä½ æƒ³å‚æ•°åŒ– AZï¼ˆè„šæœ¬ç”Ÿæˆï¼‰
åªéœ€è¦æ›¿æ¢è¿™ä¸€è¡Œå³å¯ï¼š
å¤åˆ¶ä»£ç 
Json
"values": ["ap-southeast-2a"]
æœ€åä¸€è¡Œé‡ç‚¹æ€»ç»“ï¼ˆç»™ä½ å®šå‹ï¼‰
AZ æ•…éšœ FIS æ¨¡æ¿ = AZ + running + cluster tag + ALL
ä½ ç°åœ¨è¿™ä¸ª JSONï¼Œ
ğŸ‘‰ Console èƒ½è¿‡
ğŸ‘‰ CLI èƒ½å»º
ğŸ‘‰ è¡Œä¸ºå’ŒçœŸå® AZ æ•…éšœä¸€è‡´
å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ ï¼š
ğŸ”§ æ”¹æˆ jq / bash å‚æ•°åŒ–æ¨¡æ¿ï¼ˆAZ å½“å‚æ•°ä¼ ï¼‰
ğŸ§ª è®¾è®¡ AZ æ•…éšœ vs nodegroup æ•…éšœ ä¸¤å¥—æ¨¡æ¿
ğŸ” å¸®ä½ ç¡®è®¤ ASG / nodegroup / Pod çš„çœŸå®æ¢å¤è·¯å¾„
ä½ æ˜¯æ‰“ç®— å…ˆåœ¨ dev è·‘ä¸€æŠŠï¼Œè¿˜æ˜¯ å·²ç»åœ¨ prod æ¼”ç»ƒçª—å£é‡Œäº†ï¼Ÿ