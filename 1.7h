æ˜ç™½äº†ï¼Œä½ è¯´çš„æ˜¯ AWS FISï¼ˆFault Injection Simulatorï¼‰çš„ EBS Volume IO ç›¸å…³ actionï¼Œä¸æ˜¯å¿«ç…§ ğŸ‘
æˆ‘ç›´æ¥ç»™ä½ å‡†ç¡®åˆ° FIS action çº§åˆ«çš„ç­”æ¡ˆï¼Œå¹¶è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦è¿™äº›æƒé™ã€‚
ä¸€ã€FIS çš„ EBS Volume IO æ˜¯ä»€ä¹ˆ actionï¼Ÿ
çœŸå®åç§°æ˜¯è¿™ç±»ï¼ˆæ ¸å¿ƒï¼‰ğŸ‘‡
aws:ebs:pause-volume-io
ğŸ‘‰ æ¨¡æ‹Ÿ EBS IO hang / å¡æ­» / æ— å“åº”
ğŸ‘‰ é terminateã€é detachï¼Œæœ€æ¥è¿‘çœŸå®å­˜å‚¨æ•…éšœ
è¿™æ˜¯ç”Ÿäº§çº§åˆ«ç”¨æ¥éªŒè¯ï¼š
åº”ç”¨ IO è¶…æ—¶å¤„ç†
æ•°æ®åº“ / æ–‡ä»¶ç³»ç»Ÿå®¹é”™
EKS / EC2 å¯¹ IO stall çš„ååº”
äºŒã€è¿è¡Œè¿™ä¸ª FIS Experiment éœ€è¦çš„ IAM æƒé™ï¼ˆå…³é”®ï¼‰
1ï¸âƒ£ FIS Service Roleï¼ˆæœ€é‡è¦ï¼‰
è¿™æ˜¯ä½ åœ¨ FIS Experiment Template é‡ŒæŒ‡å®šçš„ role
ğŸ‘‰ ä¸æ˜¯ä½ è‡ªå·±çš„äººç±»ç”¨æˆ·
æœ€å°å¯ç”¨æƒé™ï¼ˆæ ¸å¿ƒï¼‰
å¤åˆ¶ä»£ç 
Json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "fis:StartExperiment",
        "fis:StopExperiment",
        "fis:GetExperiment",
        "fis:ListExperiments"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "ec2:DescribeInstances",
        "ec2:DescribeVolumes",
        "ec2:DescribeTags"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "ebs:PauseVolumeIO",
        "ebs:ResumeVolumeIO"
      ],
      "Resource": "*"
    }
  ]
}
ğŸ“Œ è¿™ä¸€æ®µæ˜¯å¾ˆå¤šäººå¡ä½çš„ç‚¹
ğŸ‘‰ æ²¡æœ‰ ebs:PauseVolumeIOï¼Œå®éªŒä¸€å®šå¤±è´¥
ğŸ‘‰ æŠ¥é”™é€šå¸¸æ˜¯ AccessDeniedException
ä¸‰ã€ä¸ºä»€ä¹ˆä¸æ˜¯ ec2:* ï¼Ÿ
âš ï¸ è¿™æ˜¯é‡ç‚¹ç†è§£ç‚¹ï¼ˆä½ ä¹‹å‰é—®å¾—éå¸¸ä¸“ä¸šï¼‰
EBS IO fault æ˜¯ EBS Control Plane
ä¸æ˜¯ EC2 API
æ‰€ä»¥æƒé™åœ¨ï¼š
âŒ ec2:*
âœ… ebs:*
ğŸ‘‰ å¾ˆå¤šäººåªç»™äº† EC2 æƒé™ï¼ŒFIS ä¼šç›´æ¥å¤±è´¥
å››ã€Trust Policyï¼ˆä¹Ÿéå¸¸å…³é”®ï¼‰
FIS role çš„ AssumeRole policy å¿…é¡»æ˜¯è¿™æ ·ï¼š
å¤åˆ¶ä»£ç 
Json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "fis.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
ğŸ‘‰ å°‘äº†è¿™æ®µï¼ŒExperiment æ ¹æœ¬èµ·ä¸æ¥
äº”ã€å¦‚æœä½ çš„ Volume æ˜¯åŠ å¯†çš„ï¼ˆKMSï¼‰
âš ï¸ å¾ˆå¤šç”Ÿäº§ç¯å¢ƒéƒ½ä¼šè¸©è¿™ä¸ªé›·
è¿˜éœ€è¦ KMS æƒé™ï¼ˆå¦åˆ™ Pause IO ä¼šå¤±è´¥ï¼‰ï¼š
å¤åˆ¶ä»£ç 
Json
{
  "Effect": "Allow",
  "Action": [
    "kms:DescribeKey",
    "kms:GenerateDataKey"
  ],
  "Resource": "<your-kms-key-arn>"
}
å…­ã€EKS + EBS CSI + FIS çš„çœŸå®å½±å“ï¼ˆç»“åˆä½ ä¹‹å‰çš„é—®é¢˜ï¼‰
å½“ä½ å¯¹ Node ä¸Šçš„ EBS volume æ‰§è¡Œ Pause IOï¼š
å±‚
çœŸå®è¡¨ç°
Linux
IO hangï¼Œä¸æŠ¥é”™
Pod
å¡åœ¨ read/write
Kubelet
Node å¯èƒ½ NotReady
Scheduler
Pod ä¸ä¼šç«‹åˆ»è¿ç§»
ASG
ä¸ä¸€å®šæ›¿æ¢å®ä¾‹
ğŸ‘‰ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ PauseVolumeIO æ¯” terminate instance æ›´ç‹ ã€æ›´çœŸå®
ä¸ƒã€å¸¸è§å¤±è´¥æŠ¥é”™ & å¯¹åº”åŸå› 
æŠ¥é”™
åŸå› 
AccessDenied ebs:PauseVolumeIO
IAM æƒé™æ²¡ç»™
Insufficient permissions
Role æ²¡è¢« FIS assume
Volume not found
AZ / Volume é€‰é”™
Experiment stuck running
æ²¡ Resume IO
å…«ã€ä½ ç°åœ¨è¿™ä¸ªåœºæ™¯ï¼Œæˆ‘çš„åˆ¤æ–­ï¼ˆç»“åˆä½ å‰é¢é—®çš„ï¼‰
ä½ æ˜¯åœ¨åšï¼š
AZ æ•…éšœ / å­˜å‚¨æ•…éšœæ¼”ç»ƒ
EKS / ASG ç¨³å®šæ€§éªŒè¯
ç”¨ FIS åš æ¯” terminate instance æ›´çœŸå®çš„æµ‹è¯•
ğŸ‘‰ é‚£ä½ è¿™ä¸ªæ–¹å‘æ˜¯å®Œå…¨æ­£ç¡®çš„ï¼Œå·²ç»æ˜¯ SRE / Production Readiness çº§åˆ«ç©æ³•ã€‚
å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ ï¼š
ğŸ”¹ å†™ä¸€ä¸ª æœ€å°æƒé™ FIS Roleï¼ˆæŒ‰ volume tag é™åˆ¶ï¼‰
ğŸ”¹ è®¾è®¡ AZ æ•…éšœ + EBS IO åŒé‡æ¼”ç»ƒæ–¹æ¡ˆ
ğŸ”¹ å¯¹æ¯” PauseVolumeIO vs DetachVolume vs Terminate
ä½ ç°åœ¨æ˜¯ EC2 åŸç”Ÿ è¿˜æ˜¯ EKS Node + PVCï¼Ÿ