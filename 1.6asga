å¥½ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ç»™ä½ ä¸€ä¸ªå¯ç”¨çš„ AWS FIS Experiment Template ç¤ºä¾‹ï¼Œä½¿ç”¨ä½ è¯´çš„ api-insufficient-instance-capacity-errorï¼Œå¹¶ä¸”åŒ…å« percentageï¼Œè€Œä¸”æˆ‘ä¼šé€æ®µè§£é‡Šä¸ºä»€ä¹ˆè¿™æ ·é…ï¼Œæ–¹ä¾¿ä½ ç›´æ¥è½åœ°æˆ–æ”¹ã€‚
åœºæ™¯å‡è®¾
ç›®æ ‡ï¼šæ¨¡æ‹ŸæŸ AZ å‡ºç°å®¹é‡ä¸è¶³
å½±å“å¯¹è±¡ï¼šéƒ¨åˆ† EC2 / ASGï¼ˆä¸æ˜¯ 100%ï¼‰
æ‰‹æ®µï¼šEC2 API å±‚ InsufficientInstanceCapacity
æ§åˆ¶ blast radiusï¼špercentage
ä¸€ã€æ ¸å¿ƒæ¦‚å¿µå…ˆå¯¹é½ï¼ˆå¾ˆé‡è¦ï¼‰
ğŸ”‘ è¿™ä¸ª action åˆ°åº•å¯¹è°â€œæŒ‰ç™¾åˆ†æ¯”â€ï¼Ÿ
percentage ä¸æ˜¯ AZ çš„ç™¾åˆ†æ¯”ï¼Œè€Œæ˜¯ï¼š
åœ¨ä½ é€‰ä¸­çš„ target èµ„æºé‡Œï¼Œéšæœºé€‰ X% æ³¨å…¥æ•…éšœ
æ‰€ä»¥ç»“æ„æ˜¯ï¼š
å¤åˆ¶ä»£ç 

Targetï¼ˆå…ˆåœˆèµ„æºï¼‰ â†’ percentageï¼ˆå†æŠ½æ ·ï¼‰ â†’ Actionï¼ˆæ³¨å…¥é”™è¯¯ï¼‰
äºŒã€å®Œæ•´ FIS Template ç¤ºä¾‹ï¼ˆJSONï¼‰
âœ… è¿™æ˜¯ å®˜æ–¹ schema å¯ç”¨çš„ç»“æ„ï¼ˆä½ å¯ä»¥ç›´æ¥åœ¨ Console / CLI ç”¨ï¼‰
å¤åˆ¶ä»£ç 
Json
{
  "description": "Simulate AZ capacity issue using EC2 API insufficient capacity error (50%)",
  "roleArn": "arn:aws:iam::123456789012:role/FISExperimentRole",
  "stopConditions": [
    {
      "source": "aws:cloudwatch:alarm",
      "value": "arn:aws:cloudwatch:ap-southeast-2:123456789012:alarm:High5xxError"
    }
  ],
  "targets": {
    "EC2CapacityTargets": {
      "resourceType": "aws:ec2:instance",
      "resourceTags": {
        "ChaosTest": "AZ-Outage"
      },
      "filters": [
        {
          "path": "Placement.AvailabilityZone",
          "values": ["ap-southeast-2a"]
        }
      ],
      "selectionMode": "PERCENT(50)"
    }
  },
  "actions": {
    "InjectInsufficientCapacity": {
      "actionId": "aws:ec2:api-insufficient-instance-capacity-error",
      "parameters": {
        "availabilityZone": "ap-southeast-2a",
        "instanceType": "m5.large",
        "duration": "PT10M"
      },
      "targets": {
        "Instances": "EC2CapacityTargets"
      }
    }
  }
}
ä¸‰ã€å…³é”®å­—æ®µé€æ¡è§£é‡Šï¼ˆåˆ«è·³è¿‡ï¼‰
1ï¸âƒ£ selectionMode: "PERCENT(50)" â­â­â­
å¤åˆ¶ä»£ç 
Json
"selectionMode": "PERCENT(50)"
å«ä¹‰ï¼š
åœ¨ ç¬¦åˆæ¡ä»¶çš„å®ä¾‹é›†åˆä¸­
éšæœºé€‰ 50%
åªå¯¹è¿™ 50% çš„ caller æ³¨å…¥ capacity error
ğŸ‘‰ è¿™æ˜¯ä½ è¦çš„ percentage æ§åˆ¶
2ï¸âƒ£ AZ è¿‡æ»¤ï¼ˆéå¸¸å…³é”®ï¼‰
å¤åˆ¶ä»£ç 
Json
"filters": [
  {
    "path": "Placement.AvailabilityZone",
    "values": ["ap-southeast-2a"]
  }
]
å¦åˆ™ä½ ä¼šï¼š
åœ¨å…¶ä»– AZ ä¹Ÿæ³¨å…¥ capacity error
ç›´æ¥å˜æˆåŒºåŸŸçº§äº‹æ•… ğŸ˜…
3ï¸âƒ£ ä¸ºä»€ä¹ˆ target ç”¨çš„æ˜¯ aws:ec2:instanceï¼Ÿ
å› ä¸ºè¿™ä¸ª API action çš„æœ¬è´¨æ˜¯ï¼š
å¯¹â€œè°ƒç”¨ EC2 API çš„èµ„æºèº«ä»½â€æ³¨å…¥é”™è¯¯
ASG / EKS çš„ EC2 è°ƒç”¨ï¼Œæœ€ç»ˆéƒ½æ˜ å°„åˆ°å®ä¾‹ / launch context
4ï¸âƒ£ duration
å¤åˆ¶ä»£ç 
Json
"duration": "PT10M"
å«ä¹‰ï¼š
10 åˆ†é’Ÿå†…ï¼š
æ‰€æœ‰ RunInstances
éƒ½ä¼šè¿”å› InsufficientInstanceCapacity
åˆ°æ—¶é—´ è‡ªåŠ¨æ¢å¤
å››ã€å¦‚æœä½ æ˜¯ ASG / EKSï¼ˆæ›´è´´è¿‘ä½ çœŸå®ç”¨æ³•ï¼‰
ğŸ” ASG åœºæ™¯ï¼ˆæ›´å¸¸è§ï¼‰
ä½ å¯ä»¥æŠŠ target æ¢æˆï¼š
å¤åˆ¶ä»£ç 
Json
"resourceType": "aws:autoscaling:autoScalingGroup",
"selectionMode": "PERCENT(50)"
ä½†æ³¨æ„ âš ï¸ï¼š
action ä»ç„¶æ˜¯ api-insufficient
percentage æ˜¯ ASG æ•°é‡çš„ç™¾åˆ†æ¯”
ä¸æ˜¯å®ä¾‹æ•°
äº”ã€ä¸€ä¸ªâ€œæ›´çœŸå® AZ æ•…éšœâ€çš„æ¨èç»„åˆ
åœ¨åŒä¸€ä¸ª template é‡Œä½ å¯ä»¥è¿™æ ·åšï¼ˆé¡ºåº actionï¼‰ï¼š
Action 1ï¼šapi-insufficient-instance-capacity-error
Action 2ï¼šaws:ec2:terminate-instances
è¿™æ ·å°±å®ç°äº†ä½ ä¹‹å‰è¯´çš„ï¼š
å®ä¾‹æ¶ˆå¤± + æ— æ³•é‡å»º
å…­ã€ä½ ä¸€å®šè¦æ³¨æ„çš„ 3 ä¸ªå‘ï¼ˆè¡€å‘ï¼‰
âš ï¸ 1. MixedInstancesPolicy
å¦‚æœ ASG ç”¨äº†å¤šä¸ª instance typeï¼š
ä½ å¿…é¡»ï¼š
è¦ä¹ˆ simulate å¤šä¸ª type
è¦ä¹ˆä¸´æ—¶ restrict
å¦åˆ™ ASG ä¼šâ€œæ¢é©¬ç”²â€æˆåŠŸå¯åŠ¨
âš ï¸ 2. selectionMode â‰  AZ ç™¾åˆ†æ¯”
å¾ˆå¤šäººè¯¯ä»¥ä¸ºï¼š
å¤åˆ¶ä»£ç 

PERCENT(50) = AZ ä¸€åŠå
âŒ å®é™…æ˜¯ï¼š
å¤åˆ¶ä»£ç 

ç›®æ ‡èµ„æºçš„ä¸€åŠè¢«é€‰ä¸­
âš ï¸ 3. æ²¡æœ‰ stop condition å¾ˆå±é™©
ä½ å·²ç»æ˜¯ç”Ÿäº§çº§æ€è·¯äº†ï¼Œä¸€å®šè¦åŠ ï¼š
å¤åˆ¶ä»£ç 
Json
"stopConditions"
ä¸ƒã€ä¸€å¥è¯æ€»ç»“ï¼ˆä½ å¯ä»¥ç›´æ¥å†™è¿› runbookï¼‰
**aws:ec2:api-insufficient-instance-capacity-error
AZ filter
selectionMode PERCENT
= å¯æ§ã€å¯å›æ»šã€æœ€æ¥è¿‘çœŸå® AZ æ•…éšœçš„æ¼”ç»ƒ**
å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥ï¼š
ğŸ”§ å¸®ä½  æŒ‰ä½ ç°åœ¨çš„ ASG / EKS å®é™…é…ç½®æ”¹æˆâ€œå®Œå…¨åŒ¹é…ç‰ˆâ€
ğŸ“‹ ç»™ä½ ä¸€ä¸ª ç”Ÿäº§å®¡æ‰¹ç”¨çš„ FIS Chaos æ¼”ç»ƒè¯´æ˜
ğŸ§ª å¸®ä½ æŠŠ Terminate + Insufficient ç»„åˆæˆä¸€ä¸ªå®Œæ•´ experiment
ä½ è¯´ç”¨çš„æ˜¯ ASG è¿˜æ˜¯ EKSï¼Œæˆ‘ç›´æ¥ç»™ä½ å®šåˆ¶ç‰ˆã€‚