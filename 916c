ğŸ‘Œ æ”¶åˆ°ï¼Œä½ è¿™ä¸ªæŠ¥é”™ï¼š

when calling GetResourceMetrics operation: AccessDeniedException

è¯´æ˜ Lambda åœ¨è°ƒç”¨ RDS Database Insights / Performance Insights API çš„æ—¶å€™ï¼ŒIAM æƒé™ä¸å¤Ÿã€‚


---

ğŸ“Œ æ ¸å¿ƒç‚¹

GetResourceMetrics æ˜¯ Performance Insights (PI) çš„ APIï¼Œè€Œä¸æ˜¯ Database Insights çš„æ™®é€š CloudWatch æŒ‡æ ‡ã€‚

è¿™ä¸ª API æƒé™åœ¨ AmazonRDSPerformanceInsightsFullAccess é‡Œé¢ã€‚



---

âœ… è§£å†³æ–¹æ³•

ä½ éœ€è¦åœ¨ Lambda æ‰§è¡Œè§’è‰²é‡ŒåŠ ä¸Šå¦‚ä¸‹æƒé™ï¼š

{
  "Effect": "Allow",
  "Action": [
    "pi:GetResourceMetrics",
    "pi:DescribeDimensionKeys",
    "pi:GetDimensionKeyDetails"
  ],
  "Resource": "*"
}


---

ğŸ”‘ æƒé™ç»„åˆå»ºè®®

Lambda æ‰§è¡Œè§’è‰²çš„ å®Œæ•´æƒé™ç­–ç•¥ è‡³å°‘è¦åŒ…å«ï¼š

{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "pi:GetResourceMetrics",
        "pi:DescribeDimensionKeys",
        "pi:GetDimensionKeyDetails",
        "rds:DescribeDBInstances",
        "cloudwatch:PutMetricData",
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "*"
    }
  ]
}


---

âš ï¸ é‡è¦æé†’

Database Insights æ§åˆ¶å°çœ‹åˆ°çš„ Top SQLï¼Œå…¶å®åº•å±‚å°±æ˜¯ç”¨çš„ Performance Insights API (pi:GetResourceMetrics)ã€‚

æ‰€ä»¥å¦‚æœä½ è¦è®© Lambda å– Top SQL æ•°æ®ï¼Œå¿…é¡»å¼€ Performance Insights æƒé™ï¼ˆå³ä½¿æ§åˆ¶å°å« Database Insightsï¼‰ã€‚

å¦‚æœä½ çš„ RDS æ²¡å¯ç”¨ Performance Insightsï¼Œè°ƒç”¨ GetResourceMetrics ä¹Ÿä¼šæŠ¥é”™ã€‚



---

è¦ä¸è¦æˆ‘ç»™ä½ å†™ä¸€ä¸ª Lambda æ ·ä¾‹ä»£ç  (Python boto3)ï¼Œç›´æ¥è°ƒç”¨ pi:GetResourceMetrics æ‹‰å–æŸä¸ª DB å®ä¾‹çš„ Top SQL latencyï¼Œç„¶åå†™åˆ° CloudWatch è‡ªå®šä¹‰æŒ‡æ ‡ï¼Ÿè¿™æ ·ä½ èƒ½å¯¹ç…§ IAM æƒé™ä¸€èµ·æµ‹è¯•ã€‚

