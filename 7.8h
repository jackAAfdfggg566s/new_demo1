å¤ªå¥½äº†ï¼Œäº†è§£æ›´æ¸…æ¥šäº†ï¼š


---

âœ… ä½ çš„å®Œæ•´ç›®æ ‡æ˜¯ï¼š

> åœ¨ GitLab CI/CD ä¸­ï¼Œè‡ªåŠ¨æ‰§è¡Œ 3 æ¬¡ Cycleï¼Œæ¯ä¸ª Cycle çš„æµç¨‹å¦‚ä¸‹ï¼š



1. State1ï¼ˆå¯åŠ¨ Java ç¨‹åºï¼‰ï¼šè¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œ


2. ç­‰å¾… 2 åˆ†é’Ÿæ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰ error

æœ‰é”™è¯¯ï¼šæ•´ä¸ª Pipeline å¤±è´¥é€€å‡º



3. State2ï¼ˆè°ƒç”¨ AWS FISï¼‰ï¼š

è¿™æ˜¯ å·²æœ‰çš„å¦ä¸€ä¸ª GitLab Job / Pipeline

ä½¿ç”¨ä¸åŒçš„ imageï¼Œæ¯”å¦‚ AWS CLI ç¯å¢ƒ



4. æŒç»­ç›‘æ§ Java ç¨‹åºæ—¥å¿—ï¼Œç›´åˆ°ç»“æŸï¼ˆæœ€å¤š 1 å°æ—¶ï¼‰

ä¸­é€”å‘ç° error â†’ å¤±è´¥é€€å‡º



5. State3ï¼ˆå·²æœ‰ Jobï¼‰ï¼šæ£€æŸ¥æœ€ç»ˆçŠ¶æ€æˆ–éªŒè¯ç»“æœ




---

âœ… å»ºè®®çš„ GitLab CI/CD å¤š Job å¤š Stage å®ç°æ–¹å¼ï¼š

æˆ‘ä»¬æŠŠæ¯ä¸ª Cycle æ‹†åˆ†æˆå¤šä¸ª Jobï¼Œæ¯ä¸ª Job åšä¸€ä»¶äº‹ï¼Œç”¨ needs: æ¥é¡ºåºæ§åˆ¶æ‰§è¡Œï¼Œå¹¶é€šè¿‡ artifacts ä¼ é€’çŠ¶æ€ï¼ˆæ¯”å¦‚æ—¥å¿—ã€PID æ–‡ä»¶ï¼‰ã€‚

ä½ æåˆ° State2/State3 å·²æ˜¯ç°æˆ pipeline/jobï¼Œæˆ‘ä»¬å°±è®©ä¸» Job è°ƒç”¨è¿™äº›å­ pipelineï¼ˆæˆ– includeï¼‰æˆ–ç›´æ¥ç”¨ trigger:ã€‚


---

âœ… æ ·ä¾‹ç»“æ„ï¼šæ‰§è¡Œä¸€ä¸ª Cycleï¼ˆå¯å¤ç”¨3æ¬¡ï¼‰

stages:
  - start-java
  - wait-check
  - fis
  - monitor
  - validate

variables:
  REMOTE_LOG: "/home/youruser/app/output.log"
  REMOTE_HOST: "your.remote.host"
  SSH_USER: "ec2-user"

start_java:
  stage: start-java
  script:
    - sshpass -p "$SSH_PASSWORD" ssh $SSH_USER@$REMOTE_HOST "
        cd /home/youruser/app &&
        : > $REMOTE_LOG &&
        nohup java -jar myapp.jar > $REMOTE_LOG 2>&1 &
        echo \$! > java.pid
      "
  artifacts:
    paths: [java.pid]

wait_and_check:
  stage: wait-check
  needs: [start_java]
  script:
    - |
      sshpass -p "$SSH_PASSWORD" ssh $SSH_USER@$REMOTE_HOST bash <<'EOS'
        LOG="$REMOTE_LOG"
        for i in {1..24}; do  # 2åˆ†é’Ÿå†…æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
          echo "Checking for error..."
          grep -iq "error" "$LOG" && {
            echo "âŒ Detected error in log."
            exit 1
          }
          sleep 5
        done
        echo "âœ… No error found after 2 minutes."
      EOS

call_fis:
  stage: fis
  needs: [wait_and_check]
  image: amazon/aws-cli
  script:
    - aws fis start-experiment --cli-input-json file://fis-experiment.json
    # æˆ–è€…ä½ ç”¨ trigger è°ƒç”¨å·²æœ‰ pipeline/job

monitor_java:
  stage: monitor
  needs: [call_fis]
  script:
    - |
      sshpass -p "$SSH_PASSWORD" ssh $SSH_USER@$REMOTE_HOST bash <<'EOS'
        LOG="$REMOTE_LOG"
        PID=$(cat java.pid)
        MAX_SECS=3600
        START=$(date +%s)

        while kill -0 $PID 2>/dev/null; do
          grep -iq "error" "$LOG" && {
            echo "âŒ Detected error mid-run"
            kill $PID
            exit 1
          }
          NOW=$(date +%s)
          if [ $((NOW - START)) -gt $MAX_SECS ]; then
            echo "â° Timeout"
            kill $PID
            exit 1
          fi
          sleep 10
        done

        echo "âœ… Java finished"
      EOS

check_state3:
  stage: validate
  needs: [monitor_java]
  script:
    - echo "ğŸ¯ Run your existing State3 check here"


---

âœ… é‡å¤ Cycleï¼ˆæ–¹å¼é€‰æ‹©ï¼‰

å¦‚æœä½ è¦è‡ªåŠ¨é‡å¤ 3 æ¬¡ï¼Œå¯ä»¥ï¼š

âœ… æ–¹å¼ä¸€ï¼šè°ƒç”¨åŒä¸€ä¸ª child pipeline å¤šæ¬¡ï¼ˆæ¨èï¼‰

ç”¨ trigger: è§¦å‘è‡ªå·±å®šä¹‰çš„ cycle pipelineï¼š

run_cycle1:
  stage: control
  trigger:
    include: .gitlab/cycle.yml
    strategy: depend

run_cycle2:
  stage: control
  trigger:
    include: .gitlab/cycle.yml
    strategy: depend

run_cycle3:
  stage: control
  trigger:
    include: .gitlab/cycle.yml
    strategy: depend

æˆ–è€…åœ¨å¾ªç¯ä¸­è°ƒç”¨ REST API é‡å¤è§¦å‘ child pipelineã€‚


---

ğŸ§  ä¼˜åŠ¿ï¼š

å¤š stage/job æ‹†åˆ†æ¸…æ™°ã€æ˜“äº debug

å¯ç›‘æ§æ¯ä¸ªç¯èŠ‚çŠ¶æ€

å…¼å®¹ä½ å·²æœ‰çš„ State2 (FIS) å’Œ State3 job

æ”¯æŒé€šè¿‡ artifacts/å˜é‡ä¼ é€’ä¸­é—´çŠ¶æ€ï¼ˆå¦‚ PIDã€æ—¥å¿—ï¼‰



---

âœ… ä½ å¯ä»¥å‘Šè¯‰æˆ‘ï¼š

State2ï¼ˆFISï¼‰ æ˜¯ job è¿˜æ˜¯ pipelineï¼Ÿ

State3 æ˜¯ job è¿˜æ˜¯å¯ä»¥å°è£…ï¼Ÿ

æ˜¯å¦å¸Œæœ›æˆ‘å¸®ä½ å‡ºå®Œæ•´ .gitlab-ci.yml + .gitlab/cycle.ymlï¼Ÿ

ä½  Java æ˜¯ä¸æ˜¯æ¯æ¬¡éƒ½åœ¨è¿œç¨‹å›ºå®šç›®å½•è·‘ï¼Ÿæ—¥å¿—æ˜¯å¦å”¯ä¸€ï¼Ÿ


æˆ‘å¯ä»¥ç»™ä½ ä¸€å¥—å®Œæ•´ä¸‰è½®è‡ªåŠ¨æ‰§è¡Œçš„ GitLab æ–¹æ¡ˆã€‚ä½ åªè¦è¡¥å……ä¸€ç‚¹ç‚¹ä¿¡æ¯ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ

