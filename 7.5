ä½ æƒ³è¦åœ¨ GitLab CI/CD ä¸­æ‰§è¡Œä¸€ä¸ªæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š

1. å¯åŠ¨ Java åº”ç”¨ï¼ˆåå°è¿è¡Œï¼‰ï¼›


2. å®æ—¶ç›‘æ§ output.logï¼ŒæŒç»­å‡ åˆ†é’Ÿï¼›


3. å¦‚æœ log ä¸­å‡ºç°æŠ¥é”™ï¼ˆå…³é”®å­—å¦‚ Exceptionã€ERRORï¼‰ï¼ŒCI æŠ¥é”™é€€å‡ºï¼›


4. å¦‚æœ log ä¸€åˆ‡æ­£å¸¸ï¼Œè¿›å…¥ä¸‹ä¸€ä¸ª stageã€‚




---

âœ… å®ç°æ€è·¯ï¼ˆBash + GitLab CIï¼‰

æˆ‘ä»¬ç”¨ä¸€ä¸ª Job æ¥ï¼š

å¯åŠ¨ Java ç¨‹åºï¼›

tail æ—¥å¿—ï¼›

è¶…æ—¶è‡ªåŠ¨ç»§ç»­ï¼›

æ•æ‰å¼‚å¸¸è‡ªåŠ¨ failã€‚



---

ğŸ§© å‡è®¾å‡†å¤‡ç¯å¢ƒ

å¯åŠ¨å‘½ä»¤ä¸ºï¼šjava -jar myapp.jar > output.log 2>&1 &

log æ–‡ä»¶è·¯å¾„ï¼šoutput.log

ç›‘æ§æ—¶é—´ï¼šæ¯”å¦‚ 3 åˆ†é’Ÿ



---

âœ… ç¤ºä¾‹ GitLab CI Job

check_java_log:
  stage: check_log
  script:
    # å¯åŠ¨ Java åº”ç”¨ï¼ˆåå°è¿è¡Œï¼‰
    - nohup java -jar myapp.jar > output.log 2>&1 &

    # ç­‰å¾…åº”ç”¨åˆå§‹å¯åŠ¨
    - echo "Waiting for Java app to start..."
    - sleep 10

    # å®æ—¶ç›‘æ§æ—¥å¿— 3 åˆ†é’Ÿï¼Œè‹¥å‡ºç°é”™è¯¯ç«‹å³é€€å‡º
    - |
      echo "Checking logs for 3 minutes..."
      timeout 180 bash -c '
        tail -n 0 -F output.log | while read line; do
          echo "$line" | grep -Ei "Exception|ERROR" && exit 1
        done
      '

    # ä¸Šé¢è¶…æ—¶åä¼šç»§ç»­åˆ°è¿™é‡Œï¼ˆè¯´æ˜æ²¡å‘ç°æŠ¥é”™ï¼‰
    - echo "No error found in log, proceeding..."


---

ğŸ§  è¯´æ˜ï¼š

timeout 180ï¼šåªæ£€æŸ¥ 3 åˆ†é’Ÿï¼›

tail -Fï¼šå®æ—¶ç›‘å¬æ–°å†™å…¥çš„å†…å®¹ï¼›

grep -Ei "Exception|ERROR"ï¼šå¤§å°å†™åŒ¹é…å¸¸è§é”™è¯¯å…³é”®è¯ï¼›

ä¸€æ—¦å‘ç°å¼‚å¸¸ï¼Œexit 1ï¼ŒGitLab job ä¼šä¸­æ–­å¹¶æ ‡è®°å¤±è´¥ï¼›

æ²¡æœ‰é—®é¢˜å°±è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€ stageã€‚



---

âœ… è¡”æ¥ä¸‹ä¸€ä¸ª Jobï¼ˆç¤ºæ„ï¼‰

check_java_log:
  stage: check_log
  script:
    # ...å¦‚ä¸Š

run_next_stage:
  stage: run_next
  script:
    - echo "Next stage: everything OK"
  needs:
    - job: check_java_log
      artifacts: false


---

âœ… å¯é€‰å¢å¼ºåŠŸèƒ½ï¼ˆå¦‚ä½ éœ€è¦ï¼‰

âœ… æŠŠé”™è¯¯ä¿¡æ¯å†™å…¥ error.log ä¾›åç»­æ’æŸ¥ï¼›

âœ… æ”¹ä¸º grep æŸäº›â€œæˆåŠŸå…³é”®å­—â€è€Œä¸æ˜¯é”™è¯¯ï¼›

âœ… å¦‚æœ Java æœ¬èº«ä¼š hang å¯é¢å¤–åŠ  watchdogã€‚



---

æ˜¯å¦è¦æˆ‘å¸®ä½ åšä¸€ä»½å®Œæ•´çš„ .gitlab-ci.yml ä¾‹å­æˆ–åŠ  SSH åˆ°è¿œç«¯æ‰§è¡Œï¼ˆæ¯”å¦‚ä½ ä¹‹å‰æåˆ°çš„åœºæ™¯ï¼‰ï¼Ÿ

