å¥½ ğŸ‘ æˆ‘è¯¦ç»†å¸®ä½ æ‹†è§£ä¸€ä¸‹ æ–¹æ³• 2ï¼ˆLambda + PI API + è‡ªå®šä¹‰ CloudWatch Metricsï¼‰ï¼Œè¿™æ ·ä½ å°±èƒ½æŠŠ RDS Database Insightsï¼ˆPerformance Insights, PIï¼‰çš„æ•°æ®å±•ç¤ºåœ¨ CloudWatch å¤§ç›˜é‡Œã€‚


---

ğŸ›  æ–¹æ³• 2ï¼šLambda å®šæ—¶ä»»åŠ¡

æ ¸å¿ƒæ€è·¯ï¼š

1. Lambda å®šæ—¶è¿è¡Œï¼ˆç”¨ CloudWatch Event Ruleï¼Œæ¯ 5 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼‰ã€‚


2. è°ƒç”¨ Performance Insights APIï¼ˆpi.getResourceMetricsï¼‰ã€‚


3. å–å‡ºè´Ÿè½½æ•°æ®ï¼ˆä¾‹å¦‚ db.load.avg æˆ– SQL ç­‰çº§è´Ÿè½½ï¼‰ã€‚


4. å†™å…¥ CloudWatch è‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆcloudwatch.putMetricDataï¼Œå‘½åç©ºé—´ Custom/RDSPIï¼‰ã€‚


5. åœ¨ CloudWatch Dashboard é€‰æ‹© Custom/RDSPI â†’ åŠ å›¾è¡¨ã€‚




---

1ï¸âƒ£ æƒé™å‡†å¤‡

Lambda æ‰§è¡Œè§’è‰²éœ€è¦æœ‰ï¼š

{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "pi:GetResourceMetrics",
        "cloudwatch:PutMetricData"
      ],
      "Resource": "*"
    }
  ]
}


---

2ï¸âƒ£ Python Lambda ç¤ºä¾‹ä»£ç 

import boto3
import datetime

# åˆ›å»ºå®¢æˆ·ç«¯
pi = boto3.client('pi')
cw = boto3.client('cloudwatch')

# RDS é…ç½®
DB_ARN = "arn:aws:rds:ap-southeast-2:123456789012:db:mydb"  # æ›¿æ¢ä½ çš„ RDS ARN
DB_IDENTIFIER = "mydb"  # æ•°æ®åº“åå­—
REGION = "ap-southeast-2"

def lambda_handler(event, context):
    # è·å–å½“å‰æ—¶é—´ -5 åˆ†é’Ÿåˆ°ç°åœ¨
    end_time = datetime.datetime.utcnow()
    start_time = end_time - datetime.timedelta(minutes=5)

    # è°ƒç”¨ Performance Insights API
    response = pi.get_resource_metrics(
        ServiceType='RDS',
        Identifier=DB_ARN,
        MetricQueries=[{'Metric': 'db.load.avg'}],
        StartTime=start_time,
        EndTime=end_time,
        PeriodInSeconds=60
    )

    # æå–æ•°æ®ç‚¹
    for metric in response['MetricList']:
        for point in metric['DataPoints']:
            timestamp = point['Timestamp']
            value = point['Value']

            # å†™å…¥ CloudWatch è‡ªå®šä¹‰æŒ‡æ ‡
            cw.put_metric_data(
                Namespace='Custom/RDSPI',
                MetricData=[
                    {
                        'MetricName': 'DBLoadAvg',
                        'Dimensions': [
                            {'Name': 'DBInstanceIdentifier', 'Value': DB_IDENTIFIER}
                        ],
                        'Timestamp': timestamp,
                        'Value': value,
                        'Unit': 'Count'
                    }
                ]
            )

    return {"status": "success"}


---

3ï¸âƒ£ CloudWatch Dashboard å±•ç¤º

1. æ‰“å¼€ CloudWatch â†’ Dashboards â†’ Create dashboardã€‚


2. Add widget â†’ é€‰æ‹© Metricsã€‚


3. å‘½åç©ºé—´é€‰æ‹©ï¼šCustom/RDSPIã€‚


4. æ·»åŠ  DBLoadAvg â†’ å³å¯åœ¨å¤§ç›˜ä¸Šçœ‹åˆ° RDS Database Insights çš„è´Ÿè½½æ›²çº¿ã€‚




---

4ï¸âƒ£ å¯æ‰©å±•ç‚¹

ä½ å¯ä»¥æŠŠ db.load.avg æ¢æˆå…¶ä»– Performance Insights æŒ‡æ ‡ï¼š

db.load.avg â†’ æ€»è´Ÿè½½

db.load.avg + Dimension (ä¾‹å¦‚ db.sql.id) â†’ Top SQL çº§åˆ«çš„è´Ÿè½½


ä¹Ÿå¯ä»¥æŒ‰ ä¸åŒ SQL æˆ–ç”¨æˆ· æ‰“æ ‡ç­¾ï¼Œå†™å…¥ CloudWatch ç»´åº¦ã€‚

æœ€ç»ˆï¼Œä½ çš„å¤§ç›˜å¯ä»¥åšåˆ°ç±»ä¼¼ RDS Insights çš„ Top SQL / Load Trendã€‚



---

âš¡ è¿™æ ·ä½ å°±èƒ½æŠŠ RDS Insights çš„æ ¸å¿ƒæ•°æ®æ”¾åˆ° CloudWatch Dashboardï¼Œç»Ÿä¸€å’Œå…¶ä»– AWS ç›‘æ§ä¸€èµ·å±•ç¤ºäº†ã€‚

è¦ä¸è¦æˆ‘å¸®ä½ æ‰©å±•ä¸€ä¸‹ï¼ŒæŠŠ Top N SQL æŸ¥è¯¢è´Ÿè½½ï¼ˆæ¯”å¦‚å‰ 5 ä¸ª SQLï¼‰ä¹Ÿæ¨åˆ° CloudWatchï¼Œæ–¹ä¾¿ä½ åœ¨å¤§ç›˜çœ‹åˆ°å“ªæ¡ SQL å ç”¨èµ„æºæœ€å¤šï¼Ÿ

