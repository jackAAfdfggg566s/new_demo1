è¦æŸ¥çœ‹ AWS ALBï¼ˆApplication Load Balancerï¼‰åœ¨ EKS Pod æ•…éšœåˆ‡æ¢ï¼ˆfailoverï¼‰æ—¶çš„å“åº”æ—¶é—´ï¼Œå¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªè§’åº¦è¿›è¡Œåˆ†æï¼š


---

âœ… æ ¸å¿ƒç›®æ ‡ï¼š

> æŸ¥çœ‹ Pod æ•…éšœåæ–° Pod Readyï¼Œåˆ° ALB å¥åº·æ£€æŸ¥è¯†åˆ«æ–° Pod å¹¶è½¬å‘æµé‡çš„è¿™æ®µè€—æ—¶ã€‚




---

ğŸ” åˆ†æè·¯å¾„

1. ALB å¥åº·æ£€æŸ¥æ—¥å¿—ï¼ˆæ¨èï¼‰

å¦‚æœä½ å¯ç”¨äº† ALB çš„è®¿é—®æ—¥å¿—ï¼ˆAccess Logsï¼‰ï¼Œä½ å¯ä»¥ï¼š

æŸ¥çœ‹æŸä¸ª targetï¼ˆpodï¼‰çš„å¥åº·æ£€æŸ¥æƒ…å†µï¼›

é€šè¿‡ target: unhealthy â†’ healthy çš„æ—¶é—´å·®ï¼Œåˆ¤æ–­ ALB åˆ‡æ¢ç”¨äº†å¤šä¹…ã€‚


æ“ä½œæ­¥éª¤ï¼š

1. ç¡®ä¿å·²å¯ç”¨ ALB çš„è®¿é—®æ—¥å¿—ï¼Œä½ç½®åœ¨ï¼š

EC2 > Load Balancer > Attributes > Enable Access Logs

ä¿å­˜åˆ° S3 bucketã€‚



2. åˆ†ææ—¥å¿—ä¸­å¦‚ä¸‹å­—æ®µï¼š

elb_status_code, target_status_code, target:port, received_bytes, sent_bytes, ...


3. æ‰¾å‡ºæŸä¸ª Pod IP ç«¯å£åœ¨æŸä¸ªæ—¶é—´ç‚¹ç”± target_status_code=0ï¼ˆå¤±è´¥ï¼‰å˜ä¸º 200ï¼ˆæˆåŠŸï¼‰çš„æ—¶é—´å·®ã€‚




---

2. CloudWatch Metricsï¼ˆç›´è§‚å¯è§†ï¼‰

ALB ä¼šåœ¨ CloudWatch è‡ªåŠ¨äº§ç”Ÿå¦‚ä¸‹æŒ‡æ ‡ï¼š

Metric åç§°	å«ä¹‰

TargetResponseTime	ç›®æ ‡å“åº”æ—¶é—´
HealthyHostCount	å¥åº·çš„ç›®æ ‡æ•°é‡
UnHealthyHostCount	ä¸å¥åº·çš„ç›®æ ‡æ•°é‡
HTTPCode_Target_5XX_Count	ç›®æ ‡ç«¯è¿”å›çš„ 5xx æ•°é‡


ä½ å¯ä»¥ï¼š

åˆ›å»ºä¸€ä¸ª CloudWatch Dashboard æˆ– Insights æŸ¥è¯¢ï¼›

è§‚å¯Ÿ UnHealthyHostCount é™ä¸º 0 çš„æ—¶é—´ å’Œ è¯·æ±‚æ¢å¤æ­£å¸¸çš„æ—¶é—´ï¼›

å¯¹æ¯”æ•…éšœ Pod å¼‚å¸¸å¼€å§‹ å’Œ æ›¿æ¢ Pod è¢«æ ‡è®°ä¸º healthy çš„æ—¶é—´å·®ã€‚



---

3. ALB Target Group å¥åº·æ£€æŸ¥è®¾ç½®

æŸ¥çœ‹å¦‚ä¸‹é…ç½®å½±å“ failover æ—¶é—´ï¼š

è®¾ç½®é¡¹	å«ä¹‰

HealthyThresholdCount	è¿ç»­ N æ¬¡å¥åº·æ‰è®¤ä¸ºç›®æ ‡æ˜¯ healthy
UnhealthyThresholdCount	è¿ç»­ N æ¬¡å¤±è´¥æ‰è®¤ä¸ºç›®æ ‡ unhealthy
HealthCheckIntervalSeconds	æ£€æŸ¥é—´éš”ç§’æ•°ï¼Œé»˜è®¤ 30s
HealthCheckTimeoutSeconds	å•æ¬¡æ£€æŸ¥è¶…æ—¶æ—¶é—´


â¡ï¸ ç†è®ºæœ€æ…¢åˆ‡æ¢æ—¶é—´ â‰ˆ

ï¼ˆUnhealthyThresholdCount * Intervalï¼‰+ï¼ˆPod é‡å¯æ—¶é—´ï¼‰+ï¼ˆHealthyThresholdCount * Intervalï¼‰

ğŸ‘‰ ä¸¾ä¸ªä¾‹å­ï¼š

å¥åº·æ£€æŸ¥é—´éš” 10 ç§’ï¼Œ3 æ¬¡æ‰è®¤ä¸º healthyï¼›

Pod ä»å¤±è´¥åˆ°æ›¿ä»£ pod å¯åŠ¨è€—æ—¶ 20 ç§’ï¼›

é‚£ä¹ˆ ALB å¯èƒ½åœ¨ 50 ç§’å†…æ¢å¤æµé‡ã€‚



---

4. Pod å±‚æ—¥å¿—

ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŸ¥çœ‹ Pod å˜æ›´æ—¶é—´ç‚¹ï¼š

kubectl get events --sort-by=.lastTimestamp -n your-namespace

å…³æ³¨ï¼š

Killing old pod

Started new pod

Readiness probe passed äº‹ä»¶


è¿™äº›æ—¶é—´ç‚¹å¯ä»¥å’Œ ALB æ—¥å¿—æˆ– CloudWatch æŒ‡æ ‡é…åˆæ¯”å¯¹ï¼Œæ¨ç®— ALB è¯†åˆ«æ–° pod çš„æ—¶é—´ã€‚


---

âœ³ï¸ æ€»ç»“

å·¥å…·/æ–¹æ³•	ä½œç”¨

ALB Access Log	ç²¾ç¡®çœ‹åˆ°æµé‡å’Œç›®æ ‡åˆ‡æ¢æ—¶é—´
CloudWatch Metrics	ç›´è§‚çœ‹åˆ°ç›®æ ‡å¥åº·çŠ¶æ€å˜åŒ–
kubectl events	æŸ¥çœ‹ pod é‡å»ºå’Œ ready æ—¶é—´ç‚¹
Health check è®¾ç½®	å†³å®š failover å¿«æ…¢çš„å…³é”®å‚æ•°



---

å¦‚éœ€å¸®ä½ åˆ†æå…·ä½“æ—¥å¿—æˆ–é…ç½®ï¼ˆæ¯”å¦‚ S3 æ—¥å¿—æ ·ä¾‹ã€CloudWatch æŸ¥è¯¢ç­‰ï¼‰ï¼Œæ¬¢è¿è´´å…·ä½“å†…å®¹ï¼Œæˆ‘å¯ä»¥è¿›ä¸€æ­¥å¸®ä½ åˆ†ææ—¶é—´çº¿ã€‚

