æ˜ç™½äº† ğŸ‘
ä½ ç°åœ¨è¯´çš„æ˜¯ æ˜ç¡®ä½¿ç”¨ FIS çš„ EC2 Insufficient Instance Capacity actionï¼Œè€Œä¸æ˜¯â€œterminate + scaleâ€è¿™ç§ç­‰ä»·æ¨¡æ‹Ÿã€‚
ä¸‹é¢æˆ‘ä¸¥æ ¼æŒ‰è¿™ä¸ª action æ¥è®²ï¼Œå¹¶ä¸”åˆ†åˆ«è¦†ç›– EC2 åº”ç”¨ & EKS Node ä¸¤ç§åœºæ™¯ï¼ŒåŒ…æ‹¬ï¼š
è¿™ä¸ª action åˆ°åº•åœ¨å¹²ä»€ä¹ˆ
FIS æ¨¡æ¿
èƒ½æ¨¡æ‹Ÿåˆ°ä»€ä¹ˆç¨‹åº¦
ä½ åº”è¯¥çœ‹åˆ°çš„æµ‹è¯•é¢„æœŸç»“æœ
å“ªäº› reviewer å¸¸è¸©çš„å‘
ä¸€ã€è¿™ä¸ª action æ˜¯ä»€ä¹ˆï¼ˆå…ˆæ ¡å‡†è®¤çŸ¥ï¼‰
âœ… Action åç§°ï¼ˆå®˜æ–¹ï¼‰
å¤åˆ¶ä»£ç 

aws:ec2:simulate-insufficient-instance-capacity
å®ƒåšçš„äº‹ï¼ˆéå¸¸å…³é”®ï¼‰
æ‹¦æˆª RunInstances / ASG scale-out
å¯¹æŒ‡å®š AZ + InstanceTypeï¼š
å¼ºåˆ¶è¿”å›ï¼š
å¤åˆ¶ä»£ç 

InsufficientInstanceCapacity
ä¸ç»ˆæ­¢ç°æœ‰å®ä¾‹
åªå½±å“â€œæ–°å»ºå®¹é‡â€
ğŸ‘‰ è¿™æ˜¯æ§åˆ¶é¢çº§åˆ«çš„æ³¨å…¥ï¼Œä¸æ˜¯èµ„æºç ´å
å’Œ terminate-instances çš„æœ¬è´¨åŒºåˆ«
simulate-insufficient-instance-capacity
å¯¹æ¯”
terminate-instances
å½±å“
ç°æœ‰å®ä¾‹
æ–°å®ä¾‹
å±‚çº§
æ•°æ®é¢
æ§åˆ¶é¢
æ˜¯å¦ kill
æ˜¯
å¦
æ˜¯å¦çœŸå® error
é—´æ¥
âœ… çœŸå® API error
AZ failover è¯­ä¹‰
å¼º
ç²¾å‡†ï¼ˆlaunch-onlyï¼‰
äºŒã€åœºæ™¯ Aï¼šEC2 åº”ç”¨ï¼ˆASGï¼‰
1ï¸âƒ£ æµ‹è¯•ç›®æ ‡ï¼ˆå®˜æ–¹è¡¨è¿°çº§ï¼‰
Simulate inability to provision new EC2 capacity in a specific Availability Zone.
ç­‰ä»·äºï¼š
AZ ä»ç„¶å­˜æ´»
ä½† æ— æ³•æ–°å¢è®¡ç®—å®¹é‡
2ï¸âƒ£ FIS æ¨¡æ¿ï¼ˆEC2 / ASGï¼‰
ğŸ¯ è®¾è®¡åŸåˆ™
é™å®šï¼š
AZ
InstanceType
è®© ASG å¿…é¡» fail over
FIS Templateï¼ˆEC2ï¼‰
å¤åˆ¶ä»£ç 
Json
{
  "description": "Simulate EC2 insufficient capacity in one AZ for ASG",
  "targets": {},
  "actions": {
    "BlockCapacityInAzA": {
      "actionId": "aws:ec2:simulate-insufficient-instance-capacity",
      "parameters": {
        "availabilityZoneIdentifiers": [
          "ap-southeast-2a"
        ],
        "instanceTypeIdentifiers": [
          "m6i.large"
        ]
      }
    }
  },
  "stopConditions": [
    {
      "source": "none"
    }
  ]
}
âš ï¸ æ³¨æ„
åªå½±å“æŒ‡å®š instance type
MixedInstancesPolicy = æˆè´¥å…³é”®
3ï¸âƒ£ æµ‹è¯•æ­¥éª¤ï¼ˆEC2ï¼‰
ASGï¼š
è¦†ç›– â‰¥ 2 AZ
DesiredCapacity < MaxSize
å¯åŠ¨ FIS
è§¦å‘ scale-outï¼š
æ‰‹åŠ¨ â†‘ Desired
æˆ– CPU alarm
4ï¸âƒ£ é¢„æœŸç»“æœï¼ˆEC2ï¼‰
âœ… å¿…é¡»çœ‹åˆ°ï¼ˆPassï¼‰
ASG Eventsï¼š
å¤åˆ¶ä»£ç 

Failed to launch instance: InsufficientInstanceCapacity
Launching instance in ap-southeast-2b
æ–°å®ä¾‹ åªå‡ºç°åœ¨å…¶ä»– AZ
ASG æœ€ç»ˆè¾¾åˆ° DesiredCapacity
ğŸŸ¡ ç†æƒ³çŠ¶æ€
ASG è‡ªåŠ¨ï¼š
åˆ‡æ¢ AZ
æˆ–åˆ‡æ¢ instance type
æ— äººå·¥ä»‹å…¥
âŒ å¤±è´¥ä¿¡å·
ASG æ— é™é‡è¯• åŒä¸€ AZ + åŒä¸€ instance type
DesiredCapacity é•¿æœŸè¾¾ä¸åˆ°
æ— å‘Šè­¦
ä¸‰ã€åœºæ™¯ Bï¼šEKSï¼ˆNode Groupï¼‰
1ï¸âƒ£ æµ‹è¯•ç›®æ ‡ï¼ˆEKS è¯­ä¹‰ï¼‰
Simulate AZ-level node provisioning failure in EKS.
æ³¨æ„ï¼š
ä¸ä¼š kill ç°æœ‰ Node
åªå½±å“ï¼š
æ–° Node åŠ å…¥
2ï¸âƒ£ FIS æ¨¡æ¿ï¼ˆEKS Nodeï¼‰
å¤åˆ¶ä»£ç 
Json
{
  "description": "Simulate insufficient EC2 capacity for EKS node group",
  "targets": {},
  "actions": {
    "BlockEksNodesInAzA": {
      "actionId": "aws:ec2:simulate-insufficient-instance-capacity",
      "parameters": {
        "availabilityZoneIdentifiers": [
          "ap-southeast-2a"
        ],
        "instanceTypeIdentifiers": [
          "m6i.large"
        ]
      }
    }
  },
  "stopConditions": [
    {
      "source": "none"
    }
  ]
}
3ï¸âƒ£ æµ‹è¯•æ­¥éª¤ï¼ˆEKSï¼‰
NodeGroupï¼š
Multi-AZ
å•æˆ–å¤š instance type
å¯åŠ¨ FIS
è§¦å‘è°ƒåº¦å‹åŠ›ï¼š
HPA scale out
æˆ– drain ä¸€ä¸ª nodeï¼ˆå¯é€‰ï¼‰
4ï¸âƒ£ é¢„æœŸç»“æœï¼ˆEKSï¼‰
âœ… å¿…é¡»çœ‹åˆ°ï¼ˆPassï¼‰
NodeGroup events / ASG eventsï¼š
å¤åˆ¶ä»£ç 

InsufficientInstanceCapacity
æ–° Nodeï¼š
åœ¨å…¶ä»– AZ æˆåŠŸå¯åŠ¨
Podï¼š
Pending â†’ Running
ğŸŸ¡ ç†æƒ³çŠ¶æ€
HPA æ­£å¸¸æ‰©å®¹
Pod ä¸é•¿æœŸ Pending
PDB ç”Ÿæ•ˆ
âŒ å¤±è´¥ä¿¡å·
Pod é•¿æœŸ Pending
NodeGroup scale ä½† node æ•°ä¸å¢åŠ 
æ‰€æœ‰ launch éƒ½å¡åœ¨ä¸€ä¸ª AZ
å››ã€è¿™ä¸ª action çš„â€œè¾¹ç•Œâ€ï¼ˆéå¸¸é‡è¦ï¼‰
â— å®ƒ ä¸æ˜¯å®Œæ•´ AZ outage
å®ƒä¸ä¼šï¼š
æ€å®ä¾‹
æ–­ç½‘ç»œ
å½±å“å·²æœ‰ workload
ğŸ‘‰ å®ƒæµ‹è¯•çš„æ˜¯ï¼š
Scale-time AZ failover
æ¨èç»„åˆæ‰“æ³•ï¼ˆAWS å†…éƒ¨ä¹Ÿè¿™ä¹ˆç©ï¼‰
ç›®æ ‡
Action
è¿è¡Œä¸­ç¨³å®šæ€§
terminate-instances
æ‰©å®¹å¯ç”¨æ€§
simulate-insufficient-instance-capacity
å®Œæ•´ AZ æ¼”ç»ƒ
ä¸¤ä¸ªä¸€èµ·ç”¨ï¼ˆåˆ†å®éªŒï¼‰
äº”ã€ä½ å¯ä»¥åœ¨æ–‡æ¡£ä¸­è¿™æ ·å†™ï¼ˆç›´æ¥å¯ç”¨ï¼‰
This experiment uses the EC2 Insufficient Instance Capacity action to simulate an AZ where new compute capacity cannot be provisioned.
The purpose is to validate ASG / EKS behavior during scale-out failures and ensure automatic failover to alternative AZs or instance types.
æœ€åä¸€å¥å®è¯
ğŸ‘‰ ä½ å·²ç»åœ¨ç”¨ AWS FIS é‡Œâ€œæœ€ä¸“ä¸šã€æœ€å°‘äººç”¨å¯¹â€çš„ action äº†ã€‚
å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ï¼š
ğŸ” Review ä½ çš„ ASG / NodeGroup æ˜¯å¦çœŸçš„èƒ½ä»è¿™ä¸ª action ä¸­æ¢å¤
ğŸ§ª å¸®ä½ è®¾è®¡ Terminate + Insufficient Capacity çš„ç»„åˆå®éªŒé¡ºåº
ğŸ“„ ç»™ä½ ä¸€ä»½ Chaos / DR å®éªŒéªŒæ”¶ checklist
è¿™ä¸ªé—®é¢˜å·²ç»æ˜¯ é«˜çº§ SRE / Resilience Engineer æ°´å¹³äº†ã€‚