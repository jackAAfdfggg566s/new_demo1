ä½ æƒ³åœ¨ GitLab CI ä¸­ æŸ¥çœ‹è¿œç«¯æœºå™¨ /data ç›®å½•çš„å‰©ä½™ç£ç›˜ç©ºé—´ï¼Œå¯ä»¥é€šè¿‡ SSH ç™»å½•è¿œç«¯æœºå™¨ï¼Œæ‰§è¡Œ df å‘½ä»¤ï¼Œå¹¶æ‰“å°è¾“å‡ºæˆ–åŠ åˆ¤æ–­ã€‚

ä¸‹é¢æ˜¯ âœ… å®Œæ•´å¯ç”¨æ–¹æ¡ˆï¼ŒåŒ…æ‹¬è„šæœ¬å’Œ .gitlab-ci.yml é…ç½®ï¼š


---

âœ… 1. SSHå‘½ä»¤æŸ¥çœ‹ /data å‰©ä½™ç©ºé—´

sshpass -p "$REMOTE_PASS" ssh -o StrictHostKeyChecking=no "$REMOTE_USER@$REMOTE_HOST" "df -h /data"

è¾“å‡ºç¤ºä¾‹ï¼š

Filesystem      Size  Used Avail Use% Mounted on
/dev/sdb1       100G   40G   60G  40% /data


---

âœ… 2. GitLab .gitlab-ci.yml ç¤ºä¾‹

ä½ å¯ä»¥ä¸“é—¨åŠ ä¸€ä¸ª job å»æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼š

check_disk:
  stage: check
  script:
    - echo "ğŸ” æ£€æŸ¥è¿œç«¯ /data å‰©ä½™ç©ºé—´..."
    - sshpass -p "$REMOTE_PASS" ssh -o StrictHostKeyChecking=no "$REMOTE_USER@$REMOTE_HOST" "df -h /data"

> âš ï¸ ä½ éœ€è¦åœ¨ GitLab çš„ CI/CD Variables ä¸­æ·»åŠ ä»¥ä¸‹å˜é‡ï¼š

REMOTE_USERï¼ˆä¾‹å¦‚ ec2-user æˆ– ubuntuï¼‰

REMOTE_HOSTï¼ˆè¿œç«¯ä¸»æœº IP æˆ–åŸŸåï¼‰

REMOTE_PASSï¼ˆè¿œç«¯å¯†ç ï¼Œå»ºè®®è®¾ç½®ä¸º protectedï¼‰





---

âœ… 3. å¯é€‰ï¼šæå–å‰©ä½™ç©ºé—´æ•°å€¼ï¼ˆæ¯”å¦‚ Avail å­—æ®µï¼‰

avail=$(sshpass -p "$REMOTE_PASS" ssh -o StrictHostKeyChecking=no "$REMOTE_USER@$REMOTE_HOST" "df -h /data | awk 'NR==2 {print \$4}'")
echo "ğŸ—‚ï¸ /data å‰©ä½™ç©ºé—´: $avail"


---

âœ… 4. å¯é€‰åŠ åˆ¤æ–­ï¼ˆæ¯”å¦‚å°äº10GæŠ¥è­¦ï¼‰

avail_gb=$(sshpass -p "$REMOTE_PASS" ssh -o StrictHostKeyChecking=no "$REMOTE_USER@$REMOTE_HOST" "
  df -BG --output=avail /data | tail -n 1 | tr -dc '0-9'
")

echo "ğŸ“¦ /data å¯ç”¨ç©ºé—´ä¸º ${avail_gb}G"

if [ "$avail_gb" -lt 10 ]; then
  echo "âŒ ç©ºé—´ä¸è¶³ï¼å‰©ä½™ä¸åˆ° 10G"
  exit 1
else
  echo "âœ… ç©ºé—´è¶³å¤Ÿ"
fi


---

ğŸ§ª ç»“æœï¼šCI job è¾“å‡ºç¤ºæ„

ğŸ“¦ /data å¯ç”¨ç©ºé—´ä¸º 23G
âœ… ç©ºé—´è¶³å¤Ÿ

æˆ–ï¼š

ğŸ“¦ /data å¯ç”¨ç©ºé—´ä¸º 8G
âŒ ç©ºé—´ä¸è¶³ï¼å‰©ä½™ä¸åˆ° 10G


---

éœ€è¦æˆ‘å¸®ä½ å°è£…æˆä¸€ä¸ª check_remote_disk.sh æ–‡ä»¶ä¾›å¤ç”¨ï¼Œæˆ–è€…é›†æˆåˆ°æŸä¸ª pipeline å‰åšå‰ç½®æ£€æŸ¥å—ï¼Ÿåªè¦å‘Šè¯‰æˆ‘ä½ æµç¨‹åœ¨å“ªä¸€æ­¥åŠ å°±è¡Œã€‚

