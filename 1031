éå¸¸å¥½çš„é—®é¢˜ ğŸ‘ â€”â€”è¿™ä¸ªåœºæ™¯åœ¨ Ansible é‡Œå¾ˆå¸¸è§ï¼š
ä½ ç”¨ with_fileglob: "*.7z" æ‰¾åˆ°ä¸€ä¸ªæœ¬åœ°æ–‡ä»¶ï¼ˆæˆ–å¤šä¸ªï¼‰ï¼Œregister åå†ä¼ åˆ°è¿œç¨‹ï¼Œç„¶ååœ¨è¿œç¨‹æ‰§è¡Œè„šæœ¬æ—¶éœ€è¦çŸ¥é“å…·ä½“æ–‡ä»¶åæ¥è§£å‹ã€‚

ä¸‹é¢æˆ‘ç»™ä½ å®Œæ•´æ€è·¯ + å¯è¿è¡Œç¤ºä¾‹ã€‚


---

âœ… ä¸€ã€æ ¸å¿ƒåŸç†

åœ¨ Ansible é‡Œï¼Œwith_fileglob ä¼šè¿”å› æœ¬åœ°åŒ¹é…çš„æ‰€æœ‰æ–‡ä»¶è·¯å¾„ã€‚
å¦‚æœä½  register:ï¼Œå˜é‡ä¼šåŒ…å«ä¸€ä¸ª results åˆ—è¡¨ã€‚
æ¯”å¦‚ï¼š

- name: find 7z files
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: /tmp/
  with_fileglob:
    - "*.7z"
  register: copied_files

æ‰§è¡Œåï¼Œä½ å¯ä»¥æ‰“å°å‡ºæ¥çœ‹çœ‹ï¼š

- debug:
    var: copied_files

è¾“å‡ºå¤§æ¦‚æ˜¯ï¼š

copied_files:
  results:
    - item: /home/ansible/build/package_20251030.7z
      dest: /tmp/package_20251030.7z
      ...
    - item: /home/ansible/build/package_20251031.7z
      dest: /tmp/package_20251031.7z
      ...


---

âœ… äºŒã€å–åˆ°æ–‡ä»¶åï¼ˆå«æˆ–ä¸å«è·¯å¾„ï¼‰

ä¾‹å¦‚ä½ è¦åœ¨åç»­ task ä¸­ä½¿ç”¨ç¬¬ä¸€ä¸ªæ–‡ä»¶åï¼š

- set_fact:
    archive_name: "{{ copied_files.results[0].item | basename }}"

è¯´æ˜ï¼š

item æ˜¯æœ¬åœ°è·¯å¾„ï¼›

basename æ˜¯ Jinja2 è¿‡æ»¤å™¨ï¼Œå¯å–æ–‡ä»¶åéƒ¨åˆ†ï¼›

ä½ ä¹Ÿå¯ä»¥å– destï¼ˆè¿œç«¯è·¯å¾„ï¼‰ã€‚



---

âœ… ä¸‰ã€åœ¨è¿œç¨‹æ‰§è¡Œè„šæœ¬æ—¶ç”¨åˆ°æ–‡ä»¶å

å‡è®¾ä½  copy åˆ° /tmpï¼Œæ¥ç€åœ¨è¿œç¨‹è§£å‹ï¼š

- name: unzip archive on remote
  ansible.builtin.shell: |
    cd /tmp
    7z x "{{ archive_name }}" -o/app/
  args:
    executable: /bin/bash

è¿™å°±èƒ½è‡ªåŠ¨è§£å‹ä¸Šä¸€æ­¥å¤åˆ¶çš„å…·ä½“ .7z æ–‡ä»¶ã€‚


---

âœ… å››ã€å®Œæ•´å¯è¿è¡Œç¤ºä¾‹

- hosts: target
  gather_facts: no
  tasks:
    - name: Copy 7z file(s)
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: /tmp/
      with_fileglob:
        - "*.7z"
      register: copied_files

    - name: Set archive name (first match)
      ansible.builtin.set_fact:
        archive_name: "{{ copied_files.results[0].item | basename }}"

    - name: Debug print file name
      ansible.builtin.debug:
        msg: "Copied file name is {{ archive_name }}"

    - name: Unzip archive on remote
      ansible.builtin.shell: |
        cd /tmp
        7z x "{{ archive_name }}" -o/app/
      args:
        executable: /bin/bash


---

âœ… äº”ã€å¦‚æœä½ æœ‰å¤šä¸ª .7z æ–‡ä»¶è¦è§£å‹

ä¹Ÿå¯ä»¥å¾ªç¯æ‰§è¡Œï¼š

- name: Unzip all archives
  ansible.builtin.shell: |
    cd /tmp
    7z x "{{ item.item | basename }}" -o/app/
  args:
    executable: /bin/bash
  loop: "{{ copied_files.results }}"


---

âœ… å…­ã€å°æŠ€å·§

å¦‚æœä½ åªæƒ³åŒ¹é…â€œæœ€æ–°çš„â€ .7z æ–‡ä»¶ï¼ˆæ¯”å¦‚æ„å»ºè¾“å‡ºæœ€æ–°åŒ…ï¼‰ï¼Œ
å¯ä»¥åœ¨ find æ¨¡å—ä¸­ç”¨ sort_by å®ç°ï¼š

- name: Find latest 7z
  find:
    paths: /home/ansible/build
    patterns: "*.7z"
    recurse: no
    sort_by: mtime
    sort_order: descending
    file_type: file
  register: found

- set_fact:
    latest_archive: "{{ found.files[0].path | basename }}"


---

æ˜¯å¦æ–¹ä¾¿è´´ä½ ç°åœ¨é‚£æ®µ playbook çš„ä»£ç ç‰‡æ®µï¼Ÿ
æˆ‘å¯ä»¥å¸®ä½ æŠŠ â€œregister â†’ copy â†’ è§£å‹â€ é‚£éƒ¨åˆ†è¿èµ·æ¥ï¼Œ
è®©å˜é‡ä¼ é€’æœ€ç®€æ´ï¼ˆä¸è®ºå¤šä¸ªæ–‡ä»¶æˆ–å•ä¸ªæ–‡ä»¶éƒ½èƒ½é€šç”¨ï¼‰ã€‚