å¥½çš„ï¼ä½ ç°åœ¨æ˜¯ä½¿ç”¨ GitLab Kubernetes Agentï¼ˆGitLab Agent for Kubernetesï¼‰ çš„æ–¹å¼è·‘ pipelineï¼Œä¹Ÿå°±æ˜¯ï¼š

âœ… ä½¿ç”¨çš„æ˜¯ kubernetes executor è€Œä¸æ˜¯ docker executorã€‚


---

â—è¿™ä¼šå¯¼è‡´ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š

> Kubernetes executor ä¸‹æ¯ä¸ª job æ˜¯ ä¸€ä¸ªç‹¬ç«‹çš„ Podï¼Œæ¯æ¬¡ job ç»“æŸå Pod ä¼šè¢«é”€æ¯ï¼Œä¸Šä¸€æ¬¡è¿è¡Œçš„å†…å®¹ä¸ä¼šè‡ªåŠ¨ä¿ç•™åˆ°ä¸‹ä¸€æ¬¡ã€‚




---

ğŸš« æ‰€ä»¥ä½ ä¸èƒ½åœ¨åŒä¸€ä¸ª job é‡Œä½¿ç”¨ docker run è¿è¡Œä¸åŒé•œåƒï¼Œä¹Ÿæ— æ³•åœ¨ä¸€ä¸ª job é‡ŒåŠ¨æ€åˆ‡æ¢ imageã€‚


---

âœ… é‚£è¯¥æ€ä¹ˆåšï¼Ÿ

æˆ‘ä»¬æ¢ä¸€ç§æ–¹æ³•ï¼šé€šè¿‡å¤šä¸ª job + needs: ä¸²è” + artifacts: ä¼ é€’æ–‡ä»¶ï¼Œæ¥åšåˆ°â€œæ¯æ¬¡å…ˆè¿è¡Œ jarï¼Œå† checkï¼Œå…±å¾ªç¯ 5 æ¬¡â€ã€‚


---

âœ… æ¨èç»“æ„ï¼ˆç®€åŒ–å†™æ³•ï¼‰

è™½ç„¶ GitLab CI ä¸æ”¯æŒ job å¾ªç¯ï¼Œä½†æˆ‘ä»¬å¯ä»¥ç”¨ YAML anchorï¼ˆé”šç‚¹ï¼‰+ needs ä¸²è”ï¼Œå†™ 10 ä¸ª job çš„ç®€æ´ç»“æ„ã€‚


---

âœ¨ ç¤ºä¾‹ .gitlab-ci.ymlï¼ˆå®Œæ•´ 5 æ¬¡å¾ªç¯ï¼‰

stages:
  - run
  - check

# é€šç”¨æ¨¡æ¿ï¼šè¿è¡Œjar
.run_jar_template: &run_jar_template
  stage: run
  script:
    - echo "è¿è¡Œ jar for job $CI_JOB_NAME"
    - java -jar your-app.jar > output.log
  artifacts:
    paths:
      - output.log
    expire_in: 1 hour

# é€šç”¨æ¨¡æ¿ï¼šcheck æ—¥å¿—
.check_template: &check_template
  stage: check
  script:
    - echo "æ£€æŸ¥æ—¥å¿— for job $CI_JOB_NAME"
    - cat output.log
    - if grep -q "ERROR" output.log; then
        echo "æ£€æŸ¥å¤±è´¥ âŒ";
        exit 1;
      else
        echo "æ£€æŸ¥é€šè¿‡ âœ…";
      fi

run_1:
  <<: *run_jar_template
  image: openjdk:17

check_1:
  <<: *check_template
  image: alpine
  needs: [run_1]

run_2:
  <<: *run_jar_template
  image: openjdk:17
  needs: [check_1]

check_2:
  <<: *check_template
  image: alpine
  needs: [run_2]

run_3:
  <<: *run_jar_template
  image: openjdk:17
  needs: [check_2]

check_3:
  <<: *check_template
  image: alpine
  needs: [run_3]

run_4:
  <<: *run_jar_template
  image: openjdk:17
  needs: [check_3]

check_4:
  <<: *check_template
  image: alpine
  needs: [run_4]

run_5:
  <<: *run_jar_template
  image: openjdk:17
  needs: [check_4]

check_5:
  <<: *check_template
  image: alpine
  needs: [run_5]


---

âœ… å·¥ä½œåŸç†

run_x ä½¿ç”¨ openjdk é•œåƒè¿è¡Œ jar

check_x ä½¿ç”¨ alpine é•œåƒæ£€æŸ¥ jar çš„æ—¥å¿—è¾“å‡º

æ¯è½® job ç”¨ needs: ç²¾å‡†æŒ‡å®šä¸Šä¸€ä¸ª jobï¼Œç¡®ä¿é¡ºåºæ‰§è¡Œ

ä½¿ç”¨ artifacts: ä¼ é€’ output.log ç»™ä¸‹ä¸€æ­¥



---

âœ… ä½ çš„ runner æ˜¯ GitLab Agentï¼ˆKubernetesï¼‰ï¼Œæ²¡é—®é¢˜ï¼š

æ¯ä¸ª job æ˜¯ Podï¼ŒæŒ‡å®š image å°±ä¼šæ‹‰å¯¹åº”é•œåƒï¼ˆopenjdk æˆ– alpineï¼‰

æ–‡ä»¶ä¼ é€’é€šè¿‡ artifactsï¼ŒGitLab ä¼šè‡ªåŠ¨ä¿å­˜å¹¶ä¸‹è½½



---

ğŸ” æ˜¯å¦èƒ½è¿›ä¸€æ­¥â€œåŠ¨æ€å¾ªç¯â€ï¼Ÿç›®å‰ GitLab CI ä¸åŸç”Ÿæ”¯æŒå¾ªç¯ jobï¼ˆæ¯”å¦‚å†™ä¸€ä¸ª job è‡ªåŠ¨æ‰§è¡Œ 5 æ¬¡ï¼‰ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ¡ˆæ˜¯æœ€ç¨³å®šçš„åŠæ³•ã€‚


---

å¦‚æœä½ è§‰å¾—å†™ 10 ä¸ª job ä»£ç è¿˜æ˜¯å¤ªå¤šï¼Œæˆ‘ä¹Ÿå¯ä»¥ï¼š

ç”¨ shell ç”Ÿæˆ .gitlab-ci.yml

æˆ–ç”¨ child pipeline è‡ªåŠ¨ç”Ÿæˆ job


éœ€è¦æˆ‘å“ªç§æ–¹å¼æ¥å¸®ä½ å†™ä¸€ä¸ªç²¾ç®€ç‰ˆæœ¬ï¼Ÿè¿˜æ˜¯ä½ æƒ³è´´ä¸‹ä½ çš„ .jar åå’Œ check æ¡ä»¶ï¼Œæˆ‘ç›´æ¥å¸®ä½ å‡ºå®Œæ•´ç‰ˆæœ¬ï¼Ÿ

