å¥½çš„ï¼Œæˆ‘å¸®ä½ å†™ä¸€ä¸ª å®Œæ•´ Python Lambda ç¤ºä¾‹ï¼Œå®ç°çš„åŠŸèƒ½æ˜¯ï¼š

1. å®šæ—¶è·å– RDS Database Insights Top SQL æ•°æ®ï¼ˆCPU æˆ–å…¶ä»–æŒ‡æ ‡ï¼‰ã€‚


2. å†™å…¥ CloudWatch è‡ªå®šä¹‰ Metricsï¼Œå¯ä»¥åœ¨ Dashboard ç›´æ¥æ˜¾ç¤ºã€‚



ä¸‹é¢æ˜¯ç¤ºä¾‹ä»£ç ï¼ˆPython 3.9+ï¼Œè¿è¡Œåœ¨ Lambda ä¸­ï¼‰ï¼š


---

import boto3
import os
from datetime import datetime, timedelta

# Lambda ç¯å¢ƒå˜é‡
DB_INSTANCE_IDENTIFIER = os.environ.get("DB_INSTANCE_IDENTIFIER", "your-db-identifier")
CW_NAMESPACE = os.environ.get("CW_NAMESPACE", "Custom/TopSQL")
METRIC_NAME = os.environ.get("METRIC_NAME", "TopSQLCPU")  # è‡ªå®šä¹‰æŒ‡æ ‡å

# åˆ›å»º AWS å®¢æˆ·ç«¯
pi_client = boto3.client("pi")  # Performance Insights / Database Insights API
cw_client = boto3.client("cloudwatch")

def lambda_handler(event, context):
    # æ—¶é—´èŒƒå›´ï¼šè¿‡å» 5 åˆ†é’Ÿ
    end_time = datetime.utcnow()
    start_time = end_time - timedelta(minutes=5)

    try:
        response = pi_client.get_resource_metrics(
            ServiceType='RDS',
            Identifier=DB_INSTANCE_IDENTIFIER,
            MetricQueries=[
                {
                    'Metric': 'db.load.avg',  # Database Insights Top SQL æŒ‡æ ‡
                    'GroupBy': {
                        'Group': 'SQL'
                    },
                    'Limit': 5  # è·å– Top 5 SQL
                }
            ],
            StartTime=start_time,
            EndTime=end_time
        )

        metrics_data = []

        # è§£æ Top SQL æ•°æ®
        for metric in response.get("MetricList", []):
            sql_text = metric.get("Dimensions", {}).get("sql", "unknown_sql")
            for point in metric.get("DataPoints", []):
                metrics_data.append({
                    'MetricName': METRIC_NAME,
                    'Dimensions': [
                        {'Name': 'SQLText', 'Value': sql_text},
                        {'Name': 'DBInstance', 'Value': DB_INSTANCE_IDENTIFIER}
                    ],
                    'Timestamp': point['Timestamp'],
                    'Value': point['Value'],
                    'Unit': 'Count'
                })

        # å†™å…¥ CloudWatch
        if metrics_data:
            cw_client.put_metric_data(
                Namespace=CW_NAMESPACE,
                MetricData=metrics_data
            )

        return {"status": "success", "data_points": len(metrics_data)}

    except Exception as e:
        print(f"Error: {e}")
        raise


---

éƒ¨ç½²æ­¥éª¤

1. åˆ›å»º Lambdaï¼ŒPython 3.9+ã€‚


2. é…ç½® ç¯å¢ƒå˜é‡ï¼š

DB_INSTANCE_IDENTIFIERï¼šä½ çš„ RDS Database Identifier

CW_NAMESPACEï¼šCloudWatch Dashboard è‡ªå®šä¹‰ namespace

METRIC_NAMEï¼šè‡ªå®šä¹‰æŒ‡æ ‡åï¼Œä¾‹å¦‚ TopSQLCPU



3. Lambda è§’è‰²ï¼šä½¿ç”¨ä¹‹å‰ç»™ä½ çš„ Trust Policy + æƒé™ Policyã€‚


4. é…ç½® å®šæ—¶è§¦å‘ï¼ˆCloudWatch Event / EventBridgeï¼‰ï¼Œä¾‹å¦‚æ¯ 5 åˆ†é’Ÿè°ƒç”¨ä¸€æ¬¡ã€‚


5. åœ¨ CloudWatch Dashboard ä¸­ï¼š

é€‰æ‹©ä½ çš„è‡ªå®šä¹‰ namespace

é€‰æ‹©æŒ‡æ ‡ TopSQLCPUï¼ŒæŒ‰ SQLText æˆ– DBInstance ç»´åº¦æ˜¾ç¤º





---

ğŸ’¡ å°æç¤ºï¼š

Limit å¯ä»¥è°ƒæ•´è·å– Top 5ã€Top 10 SQLã€‚

db.load.avg åªæ˜¯ç¤ºä¾‹ï¼Œå¦‚æœä½ æƒ³è¦ CPUã€IOã€Latency ç­‰æŒ‡æ ‡ï¼Œå¯ä»¥æ”¹ MetricQueries ä¸­çš„ Metricã€‚

å¦‚æœ Top SQL å†…å®¹å¤ªé•¿ï¼Œå¯ä»¥ç”¨ SQL Hash æˆ–è‡ªå·±æˆªæ–­å†™å…¥ Dimensionï¼Œé¿å… CloudWatch Key è¶…é•¿æŠ¥é”™ã€‚



---

æˆ‘å¯ä»¥å¸®ä½ å†™ä¸€ä¸ª æ”¹è¿›ç‰ˆï¼Œè‡ªåŠ¨å– Top SQL çš„ CPU% å¹¶ä¸”æŒ‰ SQL hash å­˜å…¥ CloudWatchï¼Œæ›´å®‰å…¨ï¼Œé¿å… SQL å¤ªé•¿ Dimension æŠ¥é”™ã€‚

ä½ å¸Œæœ›æˆ‘ç›´æ¥å†™å—ï¼Ÿ

