æ˜ç™½ï¼Œä½ è¿™ä¸ªéœ€æ±‚æ˜¯ï¼šåªåŸºäº AZ æ¥æ‰¾ EKS çš„ nodeï¼ˆä¸å…³å¿ƒ nodegroup åå­—ï¼‰ã€‚
ä¸‹é¢ç»™ä½ æœ€ç›´æ¥ã€å¯è½åœ°çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯ä½ åš AZ æ•…éšœ / FIS æ—¶æœ€å¸¸ç”¨çš„ã€‚
ä¸€ã€æœ€æ ‡å‡†åšæ³•ï¼ˆKubernetes è§†è§’ï¼Œå¼ºçƒˆæ¨èï¼‰
âœ… é€šè¿‡ Node çš„ AZ label æŸ¥
EKS èŠ‚ç‚¹ä¸€å®šä¼šæœ‰ AZ ç›¸å…³ labelï¼ˆè¿™æ˜¯ Kubernetes æ ‡å‡†ï¼‰ï¼š
å¤åˆ¶ä»£ç 
Bash
kubectl get nodes \
  -l topology.kubernetes.io/zone=ap-southeast-2a
å¦‚æœä½ é›†ç¾¤æ¯”è¾ƒè€ï¼Œä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªï¼ˆå…¼å®¹ï¼‰ï¼š
å¤åˆ¶ä»£ç 
Bash
kubectl get nodes \
  -l failure-domain.beta.kubernetes.io/zone=ap-southeast-2a
æŸ¥çœ‹ç»“æœï¼ˆnode åç§°ï¼‰
å¤åˆ¶ä»£ç 
Bash
kubectl get nodes -o wide
ä½ ä¼šçœ‹åˆ°ï¼š
å¤åˆ¶ä»£ç 
Text
NAME                                           AZ
ip-10-0-xx-xx.ap-southeast-2.compute.internal  ap-southeast-2a
ğŸ‘‰ è¿™ä¸€æ­¥å·²ç»ç²¾ç¡®å¾—åˆ°â€œæŸä¸ª AZ ä¸‹æ‰€æœ‰ nodeâ€ã€‚
äºŒã€åªæƒ³æ‹¿ Node åå­— / EC2 IDï¼ˆç»™ FIS / ASG ç”¨ï¼‰
1ï¸âƒ£ Node â†’ EC2 InstanceId
å¤åˆ¶ä»£ç 
Bash
kubectl get nodes \
  -l topology.kubernetes.io/zone=ap-southeast-2a \
  -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.providerID}{"\n"}{end}'
è¾“å‡ºç¤ºä¾‹ï¼š
å¤åˆ¶ä»£ç 
Text
ip-10-0-1-12.ap-southeast-2.compute.internal   aws:///ap-southeast-2a/i-0abc1234
æå– EC2 IDï¼š
å¤åˆ¶ä»£ç 
Bash
... | awk -F/ '{print $NF}'
ä¸‰ã€AZ â†’ NodeGroupï¼ˆä½ ä¹‹å‰å›°æƒ‘çš„ç‚¹ï¼‰
å¦‚æœä½ æƒ³çŸ¥é“ï¼š
â€œè¿™ä¸ª AZ çš„ node æ¥è‡ªå“ªäº› nodegroupï¼Ÿâ€
å¤åˆ¶ä»£ç 
Bash
kubectl get nodes \
  -l topology.kubernetes.io/zone=ap-southeast-2a \
  -o jsonpath='{range .items[*]}{.metadata.labels.eks\.amazonaws\.com/nodegroup}{"\n"}{end}' \
  | sort -u
è¾“å‡ºï¼š
å¤åˆ¶ä»£ç 
Text
ng-app-az-a
ğŸ‘‰ è¿™ä¸€æ­¥èƒ½åå‘è¯æ˜ï¼š
ä¸€ä¸ª AZ å®é™…ä¸Šå¯¹åº”å“ªäº› NodeGroup åœ¨æ‰¿è½½æµé‡
å››ã€AWS è§†è§’ï¼ˆä¸èµ° kubectlï¼Œæ¬¡ä¼˜ï¼‰
å¦‚æœä½ åªç”¨ AWS APIï¼ˆæ¯”å¦‚åœ¨ CI / Lambda é‡Œï¼‰ï¼š
1ï¸âƒ£ æŸ¥ AZ ä¸‹çš„ EC2ï¼ˆåŸºäº tagï¼‰
EKS èŠ‚ç‚¹é»˜è®¤æœ‰ tagï¼š
å¤åˆ¶ä»£ç 

kubernetes.io/cluster/<cluster-name> = owned
å¤åˆ¶ä»£ç 
Bash
aws ec2 describe-instances \
  --filters \
    "Name=availability-zone,Values=ap-southeast-2a" \
    "Name=tag:kubernetes.io/cluster/<cluster-name>,Values=owned" \
  --query 'Reservations[].Instances[].InstanceId' \
  --output text
âš ï¸ æ³¨æ„ï¼š
è¿™ç§æ–¹å¼ä¸çŸ¥é“ Pod / Node çŠ¶æ€
ä¸å¦‚ kubectl ç²¾ç¡®
äº”ã€ç»“è®ºï¼ˆç»“åˆä½ åš AZ æ•…éšœæ¼”ç»ƒï¼‰
âœ” åŸºäº AZ æ‰¾ nodeï¼Œé¦–é€‰ï¼š
å¤åˆ¶ä»£ç 
Bash
kubectl get nodes -l topology.kubernetes.io/zone=<az>
âœ” AZ æ•…éšœ â†’ FIS / terminate nodeï¼š
AZ â†’ Node
Node â†’ EC2
EC2 â†’ FIS target
âœ” æ˜¯å¦éœ€è¦ NodeGroupï¼Ÿ
ä¸éœ€è¦
ä½†å¦‚æœä½ è¦åš capacity / æ¢å¤éªŒè¯ï¼Œå†åæŸ¥ NodeGroup å³å¯
å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ç›´æ¥ç»™ä½ ä¸€ä¸ª â€œAZ â†’ Node â†’ EC2 â†’ terminate / FIS JSONâ€ çš„å®Œæ•´è„šæœ¬ï¼Œä¸“é—¨é€‚åˆä½ ç°åœ¨åšçš„ AZ æ•…éšœæ¨¡æ‹Ÿåœºæ™¯ã€‚