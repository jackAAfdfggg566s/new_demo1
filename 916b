æ˜ç™½äº†ï¼Œä½ é—®çš„æ˜¯ Lambda æ‰§è¡Œè§’è‰²çš„ Trust Policyï¼Œä¹Ÿå°±æ˜¯ å…è®¸è°æ¥å‡è®¾è¿™ä¸ªè§’è‰²ã€‚

å¯¹äº Lambdaï¼ŒTrust Policy ä¸€èˆ¬æ˜¯ Lambda æœåŠ¡æœ¬èº«å¯ä»¥å‡è®¾è¿™ä¸ªè§’è‰²ã€‚


---

Lambda æ‰§è¡Œè§’è‰² Trust Policy ç¤ºä¾‹

{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "lambda.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}

è¯´æ˜ï¼š

"Service": "lambda.amazonaws.com" â†’ å…è®¸ Lambda æ‰§è¡Œä½¿ç”¨è¿™ä¸ªè§’è‰²ã€‚

Action: "sts:AssumeRole" â†’ æˆæƒ Lambda å‡è®¾æ­¤è§’è‰²ã€‚

è¿™ä¸ªè§’è‰²é…åˆä¹‹å‰æˆ‘å‘ç»™ä½ çš„ Permissions JSON å°±å¯ä»¥ç›´æ¥è®¿é—® RDS Database Insights APIï¼Œå¹¶å†™ CloudWatch è‡ªå®šä¹‰æŒ‡æ ‡ã€‚



---

å¦‚æœä½ æƒ³ï¼Œæˆ‘å¯ä»¥å¸®ä½ æ•´ç†æˆ å®Œæ•´ Lambda IAM Role JSONï¼ˆåŒ…å« Trust Policy + Permissions Policyï¼‰ï¼Œç›´æ¥åœ¨ AWS IAM æ§åˆ¶å°åˆ›å»ºå³å¯ã€‚

ä½ å¸Œæœ›æˆ‘æ•´ç†å—ï¼Ÿ



æ˜ç™½ âœ…ã€‚å¦‚æœä½ è¦ç”¨ Lambda æŠŠ Database Insights çš„ Top SQL æŒ‡æ ‡æ¨é€åˆ° CloudWatch è‡ªå®šä¹‰å¤§ç›˜ï¼Œéœ€è¦ä¸¤ä¸ªè§’è‰²ï¼š


---

1. ç»™ Lambda çš„æ‰§è¡Œè§’è‰² (Execution Role)

Lambda éœ€è¦ è®¿é—® RDS Insights API + å†™ CloudWatch è‡ªå®šä¹‰æŒ‡æ ‡ã€‚

IAM Role JSON (Lambda æ‰§è¡Œè§’è‰²)

{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "rds:DescribeDBInstances",
        "rds:DescribeDBLogFiles",
        "rds:DownloadDBLogFilePortion",
        "rds:DescribeDBInsights",
        "rds:DescribeDBInsightTopSql"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "cloudwatch:PutMetricData"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "*"
    }
  ]
}

ğŸ‘‰ è¯´æ˜ï¼š

rds:DescribeDBInsightTopSql æ˜¯è·å– Top SQL çš„å…³é”® APIã€‚

cloudwatch:PutMetricData ç”¨äºæŠŠç»“æœå†™åˆ°è‡ªå®šä¹‰æŒ‡æ ‡ã€‚

logs:* ç”¨äº Lambda è‡ªå·±å†™æ—¥å¿—ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚



---

2. CloudWatch Dashboard æƒé™ (ç»™è¿ç»´ç”¨æˆ· / Role)

å¦‚æœä½ è¦è®©ç”¨æˆ·èƒ½åœ¨ CloudWatch å¤§ç›˜é‡Œçœ‹åˆ°è¿™ä¸ªæŒ‡æ ‡ï¼Œè¿˜éœ€è¦ï¼š

IAM Policy JSON (CloudWatch Dashboard Viewer)

{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "cloudwatch:GetDashboard",
        "cloudwatch:ListDashboards",
        "cloudwatch:GetMetricData",
        "cloudwatch:ListMetrics"
      ],
      "Resource": "*"
    }
  ]
}


---

3. ä½¿ç”¨åœºæ™¯

Lambda Roleï¼šæ‹‰å– Database Insights â†’ æŠŠ Top SQL çš„ Callsã€Latency ç­‰æŒ‡æ ‡å†™åˆ° CustomNamespace/TopSQLã€‚

CloudWatch Dashboard Roleï¼šç”¨æˆ·åªéœ€è¦èƒ½è¯» Dashboard + è¯»æŒ‡æ ‡ã€‚



---

è¦ä¸è¦æˆ‘ç›´æ¥å¸®ä½ å†™ä¸€ä¸ª Lambda ç¤ºä¾‹ (Python boto3)ï¼ŒæŠŠ Top SQL çš„ æ€»å»¶è¿Ÿ (Total Latency) å’Œ æ‰§è¡Œæ¬¡æ•° (Calls) å†™è¿› CloudWatchï¼Ÿ

