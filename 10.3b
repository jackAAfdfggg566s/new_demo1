å•Šå“ˆğŸ‘Œï¼Œä½ æ˜¯è¯´é…ç½®æ–‡ä»¶é‡Œå…¨æ˜¯å‚æ•°è¡Œï¼Œæ²¡æœ‰ [java] / [log] è¿™ç§åŒºåˆ†æ®µè½ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼Œé…ç½®æ–‡ä»¶å°±æ˜¯ä¸€å †ï¼š

java_home=/usr/bin/java
jar_file=/path/to/myapp.jar
args=--spring.profiles.active=prod
loadtime=30
peak=100
mode=fast
log_file=/path/to/myapp.log
check_field=Started Application
backup_dir=/backup/logs
pid_log=/var/run/myapp.pid

è¿™ç§å½¢å¼ã€‚

é‚£è¿™ç§æƒ…å†µç”¨ configparser å°±ä¸åˆé€‚äº†ï¼ˆå®ƒè¦æ±‚æœ‰ sectionï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ ç®€å•çš„ key=value æ–‡ä»¶è§£æã€‚


---

Python è„šæœ¬ï¼ˆæ—  sectionï¼Œç›´æ¥è§£æ key=valueï¼‰

import os
import subprocess
import shutil
import time

# 1. è¯»å–é…ç½®æ–‡ä»¶ï¼ˆç®€å• key=valueï¼‰
config = {}
with open("config.ini", "r") as f:
    for line in f:
        line = line.strip()
        if not line or line.startswith("#"):
            continue
        if "=" in line:
            key, value = line.split("=", 1)
            config[key.strip()] = value.strip()

# 2. å–å›ºå®šå‚æ•°
java_home = config["java_home"]
jar_file = config["jar_file"]
args = config.get("args", "")

log_file = config["log_file"]
check_field = config["check_field"]
backup_dir = config["backup_dir"]
pid_log = config["pid_log"]

# 3. ç»„è£… -D å‚æ•°ï¼ˆé™¤å»å›ºå®šå­—æ®µï¼‰
java_opts = []
for key, value in config.items():
    if key not in ["java_home", "jar_file", "args", "log_file", "check_field", "backup_dir", "pid_log"]:
        java_opts.append(f"-D{key}={value}")

# 4. æ‹¼æ¥å‘½ä»¤
java_opts_str = " ".join(java_opts)
cmd = f"{java_home} {java_opts_str} -jar {jar_file} {args}"
print(f"å¯åŠ¨å‘½ä»¤: {cmd}")

# 5. å¯åŠ¨ Java ç¨‹åº
proc = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
pid = proc.pid
print(f"Java ç¨‹åºå·²å¯åŠ¨, PID={pid}")

# 6. ä¿å­˜ PID
with open(pid_log, "w") as f:
    f.write(str(pid))

# 7. ç­‰å¾…æ—¥å¿—å¹¶æ£€æŸ¥å­—æ®µ
field_exists = False
for _ in range(30):  # æœ€å¤šæ£€æŸ¥ 30 æ¬¡ï¼ˆçº¦ 30 ç§’ï¼‰
    time.sleep(1)
    if os.path.exists(log_file):
        with open(log_file, "r") as f:
            for line in f:
                if check_field in line:
                    field_exists = True
                    break
    if field_exists:
        break

print(f"å­—æ®µæ£€æŸ¥ç»“æœ: {field_exists}")

# 8. æ‹·è´æ—¥å¿—æ–‡ä»¶
if os.path.exists(log_file):
    os.makedirs(backup_dir, exist_ok=True)
    shutil.copy(log_file, backup_dir)
    print(f"æ—¥å¿—å·²æ‹·è´åˆ° {backup_dir}")
else:
    print("æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•æ‹·è´ã€‚")


---

âœ… ä½¿ç”¨æ•ˆæœ

é…ç½®æ–‡ä»¶ï¼š

java_home=/usr/bin/java
jar_file=/path/to/myapp.jar
args=--spring.profiles.active=prod
loadtime=30
peak=100
mode=fast
log_file=/path/to/myapp.log
check_field=Started Application
backup_dir=/backup/logs
pid_log=/var/run/myapp.pid

æœ€ç»ˆå¯åŠ¨å‘½ä»¤ä¼šå˜æˆï¼š

/usr/bin/java -Dloadtime=30 -Dpeak=100 -Dmode=fast -jar /path/to/myapp.jar --spring.profiles.active=prod


---

è¦ä¸è¦æˆ‘å†å¸®ä½ åŠ ä¸€ä¸ª å¿…å¡«å‚æ•°æ£€æŸ¥ï¼ˆæ¯”å¦‚ java_homeã€jar_fileã€log_fileã€pid_log ä¸€å®šè¦æœ‰ï¼Œå¦åˆ™æŠ¥é”™é€€å‡ºï¼‰ï¼Ÿ

