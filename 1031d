å¥½çš„ ğŸ‘ æˆ‘æ¥å¸®ä½ æ•´ç†ä¸€ä¸ªå®Œæ•´çš„ Ansible Playbook ç¤ºä¾‹ï¼Œå®ç°ä»¥ä¸‹æµç¨‹ï¼š

> ç›®æ ‡ï¼š 1ï¸âƒ£ æœ¬åœ°æ‰¾åˆ° .7z æ–‡ä»¶åï¼ˆå‡è®¾æ˜¯åŠ¨æ€çš„ï¼Œä¸å›ºå®šï¼‰
2ï¸âƒ£ å°†è¯¥æ–‡ä»¶å¤åˆ¶åˆ°è¿œç¨‹æœºå™¨
3ï¸âƒ£ åœ¨è¿œç¨‹æœºå™¨ä¸Šè§£å‹
4ï¸âƒ£ è§£å‹åè¿è¡Œä¸€ä¸ªè¿œç¨‹è„šæœ¬ï¼ˆä¾‹å¦‚ deploy.shï¼‰




---

âœ… ç¤ºä¾‹ Playbookï¼šdeploy.yml

---
- name: Deploy archive and run remote script
  hosts: my_remote
  gather_facts: no
  vars:
    local_dir: "./builds"
    remote_dir: "/opt/app"
    remote_script: "/opt/app/deploy.sh"

  tasks:

    - name: Find .7z file in local directory
      find:
        paths: "{{ local_dir }}"
        patterns: "*.7z"
      register: found_files
      delegate_to: localhost

    - name: Set archive filename variable
      set_fact:
        archive_file: "{{ found_files.files[0].path }}"
      when: found_files.matched > 0

    - name: Copy archive to remote host
      copy:
        src: "{{ archive_file }}"
        dest: "{{ remote_dir }}/"
        mode: '0644'

    - name: Extract archive on remote host
      shell: |
        cd {{ remote_dir }}
        7z x {{ archive_file | basename }} -y
      args:
        chdir: "{{ remote_dir }}"

    - name: Run deploy script on remote host
      shell: |
        chmod +x {{ remote_script }}
        {{ remote_script }}
      args:
        chdir: "{{ remote_dir }}"


---

ğŸ“‚ æ–‡ä»¶ç»“æ„ç¤ºä¾‹

project/
â”‚
â”œâ”€ builds/
â”‚   â””â”€ app_v1.2.7z
â”‚
â”œâ”€ deploy.yml
â””â”€ (è¿œç¨‹æœåŠ¡å™¨ä¸Šæœ‰ deploy.sh)


---

ğŸ§  è¯´æ˜

æ­¥éª¤	æ¨¡å—	ä½œç”¨

â‘ 	findï¼ˆdelegate_to localhostï¼‰	åœ¨æœ¬åœ°æ‰¾ .7z æ–‡ä»¶
â‘¡	set_fact	ä¿å­˜æ‰¾åˆ°çš„æ–‡ä»¶è·¯å¾„
â‘¢	copy	ä¸Šä¼ åˆ°è¿œç¨‹
â‘£	shell	åœ¨è¿œç¨‹è§£å‹
â‘¤	shell	åœ¨è¿œç¨‹æ‰§è¡Œè„šæœ¬



---

ğŸ§ª æ‰§è¡Œå‘½ä»¤

ansible-playbook -i hosts deploy.yml

hosts æ–‡ä»¶ä¸­å®šä¹‰ï¼š

[my_remote]
192.168.1.10 ansible_user=ec2-user ansible_ssh_pass=yourpass ansible_ssh_common_args='-o StrictHostKeyChecking=no'


---

ğŸ’¡ å¯é€‰ä¼˜åŒ–

å¦‚æœæƒ³è‡ªåŠ¨æ‰¾æœ€æ–°çš„ .7z æ–‡ä»¶ï¼š

- name: Get latest .7z file
  set_fact:
    archive_file: "{{ found_files.files | sort(attribute='mtime', reverse=True) | first | default({}) | map(attribute='path') | first }}"


---

æ˜¯å¦å¸Œæœ›æˆ‘å¸®ä½ åŠ ä¸Šåˆ¤æ–­é€»è¾‘ï¼Œæ¯”å¦‚ï¼š

å¦‚æœæ²¡æœ‰æ‰¾åˆ° .7z æ–‡ä»¶åˆ™ç›´æ¥ failï¼›

æˆ–è€…è‡ªåŠ¨åˆ é™¤è¿œç¨‹æ—§ç‰ˆæœ¬ï¼Ÿ