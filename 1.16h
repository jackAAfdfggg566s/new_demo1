å¯ä»¥ï¼Œè€Œä¸”è¿™æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„åœºæ™¯ã€‚å…³é”®é—®é¢˜ä¸æ˜¯ FISï¼Œè€Œæ˜¯ï¼š
ğŸ‘‰ ä½ è¦â€œå¹¶è¡Œè·‘ä¸¤ä¸ªå®éªŒ + åˆ†åˆ«çœ‹ç»“æœ + è¿˜èƒ½åˆ¤æ–­æˆåŠŸ/å¤±è´¥â€ã€‚
ä¸‹é¢æˆ‘ç»™ä½ å¯ç›´æ¥ç”¨çš„å‡ ç§æ ‡å‡†å†™æ³•ï¼ˆä»ç®€å•åˆ°ç”Ÿäº§çº§ï¼‰ï¼Œä½ æŒ‘ä¸€ç§æ”¾åˆ° GitLab CI é‡Œå°±è¡Œã€‚
âœ… æ–¹æ¡ˆ 1ï¼šæœ€ç®€å• â€” å¹¶è¡Œå¯åŠ¨ + å®æ—¶æ‰“å°
å¦‚æœä½ åªæ˜¯æƒ³åŒæ—¶å¯åŠ¨ã€éƒ½èƒ½çœ‹åˆ°è¾“å‡ºï¼š
å¤åˆ¶ä»£ç 
Bash
#!/bin/bash

echo "Starting Experiment A..."
aws fis start-experiment \
  --experiment-template-id EXT-A-123 \
  > >(tee /tmp/fis_a.log) &

echo "Starting Experiment B..."
aws fis start-experiment \
  --experiment-template-id EXT-B-456 \
  > >(tee /tmp/fis_b.log) &

wait

echo "Both experiments finished triggering"
ğŸ‘‰ GitLab é‡Œä½ ä¼šçœ‹åˆ°ï¼š
å¤åˆ¶ä»£ç 

Starting Experiment A...
Starting Experiment B...
{
  "experiment": {...A...}
}
{
  "experiment": {...B...}
}
Both experiments finished triggering
åŒæ—¶è¿˜ä¼šåœ¨æœ¬åœ°ç•™ä¸‹ï¼š
/tmp/fis_a.log
/tmp/fis_b.log
âœ… æ–¹æ¡ˆ 2ï¼šæ›´æ¸…æ™° â€” åˆ†åˆ«å­˜ ID + æ‰“å° + è½®è¯¢çŠ¶æ€
æ›´æ¨èè¿™ç§ï¼ˆè‡ªåŠ¨åŒ–å‹å¥½ï¼‰ï¼š
å¤åˆ¶ä»£ç 
Bash
#!/bin/bash

echo "Launching FIS experiments..."

EXP_A_ID=$(aws fis start-experiment \
  --experiment-template-id EXT-A-123 \
  --query "experiment.id" \
  --output text)

EXP_B_ID=$(aws fis start-experiment \
  --experiment-template-id EXT-B-456 \
  --query "experiment.id" \
  --output text)

echo "Experiment A ID: $EXP_A_ID"
echo "Experiment B ID: $EXP_B_ID"
ç„¶åä½ å¯ä»¥è½®è¯¢çŠ¶æ€ï¼š
å¤åˆ¶ä»£ç 
Bash
while true; do
  STATUS_A=$(aws fis get-experiment --id "$EXP_A_ID" \
    --query "experiment.state.status" --output text)

  STATUS_B=$(aws fis get-experiment --id "$EXP_B_ID" \
    --query "experiment.state.status" --output text)

  echo "A: $STATUS_A | B: $STATUS_B"

  if [[ "$STATUS_A" == "completed" && "$STATUS_B" == "completed" ]]; then
    echo "Both experiments completed"
    break
  fi

  sleep 10
done
GitLab ä¼šæŒç»­æ‰“å°ç±»ä¼¼ï¼š
å¤åˆ¶ä»£ç 

A: running | B: running
A: running | B: running
A: completed | B: completed
Both experiments completed
âœ… æ–¹æ¡ˆ 3ï¼šçœŸæ­£å¹¶è¡Œ + åˆ†åˆ«æ—¥å¿— + å¤±è´¥è‡ªåŠ¨é€€å‡ºï¼ˆCI æ¨èï¼‰
å¤åˆ¶ä»£ç 
Bash
#!/bin/bash
set -euo pipefail

run_fis() {
  local tpl=$1
  local name=$2

  echo "[$name] starting..."

  local exp_id
  exp_id=$(aws fis start-experiment \
    --experiment-template-id "$tpl" \
    --query "experiment.id" \
    --output text)

  echo "[$name] experiment id = $exp_id" | tee "/tmp/${name}.id"

  # ç­‰åˆ°ç»“æŸ
  while true; do
    status=$(aws fis get-experiment --id "$exp_id" \
      --query "experiment.state.status" --output text)

    echo "[$name] status = $status"

    if [[ "$status" == "completed" ]]; then
      return 0
    fi

    if [[ "$status" == "failed" || "$status" == "stopped" ]]; then
      echo "[$name] FAILED!"
      return 1
    fi

    sleep 10
  done
}

run_fis "EXT-A-123" "eks-egress" &
run_fis "EXT-B-456" "rds-ingress" &

wait
ğŸ‘‰ GitLab è¾“å‡ºç¤ºä¾‹ï¼š
å¤åˆ¶ä»£ç 

[eks-egress] starting...
[rds-ingress] starting...
[eks-egress] experiment id = i-abc123
[rds-ingress] experiment id = i-def456
[eks-egress] status = running
[rds-ingress] status = running
...
[eks-egress] status = completed
[rds-ingress] status = completed
âœ… æœ€æ¥è¿‘ä½ åœºæ™¯çš„å»ºè®®ï¼ˆEKS + RDSï¼‰
å¦‚æœä½ æ˜¯åœ¨åšï¼š
å®éªŒ A = æ–­ EKS â†’ RDS (Egress)
å®éªŒ B = æ–­ RDS â† EKS (Ingress)
ä½ å¯ä»¥è¿™æ ·å‘½åï¼Œæ›´æ¸…æ¥šï¼š
å¤åˆ¶ä»£ç 
Bash
run_fis "EXT-EKS-EGRESS" "eks-egress" &
run_fis "EXT-RDS-INGRESS" "rds-ingress" &
å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ å†™å®Œæ•´å¯ç²˜è´´ç‰ˆ GitLab CI
ä½ åªéœ€è¦å‘Šè¯‰æˆ‘ï¼š
ä½ ä¸¤ä¸ª FIS Template ID æ˜¯ä»€ä¹ˆï¼Ÿ
ä¾‹å¦‚ï¼š
EXT-eks-xxxx
EXT-rds-xxxx
ä½ å¸Œæœ›ï¼š
åªå¯åŠ¨ï¼Ÿ
è¿˜æ˜¯å¯åŠ¨ + ç­‰å®Œæˆ + CI æˆåŠŸ/å¤±è´¥åˆ¤æ–­ï¼Ÿ
æˆ‘å¯ä»¥ç»™ä½ å®Œæ•´ `.gitlab-ci.yml + sh è„šæœ¬ï¼Œç›´æ¥èƒ½è·‘ã€‚