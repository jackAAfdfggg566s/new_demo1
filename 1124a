ä½ é‡åˆ°çš„è¿™ä¸ªé—®é¢˜éå¸¸å…¸å‹ï¼š
æŠŠ !reference æ”¾åœ¨ script çš„å¤šè¡Œå­—ç¬¦ä¸²é‡Œï¼ˆ| æˆ– - |ï¼‰ï¼ŒGitLab ä¼šæŠŠå®ƒå½“æˆ shell æ–‡å­—å»æ‰§è¡Œ â†’ å½“ç„¶ !reference å°±å˜æˆ â€œå‘½ä»¤ä¸å­˜åœ¨â€ã€‚

ä¾‹å¦‚ä½ ç°åœ¨å¯èƒ½å†™äº†è¿™æ ·ï¼š

script:
  - |
    case "$C1_ENV" in
      env1) !reference [.comp1_env1, script] ;;   # âŒ ä¼šè¢«å½“æˆ shell å‘½ä»¤
    esac

GitLab ä¼šå±•å¼€æˆï¼š

!reference .comp1_env1 script

â†’ Shell æ‰§è¡Œ â†’ command not found


---

âœ… æ­£ç¡®å†™æ³•ï¼ˆå¿…é¡»è®© !reference æˆä¸º script åˆ—è¡¨é¡¹ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²å†…å®¹ï¼‰

âš  !reference åªèƒ½ä½œä¸º YAML åˆ—è¡¨é¡¹
âš  ä¸èƒ½æ”¾åœ¨å­—ç¬¦ä¸²é‡Œï¼Œä¹Ÿä¸èƒ½æ”¾åœ¨ case/if/for é‡Œé¢
âš  GitLab YAML æ˜¯é™æ€å±•å¼€ï¼Œshell ä¸è®¤è¯† !reference

æ‰€ä»¥ä¸èƒ½ç”¨ case + referenceï¼Œè¿™æ˜¯ GitLab é™åˆ¶ã€‚


---

é‚£ä¹ˆå¦‚ä½•å®ç°"åŠ¨æ€ç»„åˆé€‰æ‹©"ï¼Ÿ

ä½ åªæœ‰ ä¸¤ç§å®Œå…¨å¯è¡Œ çš„æ–¹æ¡ˆï¼š


---

âœ… æ–¹æ¡ˆ 1ï¼šæ¯ä¸ªç»„ä»¶-ç¯å¢ƒç»„åˆæ˜¯ç‹¬ç«‹ job + rules æ§åˆ¶ï¼ˆæ¨èï¼‰

GitLab æœ¬èº«å°±æ˜¯â€œç”¨ rules å†³å®šå“ªä¸ª job è¿è¡Œâ€ã€‚
ä½ è¦å››ç§ç»„åˆï¼Œå°±å®šä¹‰å››ä¸ª jobï¼Œæ²¡æœ‰é‡å¤ä»£ç ï¼Œå› ä¸º script å¯ä»¥ referenceï¼š

1. å®šä¹‰å¯å¤ç”¨è„šæœ¬å—

.comp1_env1: &C1E1
  script:
    - echo "comp1 env1"
    - ./comp1_env1.sh

.comp1_env2: &C1E2
  script:
    - echo "comp1 env2"
    - ./comp1_env2.sh

.comp2_env1: &C2E1
  script:
    - echo "comp2 env1"
    - ./comp2_env1.sh

.comp2_env2: &C2E2
  script:
    - echo "comp2 env2"
    - ./comp2_env2.sh

2. å››ä¸ªç»„åˆï¼Œåªè¿è¡Œä¸€ä¸ªï¼Œä¸é‡å¤ä»£ç 

combo_c1e1_c2e1:
  rules:
    - if: '$C1_ENV == "env1" && $C2_ENV == "env1"'
  script:
    - !reference [.comp1_env1, script]
    - !reference [.comp2_env1, script]

combo_c1e1_c2e2:
  rules:
    - if: '$C1_ENV == "env1" && $C2_ENV == "env2"'
  script:
    - !reference [.comp1_env1, script]
    - !reference [.comp2_env2, script]

combo_c1e2_c2e1:
  rules:
    - if: '$C1_ENV == "env2" && $C2_ENV == "env1"'
  script:
    - !reference [.comp1_env2, script]
    - !reference [.comp2_env1, script]

combo_c1e2_c2e2:
  rules:
    - if: '$C1_ENV == "env2" && $C2_ENV == "env2"'
  script:
    - !reference [.comp1_env2, script]
    - !reference [.comp2_env2, script]

ä¼˜ç‚¹

å®Œå…¨æ— é‡å¤ä»£ç ï¼ˆå››ä¸ªç»„åˆçš„ script éƒ½ä»…å¼•ç”¨ï¼‰

åªè¿è¡Œä¸€ä¸ª job

!reference æ­£ç¡®å±•å¼€ï¼Œä¸ä¼š command not found

ç»“æ„æ¸…æ™°ã€å¯ç»´æŠ¤æ€§å¼º


GitLab å®˜æ–¹æ¨èç”¨ rules åš job é€‰æ‹©ï¼Œä¸æ¨èåœ¨åŒä¸€ä¸ª job é‡Œæâ€œåŠ¨æ€è„šæœ¬â€ã€‚


---

â— æ–¹æ¡ˆ 2ï¼ˆä½ ä¹‹å‰å°è¯•çš„ï¼‰ï¼šå• job + case + reference

âš  GitLab ä¸æ”¯æŒã€‚

å› ä¸ºï¼š

!reference åªèƒ½æ˜¯ YAML çš„ä¸€ä¸ªåˆ—è¡¨é¡¹

shell é‡Œä¸èƒ½å†™å®ƒï¼ˆä¼šè¢«å½“æˆå‘½ä»¤ï¼‰


æ‰€ä»¥æ°¸è¿œä¼šæŠ¥ï¼š

!reference: command not found

è¿™æ˜¯ GitLab çš„ç¡¬é™åˆ¶ï¼Œä¸æ˜¯ä½ å†™é”™ã€‚


---

ğŸ¯ ç»“è®ºï¼ˆæœ€é è°±ï¼‰

ä½ ä¸èƒ½åœ¨ä¸€ä¸ª job é‡ŒåŠ¨æ€é€‰æ‹© referenceã€‚å¿…é¡»ä½¿ç”¨å¤šä¸ª job + rules é€‰æ‹©æ‰§è¡Œå“ªä¸ªã€‚

åè€Œè¿™æ ·çš„ç»“æ„æ˜¯ GitLab å®˜æ–¹æ¨èçš„ï¼Œè€Œä¸”ä¸ä¼šé‡å¤ä»£ç ï¼Œå› ä¸ºæ‰€æœ‰é€»è¾‘éƒ½é›†ä¸­åœ¨ re-usable reference å—é‡Œã€‚


---

ğŸ“Œ å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥æ ¹æ®ä½ çš„çœŸå®ç»„ä»¶åã€ç¯å¢ƒåï¼Œå¸®ä½ ç”Ÿæˆæœ€ç»ˆå¯ç”¨çš„ YAMLï¼ˆæœ€ç®€ã€æœ€å¹²å‡€ï¼‰ã€‚

ä½ åªè¦å‘Šè¯‰æˆ‘ï¼š

ç»„ä»¶ 1 åå­—

ç»„ä»¶ 2 åå­—

ä¸¤ä¸ªç¯å¢ƒåå­—ï¼ˆenv1/env2ï¼Ÿdev/prodï¼Ÿï¼‰


æˆ‘å°±ç»™ä½ å®Œæ•´æˆå“ã€‚