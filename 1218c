æ˜ç™½äº† ğŸ‘
ä½ æ˜¯æƒ³ åœ¨ job é‡Œæ ¹æ® variable åšåˆ¤æ–­ï¼ˆshell / before_script é‡Œï¼‰ï¼Œè€Œä¸æ˜¯ç”¨ rules æ§åˆ¶ job æ˜¯å¦è¿è¡Œã€‚
è¿™ä¸ªåœ¨ EKS + å¤šç¯å¢ƒå¤ç”¨ åœºæ™¯æ˜¯å®Œå…¨å¯ä»¥ã€è€Œä¸”å¾ˆå¸¸è§çš„ã€‚

ä¸‹é¢ç»™ä½  æ­£ç¡®ã€å¯ç»´æŠ¤ã€ä¸è¸©å‘ çš„åšæ³•ã€‚


---

ä¸€ã€æ ¸å¿ƒç»“è®ºï¼ˆå…ˆç»™ç­”æ¡ˆï¼‰

âœ… å¯ä»¥æ ¹æ® variable åˆ¤æ–­
âœ… é€»è¾‘æ”¾åœ¨ã€Œå…¬å…±æ¨¡æ¿ã€é‡Œ
âŒ ä¸è¦åœ¨æ¯ä¸ª job é‡Œå†™ if


---

äºŒã€æ¨èç»“æ„ï¼ˆåªå†™ä¸€æ¬¡åˆ¤æ–­ï¼‰

1ï¸âƒ£ å…¬å…±æ¨¡æ¿ï¼šåœ¨ before_script é‡Œåˆ¤æ–­å˜é‡

.eks_base:
  image: amazon/aws-cli:2
  stage: deploy
  before_script:
    - |
      echo "ENV = $ENV"

      if [ "$ENV" = "dev" ]; then
        export AWS_REGION="ap-southeast-2"
        export EKS_CLUSTER_NAME="my-eks-dev"
      elif [ "$ENV" = "prod" ]; then
        export AWS_REGION="ap-southeast-2"
        export EKS_CLUSTER_NAME="my-eks-prod"
      else
        echo "Unknown ENV: $ENV"
        exit 1
      fi

      aws eks update-kubeconfig \
        --region "$AWS_REGION" \
        --name "$EKS_CLUSTER_NAME"

      kubectl config current-context
  script:
    - kubectl get ns

ğŸ‘‰ åˆ¤æ–­é€»è¾‘é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹


---

2ï¸âƒ£ Job åªä¼ å˜é‡ï¼ˆä¸å†™é€»è¾‘ï¼‰

deploy_dev:
  extends: .eks_base
  variables:
    ENV: dev

deploy_prod:
  extends: .eks_base
  variables:
    ENV: prod


---

ä¸‰ã€å¦‚æœä½ ç¯å¢ƒå¤šäº 2 ä¸ªï¼ˆæ›´ä¼˜é›…ï¼‰

ç”¨ caseï¼Œæ¯” if å¥½ç»´æŠ¤

case "$ENV" in
  dev)
    AWS_REGION="ap-southeast-2"
    EKS_CLUSTER_NAME="my-eks-dev"
    ;;
  staging)
    AWS_REGION="ap-southeast-2"
    EKS_CLUSTER_NAME="my-eks-staging"
    ;;
  prod)
    AWS_REGION="ap-southeast-2"
    EKS_CLUSTER_NAME="my-eks-prod"
    ;;
  *)
    echo "Unsupported ENV: $ENV"
    exit 1
    ;;
esac


---

å››ã€è¿›é˜¶ï¼šå˜é‡ â†’ mapï¼ˆæœ€å¹²å‡€å†™æ³•ï¼‰

å¦‚æœä½ è®¨åŒ if / case ğŸ‘‡

.eks_base:
  before_script:
    - |
      declare -A CLUSTER_MAP=(
        [dev]="ap-southeast-2 my-eks-dev"
        [prod]="ap-southeast-2 my-eks-prod"
      )

      if [ -z "${CLUSTER_MAP[$ENV]}" ]; then
        echo "Invalid ENV: $ENV"
        exit 1
      fi

      read AWS_REGION EKS_CLUSTER_NAME <<< "${CLUSTER_MAP[$ENV]}"

      aws eks update-kubeconfig \
        --region "$AWS_REGION" \
        --name "$EKS_CLUSTER_NAME"


---

äº”ã€ä»€ä¹ˆæ—¶å€™ã€Œå˜é‡åˆ¤æ–­ã€æ˜¯å¯¹çš„ï¼Ÿ

âœ”ï¸ ç¯å¢ƒå…±äº«åŒä¸€å¥— job
âœ”ï¸ åªæ˜¯å‚æ•°ä¸åŒï¼ˆcluster / region / namespaceï¼‰
âœ”ï¸ ä½ æƒ³ä¸€ä¸ª job è·‘å¤šä¸ªç¯å¢ƒï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰


---

å…­ã€ä»€ä¹ˆæ—¶å€™ä¸è¯¥è¿™æ ·ï¼Ÿ

âŒ prod / dev æµç¨‹å·®å¼‚å¾ˆå¤§
âŒ æƒé™å®Œå…¨ä¸åŒ
âŒ éœ€è¦ä¸åŒ approvalï¼ˆè¿™æ—¶ç”¨ rulesï¼‰


---

ä¸ƒã€æ€»ç»“ä¸€å¥è¯

> extends å¤ç”¨ç»“æ„ï¼Œvariable å†³å®šè¡Œä¸ºï¼Œåˆ¤æ–­é€»è¾‘é›†ä¸­åœ¨æ¨¡æ¿



ä½ è¿™ä¸ªéœ€æ±‚æ˜¯ å®Œå…¨æ­£ç¡®çš„ç”¨æ³• ğŸ‘


---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ä¸‹ä¸€æ­¥å¸®ä½ ï¼š

ğŸ” æŠŠ AWS å‡­è¯æ”¹æˆ OIDCï¼ˆä¸å­˜ keyï¼‰

ğŸ§¹ æŠŠåˆ¤æ–­é€»è¾‘æŠ½æˆ å•ç‹¬ shell è„šæœ¬

ğŸ§  è¯„ä¼°ä½ ç°åœ¨ç”¨ variable åˆ¤æ–­æ˜¯ä¸æ˜¯æ¯” rules æ›´åˆé€‚


ä½ ç°åœ¨æ˜¯ æ‰‹åŠ¨è§¦å‘ä¼  ENVï¼Œè¿˜æ˜¯ pipeline variable é»˜è®¤å€¼ï¼Ÿ