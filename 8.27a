ğŸ‘Œ å¦‚æœä½ ä¸æƒ³ç”¨ Lambdaï¼Œè¿˜æœ‰å‡ ç§å¸¸è§æ–¹å¼å¯ä»¥æŠŠ Top SQL çš„æŒ‡æ ‡å†™åˆ° CloudWatch Custom Metricsï¼Œæˆ‘æŒ‰å¸¸è§æ–¹æ¡ˆå¸®ä½ åˆ—å‡ºæ¥ï¼š


---

ğŸ”¹ æ–¹æ¡ˆ 1: ç›´æ¥ç”¨ AWS CLI + CloudWatch put-metric-data

ä½ å¯ä»¥å†™ä¸€ä¸ª shell è„šæœ¬ + cronjob è·‘åœ¨ä¸€å° EC2 æˆ–æœ¬åœ°æœåŠ¡å™¨ä¸Šï¼š

#!/bin/bash
DB_ID="your-db-identifier"
END=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
START=$(date -u -d "-5 minutes" +"%Y-%m-%dT%H:%M:%SZ")

# Step1: æ‹‰Top SQL
RESULT=$(aws rds describe-dimension-keys \
  --service-type RDS \
  --identifier $DB_ID \
  --start-time $START \
  --end-time $END \
  --metric DBLoad \
  --group-by Dimension=sql \
  --max-results 5)

# Step2: è§£æå¹¶å†™å…¥CloudWatch
echo $RESULT | jq -c '.Keys[]' | while read row; do
    SQLHASH=$(echo $row | jq -r '.Dimensions.sql')
    VALUE=$(echo $row | jq -r '.Total')

    aws cloudwatch put-metric-data \
      --namespace "Custom/TopSQL" \
      --metric-name "DBLoad" \
      --dimensions DBIdentifier=$DB_ID,SQLHash=$SQLHASH \
      --timestamp $END \
      --value $VALUE \
      --unit Count
done

ğŸ‘‰ æ”¾åˆ° cron é‡Œï¼Œæ¯ 5 åˆ†é’Ÿè·‘ä¸€æ¬¡ï¼Œå°±èƒ½æŒç»­æŠŠæŒ‡æ ‡å†™åˆ° CloudWatchã€‚


---

ğŸ”¹ æ–¹æ¡ˆ 2: CloudWatch Agent + StatsD

å¦‚æœä½ æœ‰è‡ªå·±çš„ ä¸­é—´å±‚åº”ç”¨ï¼ˆEC2ã€ECSã€EKSï¼‰ï¼Œå¯ä»¥ï¼š

1. åœ¨åº”ç”¨é‡Œè°ƒç”¨ RDS Performance Insights API æ‹¿åˆ°æŒ‡æ ‡ã€‚


2. é€šè¿‡ StatsD/collectd æŠŠè¿™äº›æŒ‡æ ‡å†™åˆ°æœ¬åœ° CloudWatch Agentã€‚


3. CloudWatch Agent ä¼šè‡ªåŠ¨æ¨é€åˆ° CloudWatch Custom Metricsã€‚



é€‚åˆå·²æœ‰ metrics pipeline çš„å›¢é˜Ÿã€‚


---

ğŸ”¹ æ–¹æ¡ˆ 3: AWS Glue / Step Functions + CloudWatch

ç”¨ Glueï¼ˆå®šæ—¶ ETL Jobï¼‰æˆ–è€… Step Functions è°ƒåº¦ï¼š

Step1: è°ƒ RDS PI API æ‹‰æŒ‡æ ‡ã€‚

Step2: å†™åˆ° CloudWatch Metricsï¼ˆæˆ– S3 â†’ Athena â†’ QuickSightï¼‰ã€‚


å¥½å¤„ï¼šæ—  serverless ä»£ç ï¼Œèµ°æ•°æ®ç®¡é“ã€‚

ç¼ºç‚¹ï¼šæˆæœ¬æ¯” cronjob/Lambda é«˜ã€‚



---

ğŸ”¹ æ–¹æ¡ˆ 4: ç¬¬ä¸‰æ–¹ç›‘æ§ç³»ç»Ÿï¼ˆGrafana/Prometheus Exporterï¼‰

ä½ å¯ä»¥ç”¨ Grafana CloudWatch pluginï¼Œç›´æ¥ç”» RDS Performance Insights Metricsï¼ˆä¸è¿‡åªæœ‰é™å®šç»´åº¦ï¼‰ã€‚

å¦‚æœæƒ³å±•ç¤º Top SQLï¼š

è‡ªå·±å†™ä¸€ä¸ª Prometheus exporterï¼ˆæ‹‰ PI API â†’ expose /metricsï¼‰ã€‚

Prometheus + Grafana å°±èƒ½æ˜¾ç¤º SQL çº§åˆ«çš„ç›‘æ§äº†ã€‚




---

âœ… å¦‚æœåªæ˜¯æƒ³è¦ CloudWatch Dashboard é‡Œçœ‹ Top SQLï¼šæœ€ç®€å•çš„æ˜¯ æ–¹æ¡ˆ 1ï¼ˆCLI+cronjobï¼‰ã€‚
âœ… å¦‚æœå›¢é˜Ÿæœ‰ç›‘æ§ç³»ç»Ÿï¼ˆGrafana/Prometheusï¼‰ï¼Œæ¨è æ–¹æ¡ˆ 4ã€‚


---

è¦ä¸è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ª å®Œæ•´ cronjob + jq è„šæœ¬ç‰ˆæœ¬ï¼ˆå¸¦ SQLHashâ†’SQLText æ˜ å°„ï¼‰ï¼Œè¿™æ ·ä½ èƒ½ç›´æ¥åœ¨ CloudWatch å¤§ç›˜é‡Œæ˜¾ç¤º SQL è¯­å¥è€Œä¸æ˜¯ hashï¼Ÿ

