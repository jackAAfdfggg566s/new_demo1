è¿è¡Œ AWS Fault Injection Simulator (FIS)ï¼ˆä½ è¿™ä¸ªåœºæ™¯ï¼šTerminate EC2 + ASG insufficient capacity + EKS NodeGroupï¼‰éœ€è¦çš„æƒé™ä¸æ­¢ä¸€ä¸ªæœåŠ¡ï¼Œè€Œæ˜¯ä¸€ç»„ FIS + EC2 + ASG + IAMï¼ˆPassRoleï¼‰ çš„ç»„åˆæƒé™ã€‚
æˆ‘æŒ‰**â€œæœ€å°å¯ç”¨ + ç”Ÿäº§å¯è½åœ°â€**ç»™ä½ æ‹†æ¸…æ¥šã€‚
ä¸€ã€æ ¸å¿ƒæ¦‚å¿µï¼ˆå…ˆç†è§£ï¼Œä¸ç„¶æƒé™çœ‹ä¸æ‡‚ï¼‰
è¿è¡Œ FIS å®éªŒæ—¶ï¼Œæ¶‰åŠ ä¸¤ç§ IAM Roleï¼š
1ï¸âƒ£ å¯åŠ¨å®éªŒçš„äºº / CI ç”¨çš„ Role
ğŸ‘‰ ç”¨æ¥ Create / Start Experiment
2ï¸âƒ£ FIS æ‰§è¡Œè§’è‰²ï¼ˆexecutionRoleArnï¼‰
ğŸ‘‰ çœŸæ­£å» æ€å®ä¾‹ / æ³¨å…¥ ASG é”™è¯¯ çš„è§’è‰²
âš ï¸ è¿™æ˜¯æœ€å®¹æ˜“æ¼çš„
äºŒã€ä½ å¿…é¡»å…·å¤‡çš„ 3 ç±»æƒé™
1ï¸âƒ£ FIS æœ¬èº«çš„æƒé™ï¼ˆå¿…éœ€ï¼‰
ç”¨äºåˆ›å»ºã€å¯åŠ¨ã€æŸ¥çœ‹å®éªŒï¼š
å¤åˆ¶ä»£ç 
Json
{
  "Effect": "Allow",
  "Action": [
    "fis:CreateExperimentTemplate",
    "fis:UpdateExperimentTemplate",
    "fis:DeleteExperimentTemplate",
    "fis:StartExperiment",
    "fis:StopExperiment",
    "fis:GetExperiment",
    "fis:ListExperiments",
    "fis:GetExperimentTemplate",
    "fis:ListExperimentTemplates"
  ],
  "Resource": "*"
}
âœ… æ²¡è¿™äº›ï¼Œä½ è¿æ¨¡æ¿éƒ½å»ºä¸äº†ã€‚
2ï¸âƒ£ FIS Execution Role çš„æƒé™ï¼ˆæœ€å…³é”®ï¼‰
è¿™æ˜¯ä½ åœ¨ template é‡Œå†™çš„ï¼š
å¤åˆ¶ä»£ç 
Json
"roleArn": "arn:aws:iam::<account-id>:role/FISExecutionRole"
è¿™ä¸ª Role å¿…é¡»èƒ½çœŸçš„â€œåŠ¨èµ„æºâ€ã€‚
ğŸ”¥ A. EC2 Terminate Instanceï¼ˆæ€ Nodeï¼‰
å¤åˆ¶ä»£ç 
Json
{
  "Effect": "Allow",
  "Action": [
    "ec2:TerminateInstances",
    "ec2:DescribeInstances",
    "ec2:DescribeInstanceStatus"
  ],
  "Resource": "*"
}
ğŸ”¥ B. ASG Insufficient Capacity æ³¨å…¥ï¼ˆä½ çš„é‡ç‚¹ï¼‰
å¤åˆ¶ä»£ç 
Json
{
  "Effect": "Allow",
  "Action": [
    "autoscaling:SetInstanceProtection",
    "autoscaling:DescribeAutoScalingGroups",
    "autoscaling:DescribeAutoScalingInstances",
    "autoscaling:UpdateAutoScalingGroup"
  ],
  "Resource": "*"
}
âš ï¸ æ²¡æœ‰è¿™äº›ï¼Œä½ ä¼šçœ‹åˆ°ï¼š unexpected target instance found in action injectInsufficientCapacity
ğŸ”¥ C. EKS / NodeGroup åªéœ€è¦ Describe
FIS ä¸ä¼šç›´æ¥æ“ä½œ EKS APIï¼Œä½†éœ€è¦æŸ¥å…ƒæ•°æ®ï¼š
å¤åˆ¶ä»£ç 
Json
{
  "Effect": "Allow",
  "Action": [
    "eks:DescribeNodegroup",
    "eks:DescribeCluster"
  ],
  "Resource": "*"
}
3ï¸âƒ£ iam:PassRoleï¼ˆ90% çš„äººå¡åœ¨è¿™ï¼‰
â—è¿™æ˜¯æœ€å¸¸è§æŠ¥é”™æ¥æº
å½“ä½  StartExperiment æ—¶ï¼ŒAWS ä¼šæ ¡éªŒï¼š
â€œä½ æœ‰æ²¡æœ‰æƒé™è®© FIS ä½¿ç”¨ execution roleï¼Ÿâ€
ä½ éœ€è¦è¿™ä¸ªæƒé™ï¼ˆç»™å¯åŠ¨å®éªŒçš„äººï¼‰ï¼š
å¤åˆ¶ä»£ç 
Json
{
  "Effect": "Allow",
  "Action": "iam:PassRole",
  "Resource": "arn:aws:iam::<account-id>:role/FISExecutionRole"
}
å¦‚æœæ²¡æœ‰ï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼ï¼š
å¤åˆ¶ä»£ç 

AccessDeniedException: User is not authorized to perform iam:PassRole
å››ã€å®˜æ–¹æ¨èçš„ Execution Role Trust Policyï¼ˆåˆ«æ¼ï¼‰
FIS æ‰§è¡Œè§’è‰²å¿…é¡»ä¿¡ä»» fis.amazonaws.com
å¤åˆ¶ä»£ç 
Json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "fis.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
äº”ã€å®Œæ•´æƒé™å…³ç³»å›¾ï¼ˆæ–‡å­—ç‰ˆï¼‰
å¤åˆ¶ä»£ç 

ä½  / CI
 â”œâ”€ fis:StartExperiment
 â”œâ”€ iam:PassRole
 â†“
FISExecutionRole
 â”œâ”€ ec2:TerminateInstances
 â”œâ”€ autoscaling:UpdateAutoScalingGroup
 â”œâ”€ autoscaling:SetInstanceProtection
 â”œâ”€ eks:Describe*
å…­ã€æœ€å°å¯è¿è¡Œæƒé™ï¼ˆå®æˆ˜æ€»ç»“ï¼‰
âœ… å¯åŠ¨å®éªŒçš„äºº
fis:*
iam:PassRole (execution role)
âœ… FIS Execution Role
ec2:TerminateInstances
autoscaling:Describe*
autoscaling:UpdateAutoScalingGroup
autoscaling:SetInstanceProtection
eks:Describe*
ä¸ƒã€å¼ºçƒˆå»ºè®®çš„å®‰å…¨å®è·µï¼ˆç”Ÿäº§ç»éªŒï¼‰
1ï¸âƒ£ Execution Role å•ç‹¬å»ºï¼Œä¸å¤ç”¨ç®¡ç†å‘˜è§’è‰²
2ï¸âƒ£ é™åˆ¶ Resourceï¼ˆå¦‚æœä½ èƒ½åšåˆ°ï¼‰
3ï¸âƒ£ åªåœ¨æ¼”ç»ƒçª—å£ä¸´æ—¶æˆäºˆ iam:PassRole
4ï¸âƒ£ Template å…ˆ Dry-runï¼ˆå° percentageï¼‰
å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ï¼š
ğŸ”§ ç»™ä½ ä¸€ä»½ å®Œæ•´å¯ç›´æ¥ç”¨çš„ IAM Policy JSONï¼ˆæœ€å°æƒé™ï¼‰
ğŸ” å¸®ä½ å¯¹ç…§ä½ ç°åœ¨çš„æŠ¥é”™ï¼Œç²¾ç¡®å®šä½æ˜¯ç¼ºå“ªæ¡æƒé™
ğŸ§ª ç»™ä½ ä¸€ä¸ª FIS + EKS ä¸“ç”¨çš„æƒé™ Checklist
ä½ é€‰ä¸€ä¸ªï¼Œæˆ‘ç›´æ¥ç»™ã€‚