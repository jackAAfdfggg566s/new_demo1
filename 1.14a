ä¸‹é¢ç»™ä½ ä¸€ä¸ªå¯ç›´æ¥ç”¨çš„ sh å‡½æ•°ï¼Œé€»è¾‘æ˜¯ï¼š
éå† EKS ä¸­æŒ‡å®šçš„ 3 ä¸ª Pod
é€šè¿‡ Pod â†’ Node â†’ AZ
åªè¦ AZ å±äº az1 æˆ– az2
å°±æŠŠ å¯¹åº”çš„ subnetï¼ˆé€šè¿‡ node çš„ providerID / æ ‡ç­¾ï¼‰å­˜è¿›æ•°ç»„
æœ€åè¿”å›è¿™ä¸ªæ•°ç»„ï¼ˆecho è¾“å‡ºï¼Œä¾¿äº pipeline / è°ƒç”¨æ–¹æ¥æ”¶ï¼‰
é€‚åˆï¼šGitLab CI / bash / sh
ä¾èµ–ï¼škubectlã€jq
ä¸€ã€æ ¸å¿ƒæ€è·¯ï¼ˆä½ ç°åœ¨çš„éœ€æ±‚ï¼‰
å¤åˆ¶ä»£ç 
Text
pod
 â†’ nodeName
   â†’ topology.kubernetes.io/zone (AZ ID / name)
   â†’ node.spec.providerID (instance-id)
     â†’ æŸ¥ subnet
äºŒã€ç¤ºä¾‹ï¼šsh å‡½æ•°ï¼ˆAZ = az1 / az2ï¼‰
âš ï¸ æ³¨æ„
è¿™é‡Œå‡è®¾ AZ ID æ˜¯ apse2-az1 / apse2-az2
å¦‚æœä½ ç”¨çš„æ˜¯ ap-southeast-2a è¿™ç§åå­—ï¼Œæˆ‘å¯ä»¥ç»™ä½ æ”¹ä¸€ç‰ˆ
å¤åˆ¶ä»£ç 
Sh
get_subnets_from_pods() {
  NAMESPACE="$1"
  PODS="$2"   # ç©ºæ ¼åˆ†éš”çš„ pod å

  RESULT_SUBNETS=""

  for POD in $PODS; do
    # 1. pod -> node
    NODE=$(kubectl get pod "$POD" -n "$NAMESPACE" -o jsonpath='{.spec.nodeName}')

    [ -z "$NODE" ] && continue

    # 2. node -> az id
    AZ=$(kubectl get node "$NODE" -o jsonpath='{.metadata.labels.topology\.kubernetes\.io/zone}')

    case "$AZ" in
      apse2-az1|apse2-az2)
        ;;
      *)
        continue
        ;;
    esac

    # 3. node -> instance id
    PROVIDER_ID=$(kubectl get node "$NODE" -o jsonpath='{.spec.providerID}')
    INSTANCE_ID=$(echo "$PROVIDER_ID" | awk -F/ '{print $NF}')

    # 4. instance -> subnet
    SUBNET_ID=$(aws ec2 describe-instances \
      --instance-ids "$INSTANCE_ID" \
      --query 'Reservations[0].Instances[0].SubnetId' \
      --output text)

    # 5. ä¿å­˜åˆ°æ•°ç»„ï¼ˆå»é‡ï¼‰
    case " $RESULT_SUBNETS " in
      *" $SUBNET_ID "*) ;;
      *) RESULT_SUBNETS="$RESULT_SUBNETS $SUBNET_ID" ;;
    esac
    ;;
  done

  echo "$RESULT_SUBNETS"
}
ä¸‰ã€è°ƒç”¨æ–¹å¼ç¤ºä¾‹
å¤åˆ¶ä»£ç 
Sh
PODS="pod-a pod-b pod-c"

SUBNETS=$(get_subnets_from_pods default "$PODS")

echo "Matched subnets: $SUBNETS"
è¾“å‡ºç±»ä¼¼ï¼š
å¤åˆ¶ä»£ç 
Text
subnet-0a123 subnet-0b456
ğŸ‘‰ éå¸¸é€‚åˆç›´æ¥å¡è¿› FIS / JSON / for loop
å››ã€å¦‚æœä½  ä¸æƒ³è°ƒ AWS APIï¼ˆæ›´å¿«ï¼‰
ğŸ‘‰ EKS node ä¸Šé€šå¸¸æœ‰ subnet æ ‡ç­¾
å¤åˆ¶ä»£ç 
Sh
SUBNET=$(kubectl get node "$NODE" -o jsonpath='{.metadata.labels.eks\.amazonaws\.com/subnet-id}')
æˆ‘å¯ä»¥ç»™ä½ æ”¹æˆ çº¯ kubectl ç‰ˆï¼ˆæ—  aws cliï¼‰
äº”ã€ä½ å¯èƒ½æ¥ä¸‹æ¥ä¼šé—®çš„ï¼ˆæˆ‘å…ˆè¯´ï¼‰
âœ… AZ æ˜¯ name è¿˜æ˜¯ zone-idï¼ˆ2a vs az1ï¼‰
âœ… subnet è¦ä¸è¦ å»é‡
âœ… è¿”å›æ ¼å¼ï¼š
ç©ºæ ¼åˆ†éš”
JSON array
ç›´æ¥å†™æ–‡ä»¶ï¼ˆGitLab artifactï¼‰
âœ… pod æ•°é‡æ˜¯ å›ºå®š 3 ä¸ª è¿˜æ˜¯åŠ¨æ€
ğŸ‘‰ ä½ å‘Šè¯‰æˆ‘ AZ çš„å®é™…å€¼æ ¼å¼ + subnet æƒ³æ€ä¹ˆè¿”å›ï¼Œæˆ‘å¯ä»¥ç›´æ¥ç»™ä½ ä¸€ç‰ˆ æœ€ç»ˆç”Ÿäº§å¯ç”¨è„šæœ¬ã€‚