éå¸¸å…³é”®çš„ä¿¡æ¯ï¼ä½ ç°åœ¨çš„æƒ…å†µï¼Œå…¶å®æ­ç¤ºäº†ä¸€ä¸ªGitLab Runner çš„åº•å±‚è¡Œä¸ºå·®å¼‚ï¼Œæˆ‘ä»¬æ¥ç²¾å‡†æ‹†è§£ä½ çš„é—®é¢˜å’ŒçœŸå®åŸå› ï¼š


---

â—é—®é¢˜å¤ç°é€»è¾‘ï¼š

æ“ä½œé¡ºåº	çŠ¶æ€	æ˜¯å¦èƒ½å®æ—¶çœ‹åˆ°æ—¥å¿—

æ‰‹åŠ¨è¿è¡Œ Javaï¼ˆSSH ç™»å½•æ‰‹åŠ¨å¯åŠ¨ï¼‰ â†’ pipeline tail	âœ… æ­£å¸¸ï¼Œæ—¥å¿—èƒ½å®æ—¶è¾“å‡º	
pipeline å¯åŠ¨ Java â†’ pipeline tail	âŒ ä¸å®æ—¶ï¼Œæ—¥å¿—æœ€åæ‰åˆ·å‡ºæ¥	



---

âœ… æ ¹æœ¬åŸå› ï¼š

è¿™æ˜¯å› ä¸ºä½ åœ¨ GitLab CI ä¸­ç”¨ SSH å¯åŠ¨ Java æ—¶ï¼Œå®ƒæ˜¯éäº¤äº’å¼ä¼šè¯ï¼Œå¯åŠ¨å‡ºæ¥çš„ Java è¿›ç¨‹å¯èƒ½ä¼šï¼š

1. ç»§æ‰¿ GitLab runner shell çš„ file descriptor å’Œç¼“å†²ç‰¹æ€§ï¼ˆæ²¡æœ‰ ttyï¼‰


2. stdout/stderr è¾“å‡ºè¢«é‡å®šå‘æˆ–è¢«åå° shell ç¼“å†²


3. å¯¼è‡´ nohup æˆ– & åå°è¿›ç¨‹çš„è¾“å‡ºä¸ç«‹å³åˆ·å…¥æ–‡ä»¶ï¼ˆæˆ–å†™å…¥ç¼“æ…¢ï¼‰



è¿™æ—¶ï¼Œå³ä¾¿ä½ åé¢ç”¨ tail -fï¼Œæ—¥å¿—æ–‡ä»¶æœ¬èº«å†™å…¥å°±ä¸æ˜¯â€œå®æ—¶çš„â€ï¼Œè‡ªç„¶ä½ å°±çœ‹ä¸åˆ°å®æ—¶è¾“å‡ºã€‚


---

âœ… éªŒè¯æ–¹æ³•

ä½ å¯ä»¥è®© pipeline å¯åŠ¨ Java çš„æ—¶å€™ï¼š

ssh user@host 'nohup java -jar app.jar > /tmp/app.log 2>&1 &'

ç„¶åç«‹åˆ»ç™»å½•ç›®æ ‡æœºå™¨è¿è¡Œï¼š

tail -f /tmp/app.log

ä½ ä¼šå‘ç°æ—¥å¿—ä¹Ÿä¸ä¼šé©¬ä¸Šå‡ºç°ï¼Œè€Œæ˜¯è¿‡å‡ ç§’æˆ–ç­‰ç¼“å†²åˆ·æ–°ã€‚


---

âœ… æ ¹æ²»æ–¹æ¡ˆ

âœ… æ–¹æ¡ˆ 1ï¼šé¿å… Java è¾“å‡ºè¢«ç¼“å†²æˆ–é”å®š

ä½ å¯ä»¥å°è¯•ï¼š

ssh user@host 'stdbuf -oL -eL nohup java -jar app.jar > /tmp/app.log 2>&1 &'

è¿™ç¡®ä¿ java æ ‡å‡†è¾“å‡ºæ˜¯ line-bufferedï¼ˆè€Œä¸æ˜¯ block bufferï¼‰


---

âœ… æ–¹æ¡ˆ 2ï¼šåœ¨è¿œç¨‹æœºå™¨ç”¨ shell è„šæœ¬å¯åŠ¨ Javaï¼Œæ›´ç¨³å®š

æŠŠ Java å¯åŠ¨é€»è¾‘å†™è¿›è¿œç¨‹æœºå™¨çš„è„šæœ¬ä¸­ï¼Œæ¯”å¦‚ /opt/start_java.shï¼š

#!/bin/bash
export JAVA_HOME=/usr/lib/jvm/java-11-openjdk
cd /opt/myapp
stdbuf -oL -eL nohup java -jar app.jar > /tmp/app.log 2>&1 &

ç„¶åä½ åœ¨ pipeline ä¸­åªåšï¼š

ssh user@host '/opt/start_java.sh'

è¿™æ ·è¿œç¨‹æ‰§è¡Œæ›´â€œå¹²å‡€â€ï¼Œè¾“å‡ºä¹Ÿæ›´å¯æ§ã€‚


---

âœ… æ–¹æ¡ˆ 3ï¼šåŠ ç­‰å¾…é€»è¾‘ï¼Œç¡®ä¿æ—¥å¿—å†™å…¥

åœ¨ tail ä¹‹å‰ sleep ç­‰å‡ ç§’ï¼Œæˆ–è€… poll æ–‡ä»¶å¤§å°å˜åŒ–ï¼Œä¾‹å¦‚ï¼š

wait_log_file_ready() {
  ssh user@host '
    while [ ! -s /tmp/app.log ]; do
      sleep 1
    done
  '
}


---

âœ… æœ€ç»ˆæ¨èé€»è¾‘ï¼ˆremote_java.shï¼‰

start_java() {
  echo "å¯åŠ¨ Java åº”ç”¨ï¼š$1"
  sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no "$SSH_USER@$1" '
    stdbuf -oL -eL nohup java -jar /opt/myapp/app.jar > /tmp/myapp.log 2>&1 &
  '
}

tail_log() {
  echo "Tail å®æ—¶æ—¥å¿—ï¼š$1"
  sshpass -p "$SSH_PASS" ssh -tt "$SSH_USER@$1" '
    while [ ! -s /tmp/myapp.log ]; do sleep 1; done
    stdbuf -oL -eL tail -n 10 -F /tmp/myapp.log
  '
}

run_and_tail() {
  host=$1
  start_java "$host"
  sleep 2
  tail_log "$host"
}


---

ğŸ§  ä¸ºä»€ä¹ˆâ€œæ‰‹åŠ¨è¿è¡Œ Javaâ€æ²¡é—®é¢˜ï¼Ÿ

æ‰‹åŠ¨å¯åŠ¨çš„ Java è¿›ç¨‹æ˜¯åœ¨æ­£å¸¸äº¤äº’ shellï¼ˆttyï¼‰é‡Œè¿è¡Œï¼Œstdout è¡Œç¼“å†²ä¸ä¼šè¢«é”æ­»ã€Java ä¹Ÿä¸æ˜¯è¢« nohup å½±å“çš„åå°è¿›ç¨‹ï¼Œè‡ªç„¶æ—¥å¿—èƒ½å®æ—¶å†™å…¥å¹¶ tail åˆ°ã€‚

è€Œ GitLab Runner çš„ shell ç¯å¢ƒæ˜¯éäº¤äº’å¼çš„ï¼Œæ‰€ä»¥ Java çš„ stdout è¢«ç¼“å†²äº†ã€‚


---

âœ… æ€»ç»“

é—®é¢˜	åŸå› 	è§£å†³æ–¹æ¡ˆ

æ—¥å¿—ä¸èƒ½å®æ—¶è¾“å‡º	Java åå°è¾“å‡ºè¢«ç¼“å†²	ä½¿ç”¨ stdbuf å¼ºåˆ¶ line-buffering
pipeline å¯åŠ¨çš„ Java å»¶è¿Ÿæ—¥å¿—å†™å…¥	éäº¤äº’ SSH ç¯å¢ƒ	ç”¨ shell è„šæœ¬å¯åŠ¨ã€æ›´ç¨³å®š
tail æ— è¾“å‡º	æ—¥å¿—æ–‡ä»¶å°šæœªåˆ›å»º	åŠ  sleep æˆ– -s æ£€æŸ¥



---

å¦‚æœä½ å‘Šè¯‰æˆ‘ Java å¯åŠ¨å‘½ä»¤å’Œéƒ¨ç½²ç¯å¢ƒï¼Œæˆ‘å¯ä»¥ç»™ä½ å…·ä½“é’ˆå¯¹ä½ é¡¹ç›®çš„ remote_java.sh å®Œæ•´ä¼˜åŒ–ç‰ˆï¼Œè¦ä¸è¦ï¼Ÿ

